diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/configure.in nautilus-2.26.2/configure.in
--- ../nautilus-2.26.2/configure.in	2009-04-15 16:04:23.786377257 +0200
+++ nautilus-2.26.2/configure.in	2009-04-15 16:04:45.671194224 +0200
@@ -291,6 +291,22 @@ if test "x$enable_beagle" != "xno"; then
         AC_SUBST(BEAGLE_CFLAGS)
 	AC_SUBST(BEAGLE_LIBS)
 fi
+dnl ==========================================================================
+
+dnl ********************
+dnl * Check for libzfs *
+dnl ********************
+ZFS_LIBS=
+msg_zfs=no
+AC_CHECK_LIB(zfs, zfs_iter_root,
+   [AC_CHECK_HEADER(libzfs.h,
+       [AC_DEFINE(HAVE_ZFS, 1, [Define to 1 if ZFS is available])
+        ZFS_LIBS="-lzfs"
+        msg_zfs=yes])
+     ])
+AC_SUBST(ZFS_LIBS)
+
+
 
 dnl ==========================================================================
 
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/icons/Makefile.am nautilus-2.26.2/icons/Makefile.am
--- ../nautilus-2.26.2/icons/Makefile.am	2009-04-15 16:04:23.703461917 +0200
+++ nautilus-2.26.2/icons/Makefile.am	2009-04-15 16:04:45.671669051 +0200
@@ -11,6 +11,10 @@ icon_DATA =\
 	erase.png \
 	knob.png \
 	thumbnail_frame.png \
+	restore.png \
+	restore-search.png \
+	restore-no.png \
+	camera.png \
 	$(NULL)
 
 EXTRA_DIST = $(icon_DATA)
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/libnautilus-private/Makefile.am nautilus-2.26.2/libnautilus-private/Makefile.am
--- ../nautilus-2.26.2/libnautilus-private/Makefile.am	2009-04-15 16:04:23.818552051 +0200
+++ nautilus-2.26.2/libnautilus-private/Makefile.am	2009-04-15 16:04:45.672559789 +0200
@@ -32,6 +32,7 @@ libnautilus_private_la_LIBADD =		\
 	$(top_builddir)/eel/libeel-2.la \
 	$(top_builddir)/libnautilus-extension/libnautilus-extension.la \
 	$(CORE_LIBS)			\
+	$(ZFS_LIBS)			\
 	$(NULL)
 
 marshal_sources = \
@@ -200,6 +201,8 @@ libnautilus_private_la_SOURCES = \
 	nautilus-window-info.h \
 	nautilus-window-slot-info.c \
 	nautilus-window-slot-info.h \
+	nautilus-zfs.c \
+	nautilus-zfs.h \	
 	$(NULL)
 
 BEAGLE_SOURCES = \
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/libnautilus-private/apps_nautilus_preferences.schemas.in nautilus-2.26.2/libnautilus-private/apps_nautilus_preferences.schemas.in
--- ../nautilus-2.26.2/libnautilus-private/apps_nautilus_preferences.schemas.in	2009-04-15 16:04:23.811067538 +0200
+++ nautilus-2.26.2/libnautilus-private/apps_nautilus_preferences.schemas.in	2009-04-15 16:04:45.673605198 +0200
@@ -5,6 +5,19 @@
          in nautilus-global-preferences.c -->
 
     <!-- General preferences -->
+      <schema>
+       <key>/schemas/apps/nautilus/preferences/enable_time_slider</key>
+       <applyto>/apps/nautilus/preferences/enable_time_slider</applyto>
+       <owner>nautilus</owner>
+       <type>bool</type>
+       <default>true</default>
+       <locale name="C">
+          <short>Enables the visualization of the ZFS snaphots timeline</short>
+          <long>
+            If set to true, the visualization of the ZFS snapshots timeline is enabled
+          </long>
+       </locale>
+     </schema>
 
     <schema>
       <key>/schemas/desktop/gnome/file_views/show_hidden_files</key>
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/libnautilus-private/nautilus-column-utilities.c nautilus-2.26.2/libnautilus-private/nautilus-column-utilities.c
--- ../nautilus-2.26.2/libnautilus-private/nautilus-column-utilities.c	2009-04-15 16:04:23.816494495 +0200
+++ nautilus-2.26.2/libnautilus-private/nautilus-column-utilities.c	2009-04-15 16:05:52.535297177 +0200
@@ -130,6 +130,15 @@ get_builtin_columns (void)
 					       /* TODO: Change after string freeze over */
 					       "description", _("Location"),
 					       NULL));
+ 	columns = g_list_append (columns,
+ 				 g_object_new (NAUTILUS_TYPE_COLUMN,
+ 					       "name", "restore_info",
+ 					       "attribute", "restore_info",
+ 					       /* SUN_BRANDING */
+ 					       "label", _("Restore information"),
+ 					       /* SUN_BRANDING */
+ 					       "description", _("Restore information of the file."),
+ 					       NULL));
 
 	return columns;
 }
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/libnautilus-private/nautilus-directory-async.c nautilus-2.26.2/libnautilus-private/nautilus-directory-async.c
--- ../nautilus-2.26.2/libnautilus-private/nautilus-directory-async.c	2009-04-15 16:04:23.801415529 +0200
+++ nautilus-2.26.2/libnautilus-private/nautilus-directory-async.c	2009-04-15 16:04:45.677777707 +0200
@@ -618,6 +618,7 @@ remove_monitor_link (NautilusDirectory *
 		g_list_free_1 (link);
 	}
 }
+	
 
 static void
 remove_monitor (NautilusDirectory *directory,
@@ -686,6 +687,10 @@ nautilus_directory_set_up_request (Nauti
 		REQUEST_SET_TYPE (request, REQUEST_FILESYSTEM_INFO);
 	}
 
+	if (file_attributes & NAUTILUS_FILE_ATTRIBUTE_RESTORE_INFO) {
+		REQUEST_SET_TYPE (request, REQUEST_RESTORE_INFO);
+	}
+
 	return request;
 }
 
@@ -4784,6 +4789,18 @@ cancel_link_info_for_file (NautilusDirec
 	}
 }
 
+void nautilus_directory_cancel_restore_info (NautilusDirectory *directory)
+{
+  if (NAUTILUS_IS_DIRECTORY (directory))
+    {
+      if (directory->details->restore_cancel)
+	{
+	  g_cancellable_cancel (directory->details->restore_cancel);
+	  directory->details->restore_cancel = NULL;
+	}
+    }
+}
+
 
 static void
 cancel_loading_attributes (NautilusDirectory *directory,
@@ -4826,6 +4843,10 @@ cancel_loading_attributes (NautilusDirec
 	if (REQUEST_WANTS_TYPE (request, REQUEST_MOUNT)) {
 		mount_cancel (directory);
 	}
+
+	if (REQUEST_WANTS_TYPE (request, REQUEST_RESTORE_INFO)) {
+	    nautilus_directory_cancel_restore_info (directory);
+	}
 	
 	/* FIXME bugzilla.gnome.org 45064: implement cancelling metadata when we
 	   implement invalidating metadata */
@@ -4871,6 +4892,9 @@ nautilus_directory_cancel_loading_file_a
 	if (REQUEST_WANTS_TYPE (request, REQUEST_MOUNT)) {
 		cancel_mount_for_file (directory, file);
 	}
+	if (REQUEST_WANTS_TYPE (request, REQUEST_RESTORE_INFO)) {
+	    nautilus_directory_cancel_restore_info (directory);
+	}
 
 	/* FIXME bugzilla.gnome.org 45064: implement cancelling metadata when we
 	   implement invalidating metadata */
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/libnautilus-private/nautilus-directory-private.h nautilus-2.26.2/libnautilus-private/nautilus-directory-private.h
--- ../nautilus-2.26.2/libnautilus-private/nautilus-directory-private.h	2009-04-15 16:04:23.799692328 +0200
+++ nautilus-2.26.2/libnautilus-private/nautilus-directory-private.h	2009-04-15 16:06:59.714531306 +0200
@@ -60,6 +60,7 @@ typedef enum {
 	REQUEST_THUMBNAIL,
 	REQUEST_MOUNT,
 	REQUEST_FILESYSTEM_INFO,
+	REQUEST_RESTORE_INFO,
 	REQUEST_TYPE_LAST
 } RequestType;
 
@@ -146,6 +147,9 @@ struct NautilusDirectoryDetails
 
 	guint64 free_space; /* (guint)-1 for unknown */
 	time_t free_space_read; /* The time free_space was updated, or 0 for never */
+	GCancellable *restore_cancel;
+	/* zfs snapshot info */
+ 	GList *zfs_snapshots;
 };
 
 NautilusDirectory *nautilus_directory_get_existing                    (GFile                     *location);
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/libnautilus-private/nautilus-directory.c nautilus-2.26.2/libnautilus-private/nautilus-directory.c
--- ../nautilus-2.26.2/libnautilus-private/nautilus-directory.c	2009-04-15 16:04:23.809804390 +0200
+++ nautilus-2.26.2/libnautilus-private/nautilus-directory.c	2009-04-15 16:07:42.868117733 +0200
@@ -38,6 +38,7 @@
 #include "nautilus-metafile.h"
 #include "nautilus-desktop-directory.h"
 #include "nautilus-vfs-directory.h"
+#include "nautilus-zfs.h"
 #include <eel/eel-glib-extensions.h>
 #include <eel/eel-gtk-macros.h>
 #include <eel/eel-string.h>
@@ -141,6 +142,8 @@ nautilus_directory_init (gpointer object
 	directory->details->extension_queue = nautilus_file_queue_new ();
 	directory->details->idle_queue = nautilus_idle_queue_new ();
 	directory->details->free_space = (guint64)-1;
+ 	directory->details->zfs_snapshots = NULL;
+ 	directory->details->restore_cancel = NULL;
 }
 
 NautilusDirectory *
@@ -216,7 +219,13 @@ nautilus_directory_finalize (GObject *ob
 	if (directory->details->hidden_file_hash) {
 		g_hash_table_destroy (directory->details->hidden_file_hash);
 	}
-	
+
+	if (directory->details->zfs_snapshots) {
+	        ts_free_snapshots (directory->details->zfs_snapshots);
+	}
+	if (directory->details->restore_cancel)
+	  g_cancellable_cancel (directory->details->restore_cancel);
+
 	nautilus_file_queue_destroy (directory->details->high_priority_queue);
 	nautilus_file_queue_destroy (directory->details->low_priority_queue);
 	nautilus_file_queue_destroy (directory->details->extension_queue);
@@ -331,11 +340,27 @@ async_data_preference_changed_callback (
 	g_hash_table_foreach (directories, async_state_changed_one, NULL);
 }
 
+static gboolean time_slider_enabled = TRUE;
+
+gboolean
+is_time_slider_enabled ()
+{
+  return time_slider_enabled;
+}
+
+static void time_slider_pref_changed_callback ()
+{
+  time_slider_enabled = eel_preferences_get_boolean (NAUTILUS_PREFERENCES_ENABLE_TIME_SLIDER);
+}
+
+
 static void
 add_preferences_callbacks (void)
 {
 	nautilus_global_preferences_init ();
 
+	time_slider_enabled = eel_preferences_get_boolean (NAUTILUS_PREFERENCES_ENABLE_TIME_SLIDER);
+
 	eel_preferences_add_callback (NAUTILUS_PREFERENCES_SHOW_HIDDEN_FILES,
 				      filtering_changed_callback,
 				      NULL);
@@ -352,6 +377,9 @@ add_preferences_callbacks (void)
 	eel_preferences_add_callback (NAUTILUS_PREFERENCES_DATE_FORMAT,
 				      async_data_preference_changed_callback,
 				      NULL);
+	eel_preferences_add_callback (NAUTILUS_PREFERENCES_ENABLE_TIME_SLIDER,
+				      time_slider_pref_changed_callback,
+				      NULL);
 }
 
 /**
@@ -545,6 +573,7 @@ nautilus_directory_new (GFile *location)
 {
 	NautilusDirectory *directory;
 	char *uri;
+	char *path;
 
 	uri = g_file_get_uri (location);
 	
@@ -556,10 +585,13 @@ nautilus_directory_new (GFile *location)
 		directory = NAUTILUS_DIRECTORY (nautilus_search_directory_new_from_saved_search (uri));
 	} else {
 		directory = NAUTILUS_DIRECTORY (g_object_new (NAUTILUS_TYPE_VFS_DIRECTORY, NULL));
+		path = g_file_get_path (location);
+		g_free (path);
 	}
 
 	set_directory_location (directory, location);
 
+
 	g_free (uri);
 	
 	return directory;
@@ -578,6 +610,197 @@ nautilus_directory_is_local (NautilusDir
 	       g_file_is_native (directory->details->location);
 }
 
+typedef struct {
+  NautilusDirectory         *dir;
+  GCancellable	            *cancel;
+  TsReadyCallback	     callback;
+  gpointer		     callback_user_data;
+} QuerySnapshotsAsyncData;
+
+
+static void snapshot_list_ready_callback (GObject *source_object,
+					  GAsyncResult *res,
+					  gpointer user_data)
+{
+  GSimpleAsyncResult *simple = G_SIMPLE_ASYNC_RESULT (res);
+  QuerySnapshotsAsyncData *data = (QuerySnapshotsAsyncData*) user_data;
+
+  if (!g_cancellable_is_cancelled (data->cancel))
+    {
+      data->dir->details->zfs_snapshots = g_simple_async_result_get_op_res_gpointer (simple);
+    }
+
+  data->callback (data->dir, data->cancel, data->callback_user_data);
+}
+
+void
+nautilus_directory_get_snapshots_async (NautilusDirectory *directory, 
+					TsReadyCallback ready_callback, 
+					GCancellable *cancel, 
+					gpointer      callback_user_data)
+{
+	g_assert (NAUTILUS_IS_DIRECTORY (directory));
+	
+	if (directory->details->location == NULL) 
+	  return;
+
+	if (directory->details->zfs_snapshots) {
+	  ts_free_snapshots (directory->details->zfs_snapshots);
+	  directory->details->zfs_snapshots = NULL;
+	}
+	
+	if (is_time_slider_enabled ())
+	  {
+	    QuerySnapshotsAsyncData *data;
+	    data = g_new0 (QuerySnapshotsAsyncData,1);
+	    data->dir = directory;
+	    data->cancel = cancel;
+	    data->callback = ready_callback;
+	    data->callback_user_data = callback_user_data;
+
+	    ts_get_snapshots_for_dir_async (directory->details->location, 
+					    snapshot_list_ready_callback, 
+					    cancel,
+					    data);
+	  }
+}
+
+gboolean
+nautilus_directory_has_snapshots (NautilusDirectory *directory)
+{
+	g_assert (NAUTILUS_IS_DIRECTORY (directory));
+	
+	if (directory->details->zfs_snapshots)
+	  return TRUE;
+
+	return FALSE;
+}
+int
+nautilus_directory_get_num_snapshots (NautilusDirectory	*directory)
+{
+  g_assert (NAUTILUS_IS_DIRECTORY (directory));
+
+    if (directory->details->zfs_snapshots)
+      {
+	int i = 0;
+	GList *tmp;
+	for (tmp = directory->details->zfs_snapshots;tmp;tmp = tmp->next)
+	  i++;
+	return i;
+      }
+    return 0;
+}
+
+gboolean           
+nautilus_directory_is_in_snapshot (NautilusDirectory         *directory)
+{
+  char *directory_uri;
+  gboolean result = FALSE;
+
+  g_return_val_if_fail (NAUTILUS_IS_DIRECTORY (directory), FALSE);
+  
+  directory_uri = nautilus_directory_get_uri (directory);
+  
+  result = ts_is_in_snapshot (directory_uri);
+
+  g_free (directory_uri);
+
+  return result;
+}
+
+GList *
+nautilus_directory_get_snapshots (NautilusDirectory *directory)
+{
+  g_assert (NAUTILUS_IS_DIRECTORY (directory));
+
+  return directory->details->zfs_snapshots;
+}
+
+void  nautilus_directory_remove_snapshot (NautilusDirectory *directory,
+					  ZfsDataSet *snap)
+{
+  if (directory->details->zfs_snapshots)
+    {
+      directory->details->zfs_snapshots = g_list_remove (directory->details->zfs_snapshots, snap);
+      ts_free_zfs_dataset (snap);
+    }
+}
+/* return true if snapdir dir path is a dir or subdir of refdir */
+gboolean 
+nautilus_directory_is_a_snapshot_dir_of (NautilusDirectory *snapdir,
+					 NautilusDirectory *refdir)
+{
+
+   gboolean result = FALSE;   
+
+  if (nautilus_directory_is_in_snapshot (snapdir))
+    {
+      char snapdir_root_real_path [PATH_MAX+1];
+      char refdir_real_path [PATH_MAX+1];
+      NautilusDirectory *snapdir_root = nautilus_directory_get_snap_root (snapdir);
+      GFile *snapdir_root_file = nautilus_directory_get_location (snapdir_root);
+      GFile *refdir_file = nautilus_directory_get_location (refdir);
+      char* snapdir_root_path = g_file_get_path (snapdir_root_file);
+      char* refdir_path = g_file_get_path (refdir_file);
+      
+      if (realpath (snapdir_root_path, snapdir_root_real_path) && 
+	      realpath (refdir_path, refdir_real_path))
+	    {
+	      if (g_strrstr (snapdir_root_real_path,refdir_real_path))
+		result = TRUE;
+	    }
+
+	  g_free (snapdir_root_path);
+	  g_free (refdir_path);
+	  g_object_unref (snapdir_root_file);
+	  g_object_unref (refdir_file);
+	  g_object_unref (snapdir_root);
+    }
+
+  return result;
+}
+
+NautilusDirectory *nautilus_directory_get_snap_root (NautilusDirectory	  *directory)
+{
+  char *directory_uri, *snap_root;
+  char *zfs, *iter;
+  int count = 0;
+  NautilusDirectory *new_dir;
+
+  g_assert (NAUTILUS_IS_DIRECTORY (directory));
+  
+  directory_uri = nautilus_directory_get_uri (directory);
+
+  if (!nautilus_directory_is_in_snapshot (directory))
+    return directory;
+
+  /*remove .zfs/snapshot/blah/ */
+  zfs = g_strrstr (directory_uri, ".zfs/snapshot/");
+  iter = zfs;
+
+  if (iter)
+    {
+      iter += sizeof (".zfs/snapshot/");
+      while (*iter != '/' && *iter != '\0')
+	iter++;
+
+      if (*iter == '/')
+	iter++;
+      
+      *zfs = '\0';
+      snap_root = g_strdup_printf ("%s%s", directory_uri, iter);
+      
+      *zfs = 'a';
+      g_free (directory_uri);
+      new_dir = nautilus_directory_get_by_uri (snap_root);
+      g_free (snap_root);
+      return new_dir;
+    }
+  return directory;
+}
+
+
+
 gboolean
 nautilus_directory_is_in_trash (NautilusDirectory *directory)
 {
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/libnautilus-private/nautilus-directory.h nautilus-2.26.2/libnautilus-private/nautilus-directory.h
--- ../nautilus-2.26.2/libnautilus-private/nautilus-directory.h	2009-04-15 16:04:23.802721313 +0200
+++ nautilus-2.26.2/libnautilus-private/nautilus-directory.h	2009-04-15 16:04:45.682543082 +0200
@@ -28,6 +28,7 @@
 #include <gtk/gtk.h>
 #include <gio/gio.h>
 #include <libnautilus-private/nautilus-file-attributes.h>
+#include <libnautilus-private/nautilus-zfs.h>
 
 /* NautilusDirectory is a class that manages the model for a directory,
    real or virtual, for Nautilus, mainly the file-manager component. The directory is
@@ -218,6 +219,24 @@ gboolean           nautilus_directory_ar
 gboolean           nautilus_directory_is_local                 (NautilusDirectory         *directory);
 
 gboolean           nautilus_directory_is_in_trash              (NautilusDirectory         *directory);
+typedef void (*TsReadyCallback) (NautilusDirectory *directory,
+				 GCancellable	   *cancellable,
+				 gpointer           callback_data);
+
+void		   nautilus_directory_get_snapshots_async      (NautilusDirectory	  *directory, 
+								TsReadyCallback		   ready_callback, 
+								GCancellable		  *cancel, 
+								gpointer		   callback_user_data);
+gboolean           nautilus_directory_has_snapshots            (NautilusDirectory         *directory);
+gboolean           nautilus_directory_is_in_snapshot           (NautilusDirectory         *directory);
+int		   nautilus_directory_get_num_snapshots	       (NautilusDirectory	  *directory);
+GList *		   nautilus_directory_get_snapshots	       (NautilusDirectory	  *directory);
+void		   nautilus_directory_remove_snapshot	       (NautilusDirectory	  *directory,
+								ZfsDataSet		  *snap);
+NautilusDirectory *nautilus_directory_get_snap_root	       (NautilusDirectory	  *directory);
+gboolean	   nautilus_directory_is_a_snapshot_dir_of     (NautilusDirectory	  *snapdir,
+								NautilusDirectory	  *refdir);
+void		   nautilus_directory_cancel_restore_info      (NautilusDirectory	  *directory);
 
 /* Return false if directory contains anything besides a Nautilus metafile.
  * Only valid if directory is monitored. Used by the Trash monitor.
@@ -238,6 +257,7 @@ GList *            nautilus_directory_li
 gboolean           nautilus_directory_is_desktop_directory     (NautilusDirectory         *directory);
 
 gboolean           nautilus_directory_is_editable              (NautilusDirectory         *directory);
+gboolean	   is_time_slider_enabled ();
 
 
 #endif /* NAUTILUS_DIRECTORY_H */
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/libnautilus-private/nautilus-file-attributes.h nautilus-2.26.2/libnautilus-private/nautilus-file-attributes.h
--- ../nautilus-2.26.2/libnautilus-private/nautilus-file-attributes.h	2009-04-15 16:04:23.812234151 +0200
+++ nautilus-2.26.2/libnautilus-private/nautilus-file-attributes.h	2009-04-15 16:04:45.683015260 +0200
@@ -42,6 +42,7 @@ typedef enum {
 	NAUTILUS_FILE_ATTRIBUTE_THUMBNAIL = 1 << 9,
 	NAUTILUS_FILE_ATTRIBUTE_MOUNT = 1 << 10,
 	NAUTILUS_FILE_ATTRIBUTE_FILESYSTEM_INFO = 1 << 11,
+	NAUTILUS_FILE_ATTRIBUTE_RESTORE_INFO = 1 << 12,
 } NautilusFileAttributes;
 
 #endif /* NAUTILUS_FILE_ATTRIBUTES_H */
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/libnautilus-private/nautilus-file-private.h nautilus-2.26.2/libnautilus-private/nautilus-file-private.h
--- ../nautilus-2.26.2/libnautilus-private/nautilus-file-private.h	2009-04-15 16:04:23.815190214 +0200
+++ nautilus-2.26.2/libnautilus-private/nautilus-file-private.h	2009-04-15 16:04:45.684019915 +0200
@@ -144,6 +144,15 @@ struct NautilusFileDetails
 
 	/* Mount for mountpoint or the references GMount for a "mountable" */
 	GMount *mount;
+
+	/* time slider file difference information */
+
+	char *restore_info;
+
+        /* snapshot directory for versions */
+
+        char *snapshot_directory;
+        GCancellable *has_snapshot_cancel;
 	
 	/* boolean fields: bitfield to save space, since there can be
            many NautilusFile objects. */
@@ -192,6 +201,13 @@ struct NautilusFileDetails
 	
 	eel_boolean_bit is_thumbnailing               : 1;
 
+	eel_boolean_bit restore_info_is_up_to_date    : 1;
+	eel_boolean_bit restore_info_in_progress      : 1;
+
+        eel_boolean_bit has_snap_versions_is_up_to_date    : 1;
+	eel_boolean_bit has_snap_versions_in_progress      : 1;
+        eel_boolean_bit has_snap_versions                  : 1;
+
 	/* TRUE if the file is open in a spatial window */
 	eel_boolean_bit has_open_window               : 1;
 
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/libnautilus-private/nautilus-file.c nautilus-2.26.2/libnautilus-private/nautilus-file.c
--- ../nautilus-2.26.2/libnautilus-private/nautilus-file.c	2009-04-15 16:04:23.803593737 +0200
+++ nautilus-2.26.2/libnautilus-private/nautilus-file.c	2009-04-15 16:11:10.071833930 +0200
@@ -48,6 +48,7 @@
 #include "nautilus-vfs-file.h"
 #include "nautilus-saved-search-file.h"
 #include "nautilus-lockdown.h"
+#include "nautilus-zfs.h"
 #include <eel/eel-debug.h>
 #include <eel/eel-glib-extensions.h>
 #include <eel/eel-gtk-extensions.h>
@@ -142,7 +143,8 @@ static GQuark attribute_name_q,
 	attribute_where_q,
 	attribute_link_target_q,
 	attribute_volume_q,
-	attribute_free_space_q;
+	attribute_free_space_q,
+	attribute_restore_info_q;
 
 static void     nautilus_file_info_iface_init                (NautilusFileInfoIface *iface);
 static char *   nautilus_file_get_owner_as_string            (NautilusFile          *file,
@@ -152,6 +154,7 @@ static gboolean update_info_and_name    
 							      GFileInfo             *info);
 static const char * nautilus_file_peek_display_name (NautilusFile *file);
 static const char * nautilus_file_peek_display_name_collation_key (NautilusFile *file);
+static void invalidate_restore_info (NautilusFile *file);
 static void file_mount_unmounted (GMount *mount,  gpointer data);
 
 G_DEFINE_TYPE_WITH_CODE (NautilusFile, nautilus_file, G_TYPE_OBJECT,
@@ -337,6 +340,14 @@ nautilus_file_clear_info (NautilusFile *
 
 	eel_ref_str_unref (file->details->filesystem_id);
 	file->details->filesystem_id = NULL;
+	g_free (file->details->restore_info);
+	file->details->restore_info = NULL;
+	invalidate_restore_info (file);
+        g_free (file->details->snapshot_directory);
+	file->details->snapshot_directory = NULL;
+        file->details->has_snap_versions_in_progress = FALSE;
+        file->details->has_snap_versions_is_up_to_date = FALSE;
+        file->details->has_snap_versions = FALSE;
 }
 
 static NautilusFile *
@@ -654,6 +665,10 @@ finalize (GObject *object)
 	g_free (file->details->activation_uri);
 	g_free (file->details->compare_by_emblem_cache);
 
+ 	g_free (file->details->restore_info);
+         if (file->details->snapshot_directory)
+                 g_free (file->details->snapshot_directory);
+
 	if (file->details->thumbnail) {
 		g_object_unref (file->details->thumbnail);
 	}
@@ -5431,7 +5446,9 @@ nautilus_file_get_string_attribute_q (Na
 	if (attribute_q == attribute_free_space_q) {
 		return nautilus_file_get_volume_free_space (file);
 	}
-
+	if (attribute_q == attribute_restore_info_q) {
+		return nautilus_file_get_restore_info_async (file);
+	}
 	extension_attribute = NULL;
 	
 	if (file->details->pending_extension_attributes) {
@@ -6391,6 +6408,616 @@ nautilus_file_get_trash_original_file (N
 
 }
 
+gboolean                
+nautilus_file_is_in_snapshot (NautilusFile *file)
+{
+  char *file_uri = nautilus_file_get_uri (file);
+  gboolean result = ts_is_in_snapshot (file_uri);
+  g_free (file_uri);
+  return result;
+}
+
+static gboolean nautilus_file_in_snap_exist_in_current (NautilusFile *file, GCancellable *cancel)
+{
+  /* get path without /.zfs/snapshot/blah/ */
+  /* test is file exist */
+  char *file_uri = nautilus_file_get_uri (file);
+  char *file_uri_without_snap = NULL;
+  gboolean result = FALSE;
+
+  if (g_cancellable_is_cancelled (cancel))
+    {
+      g_free (file_uri);
+      return FALSE;
+    }
+
+  file_uri_without_snap = ts_remove_snapshot_dir (file_uri);
+
+  if (file_uri_without_snap)
+    {
+      GFile* root_file = g_file_new_for_uri (file_uri_without_snap);
+      char *path = g_file_get_path (root_file);
+	  
+      if (path)
+	{
+	  result =  g_file_test (path, G_FILE_TEST_EXISTS);
+	  g_free (path);
+	}
+      g_object_unref (root_file);
+      g_free (file_uri_without_snap);
+
+    }
+  
+  g_free (file_uri);
+
+  return result;
+}
+
+
+char * nautilus_file_in_snapshot_get_info (NautilusFile *file, GCancellable *cancel)
+{
+  char *info = NULL;
+  GFile *then_gfile = nautilus_file_get_location (file);
+  char *then_path = g_file_get_path (then_gfile);
+  g_object_unref (then_gfile);
+
+  if (g_cancellable_is_cancelled (cancel))
+    {
+      g_free (then_gfile);
+      g_free (then_path);
+      return g_strdup ("cancelled");
+    }
+  if (then_path)
+    {
+      struct stat64 now;
+      struct stat64 then;
+      char *now_path = ts_remove_snapshot_dir (then_path);
+
+      if (lstat64 (now_path, &now) == 0)
+	{
+	  if (lstat64 (then_path, &then) == 0)
+	    {
+
+	      if (now.st_mtime != then.st_mtime)
+		{
+		  if (now.st_size == then.st_size)
+		    /* SUN_BRANDING */
+		    info = g_strdup (_("different date, same size as latest version"));
+		  else if (now.st_size > then.st_size)
+		    /* SUN_BRANDING */
+		    info = g_strdup (_("different date, smaller than latest version"));
+		  else if ( now.st_size < then.st_size)
+		    /* SUN_BRANDING */
+		    info = g_strdup (_("different date, bigger than latest version"));
+		}
+	      else
+		/* SUN_BRANDING */
+		info = g_strdup (_("identical to latest version"));
+	    }
+	  else
+	    info = g_strdup_printf ("FIXME no then %s", then_path);
+	}
+      else
+	/* SUN_BRANDING */
+	info = g_strdup (_("not present in latest version"));
+
+      g_free (now_path);
+      g_free (then_path);
+    }
+
+  return info;
+}
+
+static char * restore_string (char *str, GCancellable *cancel)
+{
+  if (g_cancellable_is_cancelled (cancel))
+    {
+      g_free (str);
+      return g_strdup (_("unknown"));
+    }
+  else
+    return str;
+}
+
+gint time_cmp (time_t *a,
+	       time_t *b)
+{
+  if (*a == *b)
+    return 0;
+  if (*a > *b)
+    return 1;
+  if (*a < *b)
+    return -1;
+
+}
+
+char *			
+nautilus_file_get_num_snapshot_version (NautilusFile *file, 
+                                        GCancellable *cancel,
+                                        gboolean stop_at_first)
+{
+  GList *tmp = NULL;
+  GList *tmp2 = NULL;
+  GList *time = NULL;
+  time_t* now_time = NULL;
+  char *result = NULL;
+  int version = 0;
+  NautilusFile *parent = NULL;
+  NautilusDirectory *dir = NULL;
+  char *snapdir = NULL;
+
+  if (NAUTILUS_IS_FILE (file))
+    {
+      parent = nautilus_file_get_parent (file);
+      if (parent)
+	{
+	  dir = nautilus_directory_get_for_file (parent);
+	  g_object_unref (parent);
+	}
+    }
+  if (dir)
+    {
+      struct stat64 now;
+      struct stat64 then;
+      char snap_name[PATH_MAX+1];
+      char *name = nautilus_file_get_name (file);
+      
+      g_object_ref (dir);
+      tmp = nautilus_directory_get_snapshots (dir);
+      
+      GFile *now_gfile = nautilus_file_get_location (file);
+      char *now_path = g_file_get_path (now_gfile);
+      g_object_unref (now_gfile);
+
+      if (now_path)
+	{
+	  if (lstat64 (now_path, &now) != 0)
+	    {
+	      g_free (now_path);
+	      g_object_unref (dir);
+	      return NULL;
+	    }
+	}
+      
+      g_free (now_path);
+
+      time = NULL;
+
+      /* get list of mtime for all files in snapshots */
+
+      now_time = g_new0 (time_t, 1);
+      *now_time = now.st_mtim.tv_sec;
+      time = g_list_prepend (time, now_time);
+
+
+      for (tmp; tmp; tmp = tmp->next)
+	{
+	  g_sprintf (snap_name, "%s/%s", 
+		     ((ZfsDataSet *) tmp->data)->mountpoint, 
+		     name);
+	  if (g_cancellable_is_cancelled (cancel))
+	    goto cancel;
+	  if (lstat64 (snap_name, &then) == 0)
+	    {
+	      if (g_list_find_custom (time, &then.st_mtim.tv_sec, (GCompareFunc) time_cmp) == NULL)
+		{ /*insert in list only is unique */
+		  time_t* snap_time = g_new0 (time_t, 1);
+		  *snap_time = then.st_mtim.tv_sec;
+		  time = g_list_prepend (time, snap_time);
+                  if (stop_at_first)
+                    {
+                      snapdir = g_strdup (((ZfsDataSet *) tmp->data)->mountpoint);
+                      goto cancel;
+                    }
+		}
+	    }
+
+	}
+cancel:
+      g_free (name);
+      g_object_unref (dir);
+    }
+
+
+  for (tmp = time; tmp; tmp = tmp->next)
+    {
+      g_free ((time_t*) tmp->data);
+      version++;
+    }
+
+  /* remove current version */
+  version--;
+
+  g_list_free (time);
+
+  if (version == 0)
+    {
+      if (stop_at_first)
+        return NULL;
+      else /*SUN_BRANDING*/
+        return restore_string (g_strdup_printf (_("no other version")), cancel);
+    }
+
+  if (stop_at_first)
+    return snapdir;
+  else
+    return restore_string (g_strdup_printf ("%d %s", version,
+                                            /* SUN_BRANDING */
+                                            version > 1 ? _("other versions") : /* SUN_BRANDING */ _("other version")),
+                           cancel);
+}
+
+static gboolean worker_thread_started = FALSE;
+
+typedef void (*ReadyCallback) (gpointer		  data,
+			       GCancellable      *cancellable);
+typedef void (*WorkerFunction) (gpointer		  data,
+			       GCancellable      *cancellable);
+typedef struct {
+  gpointer	    data;
+  gpointer	    return_data;
+  ReadyCallback	    ready_callback;
+  WorkerFunction    worker_func;
+  GCancellable	    *cancellable;
+} QueryData;
+
+static void 		
+nautilus_file_get_restore_info (gpointer data,
+				GCancellable       *cancellable)
+{
+  QueryData *qdata = (QueryData*) data;
+  NautilusFile *file = NAUTILUS_FILE (qdata->data);
+  char *result = NULL;
+
+  /*{
+    struct timespec ts;
+    ts.tv_sec = 1;
+    ts.tv_nsec = 0;
+    nanosleep (&ts, NULL);
+  }
+
+    {
+      GFile *f = nautilus_file_get_location (file);
+      char *path = g_file_get_uri (f);
+      printf ("start restore info for %s", path);
+      g_free (path);
+      g_object_unref (f);
+    }*/
+  if (!g_cancellable_is_cancelled (cancellable))
+    {
+
+      if (nautilus_file_is_directory (file))
+	{
+	  NautilusDirectory *dir = nautilus_directory_get_for_file (file);
+	  g_object_ref (dir);
+	  if (nautilus_directory_is_in_snapshot (dir))
+	    {
+	      if (!nautilus_file_in_snap_exist_in_current (file, cancellable))
+		/* SUN_BRANDING */
+		result = g_strdup (_("not present in latest version"));
+	      else
+		/* SUN_BRANDING */
+		result = g_strdup (_("present in latest version"));
+	    }
+	  else
+	    {
+	      int version = nautilus_directory_get_num_snapshots (dir);
+
+	      if (version == 0)
+		/* SUN_BRANDING */
+		result = g_strdup (_("no version"));
+	      else
+		result = g_strdup_printf ("%d %s",version,
+					  /* SUN_BRANDING */
+					  version > 1 ? _("versions") : /* SUN_BRANDING */ _("version"));
+	    }
+	  g_object_unref (dir);
+	}
+      else
+	{
+	  if (nautilus_file_is_in_snapshot (file))
+	      result = nautilus_file_in_snapshot_get_info (file, cancellable);
+	  else
+	      result = nautilus_file_get_num_snapshot_version (file, cancellable, FALSE);
+	}
+    }
+
+/*    {
+      printf ("is %s\n", result);
+    }*/
+
+
+  qdata->return_data = restore_string (result, cancellable);
+}
+
+
+static void restore_information_ready_callback (gpointer data,
+						GCancellable *cancellable)
+{
+  QueryData *qdata = (QueryData*) data;
+  NautilusFile *file = (NautilusFile*) qdata->data;
+  char *return_data = qdata->return_data;
+
+  if (!NAUTILUS_IS_FILE (file))
+    return;
+
+  file->details->restore_info_in_progress = FALSE;
+
+  if (g_cancellable_is_cancelled (cancellable))
+    {
+      file->details->restore_info = g_strdup (_("unknown"));
+      invalidate_restore_info (file);
+      if (return_data)
+	g_free (return_data);
+    }
+  else
+    {
+      file->details->restore_info_is_up_to_date = TRUE;
+      file->details->restore_info = return_data;
+    }
+
+  nautilus_file_changed (file);
+  nautilus_file_unref (file);
+}
+
+
+static gboolean
+complete_in_idle_cb (gpointer data)
+{
+  QueryData *qdata = (QueryData*)data;
+  qdata->ready_callback (data, qdata->cancellable);
+  g_free (qdata);
+  return FALSE;
+}
+
+static void
+worker_queue_finished_callback (GObject *source_object,
+				GAsyncResult *res,
+				gpointer user_data)
+{
+  GSimpleAsyncResult *simple = G_SIMPLE_ASYNC_RESULT (res);
+  GCancellable *cancel = (GCancellable*) user_data;
+
+  worker_thread_started = FALSE;
+
+  if (g_cancellable_is_cancelled (cancel))
+    {
+      return;
+    }
+
+  g_simple_async_result_get_op_res_gpointer (simple);
+
+}
+
+static void
+worker_queue_func (GSimpleAsyncResult *res,
+		   GObject            *object,
+		   GCancellable       *cancellable)
+{
+  QueryData *data = NULL;
+
+  GTimeVal timeout;
+  GAsyncQueue *queue = (GAsyncQueue*) g_simple_async_result_get_op_res_gpointer (res);
+  g_async_queue_ref (queue);
+
+  g_get_current_time (&timeout);
+  g_time_val_add (&timeout, 3000000);
+
+  data = g_async_queue_timed_pop (queue, &timeout);
+
+  while (data)
+    {
+      GSource *source;
+
+      /* only call the worker fct if not cancel 
+       * but execute ready function anyway */
+      if (!g_cancellable_is_cancelled (data->cancellable))
+	data->worker_func (data, data->cancellable);
+
+      /*call ready callback in main loop/thread */
+      source = g_idle_source_new ();
+      g_source_set_priority (source, G_PRIORITY_DEFAULT);
+      g_source_set_callback (source, complete_in_idle_cb, data, NULL);
+      g_source_attach (source, NULL);
+      g_source_unref (source);
+
+      /* pop next one */
+      g_get_current_time (&timeout);
+      g_time_val_add (&timeout, 3000000);
+      data = g_async_queue_timed_pop (queue, &timeout);
+    }
+
+  g_async_queue_unref (queue);
+}
+
+char * nautilus_file_get_restore_info_async (NautilusFile *file)
+{
+  if (!is_time_slider_enabled ())
+    return NULL;
+
+  if (!ts_is_restore_column_enabled ())
+    return NULL;
+
+  if (file->details->restore_info_is_up_to_date)
+    {
+      /*if ( file->details->restore_info == NULL)
+	return g_strdup ("null cached info");*/
+      return g_strdup (file->details->restore_info);
+    }
+
+  if (file->details->restore_info_in_progress)
+    return g_strdup ("...");
+  else
+    {
+      static GAsyncQueue *queue = NULL;
+      QueryData *data  = NULL;
+
+      if (!file->details->directory)
+	return g_strdup ("no directory element\n");
+
+      if (!nautilus_directory_has_snapshots (file->details->directory) && !nautilus_file_is_in_snapshot (file))
+	return g_strdup ("doesn't have snap nor is in snap\n");
+
+      if (!file->details->directory->details->restore_cancel)
+	{
+	  file->details->directory->details->restore_cancel = g_cancellable_new ();
+	}
+      else
+	{
+	  if (g_cancellable_is_cancelled (file->details->directory->details->restore_cancel))
+	    return NULL;
+	}
+
+      g_free (file->details->restore_info);
+      file->details->restore_info = NULL;
+      file->details->restore_info_in_progress = TRUE;
+
+      if (!queue)
+	queue = g_async_queue_new ();
+
+      data = g_new0 (QueryData, 1);
+      data->data = file;
+      nautilus_file_ref (file);
+      data->cancellable = file->details->directory->details->restore_cancel;
+      data->ready_callback = restore_information_ready_callback;
+      data->worker_func = nautilus_file_get_restore_info;
+
+      g_async_queue_push (queue, data);
+
+      if (!worker_thread_started)
+	{
+	  GSimpleAsyncResult *res;
+	  worker_thread_started = TRUE;
+
+	  res = g_simple_async_result_new (G_OBJECT (file), 
+					   worker_queue_finished_callback, 
+					   NULL, 
+					   (gpointer) worker_queue_func);
+
+	  g_simple_async_result_set_op_res_gpointer (res, queue, NULL);
+	  g_simple_async_result_run_in_thread (res, 
+					       worker_queue_func, 
+					       G_PRIORITY_DEFAULT, 
+					       data->cancellable);
+	}
+
+      return g_strdup ("...");
+    }
+}
+
+HasSnapshotResult
+nautilus_file_has_snapshot_version (NautilusFile *file)
+{
+    if (file->details->has_snap_versions_is_up_to_date)
+        return (file->details->has_snap_versions);
+    return UNKNOWN_STATE;
+}
+
+typedef struct {
+  NautilusFile              *file;
+  GCancellable              *cancel;
+  FileHasSnapshotCallback    callback;
+  gpointer		     callback_user_data;
+  char                      *snap_dir;
+} HasSnapshotAsyncData;
+
+typedef void (*HasSnapReadyCallback) (NautilusDirectory *file,
+                                      GCancellable	*cancel,
+                                      gpointer           callback_data);
+
+
+static void has_snapshot_ready_callback (GObject *source_object,
+                                         GAsyncResult *res,
+                                         gpointer user_data)
+{
+  GSimpleAsyncResult *simple = G_SIMPLE_ASYNC_RESULT (res);
+  HasSnapshotAsyncData *data = (HasSnapshotAsyncData*) user_data;
+
+  if (g_cancellable_is_cancelled (data->cancel))
+    {
+      data->file->details->has_snap_versions_in_progress = FALSE;
+      data->file->details->has_snap_versions_is_up_to_date = FALSE;
+      if (data->file->details->snapshot_directory)
+        g_free (data->file->details->snapshot_directory);
+      
+      data->file->details->has_snapshot_cancel = NULL;
+    }
+  else
+    {
+      data->file->details->has_snap_versions_in_progress = FALSE;
+      data->file->details->has_snap_versions_is_up_to_date = TRUE;
+      if (data->file->details->snapshot_directory)
+        g_free (data->file->details->snapshot_directory);
+      data->file->details->snapshot_directory = g_simple_async_result_get_op_res_gpointer (simple);
+      if (data->file->details->snapshot_directory)
+        data->file->details->has_snap_versions = TRUE;
+      else
+        data->file->details->has_snap_versions = FALSE;
+    }
+  data->callback (data->callback_user_data);
+}
+char *
+nautilus_file_get_snapshot_dir (NautilusFile *file)
+{
+  return file->details->snapshot_directory;
+}
+void nautilus_file_real_get_snapshot_version (GSimpleAsyncResult *res,
+            				      GObject            *object,
+        				      GCancellable       *cancellable)
+{
+  NautilusFile *file = NAUTILUS_FILE (object);
+  char *snap_info = nautilus_file_get_num_snapshot_version (file, cancellable, TRUE);
+
+  if (!snap_info) /* scan for .zfs directory*/
+    snap_info = ts_get_not_zfs_snapshot_dir (nautilus_file_get_location (file));
+/*
+  {
+    struct timespec ts;
+    ts.tv_sec = 4;
+    ts.tv_nsec = 0;
+    nanosleep (&ts, NULL);
+  }
+*/
+  if (snap_info)
+    g_simple_async_result_set_op_res_gpointer (res, snap_info, (GDestroyNotify) NULL);
+  else
+    g_simple_async_result_set_op_res_gpointer (res, NULL, (GDestroyNotify) NULL);
+}
+
+void nautilus_file_get_snapshot_version (NautilusFile *file,
+                                         FileHasSnapshotCallback callback,
+                                         GCancellable *cancel,
+                                         gpointer user_data)
+{
+    HasSnapshotAsyncData *data;
+    GSimpleAsyncResult *res;
+
+    if (file->details->has_snap_versions_in_progress)
+    {
+        g_cancellable_cancel(file->details->has_snapshot_cancel);
+        file->details->has_snapshot_cancel = NULL;
+        file->details->has_snap_versions_in_progress = FALSE;        
+    }
+
+    file->details->has_snapshot_cancel = cancel;
+    file->details->has_snap_versions_in_progress = TRUE;
+    file->details->has_snap_versions_is_up_to_date  = FALSE;
+
+    data = g_new0 (HasSnapshotAsyncData, 1);
+    data->file = file;
+    data->cancel = cancel;
+    data->callback = callback;
+    data->callback_user_data = user_data;
+
+    res = g_simple_async_result_new (G_OBJECT (file),
+                                     has_snapshot_ready_callback,
+                                     data,
+                                    (gpointer) nautilus_file_real_get_snapshot_version);
+    g_simple_async_result_run_in_thread (res, nautilus_file_real_get_snapshot_version,
+                                         G_PRIORITY_DEFAULT, cancel);
+}
+
+
 void
 nautilus_file_mark_gone (NautilusFile *file)
 {
@@ -6658,6 +7285,12 @@ invalidate_mount (NautilusFile *file)
 	file->details->mount_is_up_to_date = FALSE;
 }
 
+static void
+invalidate_restore_info (NautilusFile *file)
+{
+        file->details->restore_info_is_up_to_date = FALSE;
+}
+
 void
 nautilus_file_invalidate_extension_info_internal (NautilusFile *file)
 {
@@ -6712,6 +7345,9 @@ nautilus_file_invalidate_attributes_inte
 	if (REQUEST_WANTS_TYPE (request, REQUEST_THUMBNAIL)) {
 		invalidate_thumbnail (file);
 	}
+        if (REQUEST_WANTS_TYPE (request, REQUEST_RESTORE_INFO)) {
+                invalidate_restore_info (file);
+        }
 	if (REQUEST_WANTS_TYPE (request, REQUEST_MOUNT)) {
 		invalidate_mount (file);
 	}
@@ -6795,7 +7431,8 @@ nautilus_file_get_all_attributes (void)
 		NAUTILUS_FILE_ATTRIBUTE_LARGE_TOP_LEFT_TEXT |
 		NAUTILUS_FILE_ATTRIBUTE_EXTENSION_INFO |
 		NAUTILUS_FILE_ATTRIBUTE_THUMBNAIL |
-		NAUTILUS_FILE_ATTRIBUTE_MOUNT;
+		NAUTILUS_FILE_ATTRIBUTE_MOUNT | 
+		NAUTILUS_FILE_ATTRIBUTE_RESTORE_INFO ;
 }
 
 void
@@ -7284,6 +7921,7 @@ nautilus_file_class_init (NautilusFileCl
 	attribute_link_target_q = g_quark_from_static_string ("link_target");
 	attribute_volume_q = g_quark_from_static_string ("volume");
 	attribute_free_space_q = g_quark_from_static_string ("free_space");
+	attribute_restore_info_q = g_quark_from_static_string ("restore_info");
 	
 	G_OBJECT_CLASS (class)->finalize = finalize;
 	G_OBJECT_CLASS (class)->constructor = nautilus_file_constructor;
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/libnautilus-private/nautilus-file.h nautilus-2.26.2/libnautilus-private/nautilus-file.h
--- ../nautilus-2.26.2/libnautilus-private/nautilus-file.h	2009-04-15 16:04:23.818222702 +0200
+++ nautilus-2.26.2/libnautilus-private/nautilus-file.h	2009-04-15 16:04:45.684887503 +0200
@@ -174,6 +174,7 @@ gboolean                nautilus_file_is
 									 const char                     *mime_type);
 gboolean                nautilus_file_is_launchable                     (NautilusFile                   *file);
 gboolean                nautilus_file_is_symbolic_link                  (NautilusFile                   *file);
+gboolean                nautilus_file_is_in_snapshot			(NautilusFile                   *file);
 gboolean                nautilus_file_is_mountpoint                     (NautilusFile                   *file);
 GMount *                nautilus_file_get_mount                         (NautilusFile                   *file);
 char *                  nautilus_file_get_volume_free_space             (NautilusFile                   *file);
@@ -229,6 +230,26 @@ char *                  nautilus_file_ge
 
 NautilusFile *          nautilus_file_get_trash_original_file           (NautilusFile                   *file);
 
+char *			nautilus_file_get_num_snapshot_version		(NautilusFile			*file,
+									 GCancellable			*cancel,
+                                                                         gboolean                        stop_at_first);
+char *			nautilus_file_get_restore_info_async		(NautilusFile			*file);
+
+typedef enum {
+	NO,
+	YES,
+	UNKNOWN_STATE
+} HasSnapshotResult;
+
+HasSnapshotResult       nautilus_file_has_snapshot_version              (NautilusFile                   *file);
+char *                  nautilus_file_get_snapshot_dir                  (NautilusFile                   *file);
+typedef void (*FileHasSnapshotCallback)	(gpointer user_data);
+
+void                    nautilus_file_get_snapshot_version              (NautilusFile                   *file,
+                                                                         FileHasSnapshotCallback        callback,
+                                                                         GCancellable *cancel,
+                                                                         gpointer                       user_data);
+
 /* Permissions. */
 gboolean                nautilus_file_can_get_permissions               (NautilusFile                   *file);
 gboolean                nautilus_file_can_set_permissions               (NautilusFile                   *file);
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/libnautilus-private/nautilus-global-preferences.c nautilus-2.26.2/libnautilus-private/nautilus-global-preferences.c
--- ../nautilus-2.26.2/libnautilus-private/nautilus-global-preferences.c	2009-04-15 16:04:23.807198056 +0200
+++ nautilus-2.26.2/libnautilus-private/nautilus-global-preferences.c	2009-04-15 16:04:45.685853410 +0200
@@ -235,6 +235,10 @@ typedef struct
  * YOU SHOULD EDIT THE SCHEMAS FILE TO CHANGE DEFAULTS.
  */
 static const PreferenceDefault preference_defaults[] = {
+ 	{ NAUTILUS_PREFERENCES_ENABLE_TIME_SLIDER,
+ 	  PREFERENCE_BOOLEAN,
+ 	  GINT_TO_POINTER (TRUE)
+ 	},
 	{ NAUTILUS_PREFERENCES_SHOW_HIDDEN_FILES,
 	  PREFERENCE_BOOLEAN,
 	  GINT_TO_POINTER (FALSE)
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/libnautilus-private/nautilus-global-preferences.h nautilus-2.26.2/libnautilus-private/nautilus-global-preferences.h
--- ../nautilus-2.26.2/libnautilus-private/nautilus-global-preferences.h	2009-04-15 16:04:23.816890362 +0200
+++ nautilus-2.26.2/libnautilus-private/nautilus-global-preferences.h	2009-04-15 16:04:45.686381273 +0200
@@ -70,6 +70,7 @@ G_BEGIN_DECLS
 #define NAUTILUS_PREFERENCES_SHOW_BACKUP_FILES  		"/desktop/gnome/file_views/show_backup_files"
 #define NAUTILUS_PREFERENCES_SHOW_ADVANCED_PERMISSIONS		"preferences/show_advanced_permissions"
 #define NAUTILUS_PREFERENCES_DATE_FORMAT			"preferences/date_format"
+#define NAUTILUS_PREFERENCES_ENABLE_TIME_SLIDER			"preferences/enable_time_slider"
 
 typedef enum
 {
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/libnautilus-private/nautilus-zfs.c nautilus-2.26.2/libnautilus-private/nautilus-zfs.c
--- ../nautilus-2.26.2/libnautilus-private/nautilus-zfs.c	1970-01-01 01:00:00.000000000 +0100
+++ nautilus-2.26.2/libnautilus-private/nautilus-zfs.c	2009-04-15 16:04:45.687388998 +0200
@@ -0,0 +1,985 @@
+/* 
+ * Copyright (C) 2008 Sun Microsystems (Erwann Chenede)
+ *
+ */
+
+
+#include <stdio.h>
+#include <strings.h>
+#include <stdlib.h>
+#include <unistd.h>
+#include "nautilus-zfs.h"
+#include <time.h>
+#include <locale.h>
+#include <langinfo.h>
+#include <stdint.h>
+#include <glib.h>
+#include <glib/gi18n.h>
+#include <glib/gstdio.h>
+#include <eel/eel-glib-extensions.h>
+#include <sys/mnttab.h>
+#include <sys/mkdev.h>
+#include  "nautilus-global-preferences.h"
+#define ZFS_SNAPSHOT_DIR ".zfs/snapshot/"
+
+static void ts_set_snapshot_used_space (zfs_handle_t *zhp, ZfsDataSet *snap)
+{
+  gchar buf[ZFS_MAXNAMELEN];
+  if (zfs_prop_get(zhp, ZFS_PROP_USED, buf, sizeof (buf), NULL, NULL, 0, B_FALSE) == 0)
+    {
+      char unit[10];
+      char format_float[5] = "%f%s";
+      char format_int[5] = "%d%s";
+      char *format = format_int;
+      int   used_space_int = 0;
+      gboolean success = FALSE;
+
+      snap->used_space_str = g_strdup (buf);
+
+      if (strchr (buf, '.'))
+	{
+	  format = format_float;
+	  if (sscanf(buf, format,&snap->used_space,unit) == 2)
+	    success = TRUE;
+	}
+      else
+	{
+	  if (sscanf(buf, format,&used_space_int,unit) == 2)
+	    {
+	      success = TRUE;
+	      snap->used_space = (float) used_space_int;
+	    }
+	}
+      if (strcmp (buf, "0") == 0)
+	{
+	  g_free (snap->used_space_str);
+	  snap->used_space_str = g_strdup ("0 K");
+	  success = TRUE;
+	}
+
+      if (success)
+	{
+	  if (strcmp (unit, "M") == 0)
+	    snap->used_space *= 1024; 
+	  if (strcmp (unit, "G") == 0)
+	    snap->used_space *= 1024 * 1024; 
+	}
+      else
+	{
+	  g_free (snap->used_space_str);
+	  /* SUN_BRANDING */
+	  snap->used_space_str = g_strdup (_("Unknown"));
+	}
+    }
+  else
+    {
+      g_free (snap->used_space_str);
+      /* SUN_BRANDING */
+      snap->used_space_str = g_strdup (_("Unknown"));
+    }
+}
+
+static void ts_set_snapshot_mtime_and_time_diff (zfs_handle_t *zhp, ZfsDataSet *snap)
+{
+  GDate now;
+  GDate then;
+  time_t time_now;
+  gint days_diff;
+  const gchar *format;
+  gchar *locale_format = NULL;
+  gchar buf[ZFS_MAXNAMELEN];
+  gchar *date_str = NULL;
+
+  if (zfs_prop_get(zhp, ZFS_PROP_CREATION, buf, sizeof (buf), NULL, NULL, 0, B_TRUE) == 0)
+    {
+      struct tm tms;
+
+      sscanf (buf, "%llu", &snap->mtime);
+      memset(&tms, 0, sizeof(tms));
+      localtime_r (&snap->mtime, &tms);
+
+      g_date_set_time_t (&then, snap->mtime);
+
+      time_now = time (NULL);
+      g_date_set_time_t (&now, time_now);
+
+      days_diff = g_date_get_julian (&now) - g_date_get_julian (&then);
+
+      /* Translators: %H means "hours" and %M means "minutes" */
+      if (days_diff == 0)
+	/* SUN_BRANDING */
+	format = _("Today at %H:%M");
+      else if (days_diff == 1)
+	/* SUN_BRANDING */
+	format = _("Yesterday at %H:%M");
+      else
+	{
+	  if (days_diff > 1 && days_diff < 7)
+	    /* SUN_BRANDING */
+	    format = _("%A at %H:%M"); /* Days from last week */
+	  else
+	    {
+	      /* format = "%x";*/ /* Any other date */ /* SUN_BRANDING */
+	      format = _("%a %b %e %Y @ %Hh%M");
+	      /* SUN_BRANDING */
+	      /* date_str = g_strdup_printf (_("%d days ago"), days_diff); */
+	    }
+	}
+      if (format)
+	{
+	  locale_format = g_locale_from_utf8 (format, -1, NULL, NULL, NULL);
+	  if (locale_format != NULL &&
+	      strftime (buf, sizeof (buf), locale_format, &tms) != 0)
+	    {      
+	      date_str = g_locale_to_utf8 (buf, -1, NULL, NULL, NULL);
+	    }
+	}
+
+      if (date_str == NULL)
+	/* SUN_BRANDING */
+	date_str = g_strdup (_("Unknown"));
+
+      g_free (locale_format);
+      snap->mtime_str = date_str;
+    }
+
+}
+
+void print_snap_list (char *dir, GList *snap_list)
+{
+  GList *tmp;
+  printf ("list of snapshots for %s :\n", dir);
+  for (tmp = snap_list; tmp->next; tmp = tmp->next)
+    {
+      ZfsDataSet *snap = (ZfsDataSet*) tmp->data;
+      printf (" name: %s\n mountpoint: %s\n mtime_str :%s\n space used : %s\n size in kilobytes : %f\n",
+	      snap->name, snap->mountpoint, snap->mtime_str, snap->used_space_str, snap->used_space);
+
+    }
+  printf ("\n");
+}
+
+static GString *
+dump_zds (ZfsDataSet *zds)
+{
+  GString *msg;
+  gchar *type;
+
+  if (!zds)
+    return NULL;
+
+  msg = g_string_new ("");
+  g_string_printf (msg, 
+		   "\tname: %s\n"
+		   "\tmountpoint: %s\n"
+		   "\ttype: %s\n",
+		   zds->name,zds->mountpoint, zfs_type_to_name(zds->type));
+  if (zds->snapshots)
+    {
+      GList *tmp;
+      g_string_append_printf(msg,"\tsnapshots :\n");
+      for (tmp=zds->snapshots;tmp;tmp = tmp->next)
+	{ 
+	  ZfsDataSet *tmp_zds= (ZfsDataSet*) tmp->data;
+	  g_string_append_printf (msg,"\t\tname: %s\n\t\tpath: %s\n",
+				  tmp_zds->name,
+				  tmp_zds->mountpoint);
+	}
+    }
+  g_string_append_printf (msg, "\n");
+  return msg;
+}
+
+
+static void
+dump_sds (SearchDataSet *sds)
+{
+  GString *msg;
+  gchar *type;
+  GList *tmp;
+
+  if (!sds)
+    {
+      printf ("Search DataSet is empty\n");
+      return;
+    }
+
+  msg = g_string_new ("");
+  g_string_printf (msg, "DDS Dump:\n"
+		   "\tsearched_path: %s\n",
+		   sds->searched_path);
+
+  g_string_append_printf (msg, "Zfs Data set :\n");
+  for (tmp=sds->datasets;tmp;tmp=tmp->next)
+    {
+      GString * zds_dump = dump_zds ((ZfsDataSet *)tmp->data);
+      g_string_append_printf (msg,"%s",zds_dump->str); 
+      g_string_free (zds_dump, TRUE);
+    }
+  g_string_append_printf (msg, "\n");
+  printf ("%s", msg->str);
+  g_string_free (msg, TRUE);
+}
+
+static ZfsDataSet*
+ts_new_zfs_dataset (SearchDataSet* sds)
+{
+	ZfsDataSet *zds;
+	zds = g_new0 (ZfsDataSet, 1);
+	zds->search_dataset = sds;
+	return zds;
+}
+
+void
+ts_free_zfs_dataset (ZfsDataSet* zds)
+{
+	if (!zds)
+	  return;
+	if (zds->name)
+	  g_free (zds->name);
+	if (zds->mountpoint)
+	  g_free (zds->mountpoint);
+	if (zds->mtime_str)
+	  g_free (zds->mtime_str);
+	if (zds->used_space_str)
+	  g_free (zds->used_space_str);
+
+	if (zds->snapshots)
+	  {
+	    GList *tmp;
+	    for (tmp = zds->snapshots;tmp;tmp = tmp->next)
+	      ts_free_zfs_dataset ((ZfsDataSet*)tmp->data);
+	  }
+	g_free (zds);
+}
+
+static SearchDataSet *
+ts_new_search_dataset (GCancellable *cancel)
+{
+	SearchDataSet *sds;
+	sds = g_new0 (SearchDataSet, 1);
+	sds->cancel = cancel;
+	return sds;
+}
+static void
+ts_free_search_dataset (SearchDataSet *sds)
+{
+	if (!sds)
+	  return;
+	if (sds->searched_path)
+	  g_free (sds->searched_path);
+	if (sds->mountpoint)
+	  g_free (sds->mountpoint);
+	if (sds->datasets)
+	  {
+	    GList *tmp;
+	    for (tmp = sds->datasets;tmp;tmp = tmp->next)
+	      ts_free_zfs_dataset ((ZfsDataSet*)tmp->data);
+	  }
+	g_free (sds);
+}
+
+static char* construct_check_snapshot_path (SearchDataSet *sds, char* mountpoint, const char *name, char *searched_path)
+{
+  gchar *result = NULL;
+  gchar **split;
+  gchar **split2;
+
+  gchar *snap_name = NULL;
+  gchar *remaining_path = NULL;
+  
+  /* get the snapshot name part pool@snap-name we are only interested in snap-name split[1] */
+  split = g_strsplit (name,"@",2);
+  /* get the path after the mountpoint */
+  split2 = g_strsplit (searched_path, mountpoint, 2);
+
+  if (split && split[1])
+      snap_name = split[1];
+
+  if (split2 && split2[1])
+      remaining_path = split2[1];
+  
+/*  printf ("mountpoint : %s \nname : %s \nsearched_path: %s\n", mountpoint, name, searched_path);
+  printf ("split %s at @ = [%s] [%s]\n", name, split[0],split[1]); 
+  printf ("split %s at [%s] = [%s] [%s]\n", searched_path, mountpoint, split2[0],split2[1]); 
+  printf ("%s/.zfs/snapshot/%s/%s\n\n", mountpoint, split[1], split2[1]);*/
+
+  if (snap_name && remaining_path)
+    result = g_strdup_printf ("%s/.zfs/snapshot/%s/%s", mountpoint, snap_name, remaining_path);
+  
+  g_strfreev (split);
+  g_strfreev (split2);
+  
+  /* don't test for file presence if searched path is the same as the mount point */
+  if (sds->searched_path_match_mp)
+      return result;
+      
+  if (result && g_file_test (result, G_FILE_TEST_IS_DIR))
+      {
+	char real_dir[PATH_MAX+1]; 
+	if (!realpath(result, real_dir))
+	  {
+	    g_free (result);
+	    result = NULL;
+	  }
+	else
+	  {
+	    g_free (result);
+	    result = g_strdup (real_dir);
+	  }
+	return result;
+      }
+
+  g_free (result);
+  return NULL;
+}
+
+static int
+snapshot_callback (zfs_handle_t *zhp, void *data)
+{
+  ZfsDataSet *main_zds = (ZfsDataSet*) data;
+
+  /* only add snapshot dir that exist */
+
+  if (zfs_get_type (zhp) == ZFS_TYPE_SNAPSHOT && !g_cancellable_is_cancelled (main_zds->search_dataset->cancel)) 
+    {
+      const char* name = zfs_get_name (zhp);
+      char *snap_path = construct_check_snapshot_path (main_zds->search_dataset,
+						       main_zds->mountpoint, 
+						       name, 
+						       main_zds->search_dataset->searched_path);
+      if (snap_path)
+	{
+	  ZfsDataSet *zds = ts_new_zfs_dataset (main_zds->search_dataset);
+	  zds->name = g_strdup (name);
+	  zds->type = ZFS_TYPE_SNAPSHOT;
+	  zds->mountpoint = snap_path;
+	  ts_set_snapshot_mtime_and_time_diff (zhp, zds);
+	  ts_set_snapshot_used_space (zhp, zds);
+	  main_zds->snapshots = g_list_append (main_zds->snapshots,zds);
+	}
+    }
+  zfs_close (zhp);
+  return 0;
+}
+
+
+static struct mnttab *
+mygetmntent(FILE *f)
+{
+  static struct mnttab mt;
+  int status;
+
+  if ((status = getmntent(f, &mt)) == 0)
+    return (&mt);
+
+  return (NULL);
+}
+
+static char *
+is_fs_mounted (const char *fs_name)
+{
+  FILE		   *mnttab;
+  struct mnttab    *mntp;
+
+
+  mnttab = fopen (MNTTAB,"r");
+
+  while ((mntp = mygetmntent(mnttab)) != NULL) 
+    {
+      if (mntp->mnt_fstype == (char *)0 || strcmp(mntp->mnt_fstype, "zfs") != 0)
+	continue;
+      if (strcmp (mntp->mnt_special, fs_name) == 0)
+	{
+	  fclose (mnttab);
+	  return g_strdup (mntp->mnt_mountp);
+	}
+  }
+  fclose (mnttab);
+  return NULL;
+}
+
+static int
+zfs_callback (zfs_handle_t *zhp, void *data)
+{
+  char buf[ZFS_MAXPROPLEN];
+  SearchDataSet *sds = (SearchDataSet*) data;
+
+  if (sds->match_found)
+    {
+      zfs_close (zhp);
+      return 0;
+    }
+
+  if (zfs_get_type (zhp) & sds->type & !g_cancellable_is_cancelled (sds->cancel))
+    {
+/*      struct timespec ts;
+      ts.tv_sec = 3;
+      ts.tv_nsec = 100000000; 
+      nanosleep (&ts, NULL);*/
+
+      if (sds->prop >= ZFS_PROP_TYPE && sds->prop < ZFS_NUM_PROPS) 
+	{
+	  zfs_prop_get(zhp, sds->prop, buf, sizeof (buf), NULL, NULL,  0, TRUE);
+	  
+	  if (strcmp (sds->mountpoint, buf) == 0)
+	    {
+	      ZfsDataSet *zds = ts_new_zfs_dataset (sds);
+	      zds->type = zfs_get_type (zhp);
+	      zds->name = g_strdup (zfs_get_name(zhp));
+	      zds->mountpoint = g_strdup (buf);
+	      zfs_iter_snapshots (zhp, snapshot_callback, zds);
+	      sds->datasets = g_list_append (sds->datasets, zds);
+	      sds->match_found = TRUE;
+	    }
+	  else if (strcmp ("legacy", buf) == 0)
+	    { /* parse /etc/mnttab to get the mount point */
+	      char *mountp = is_fs_mounted (zfs_get_name(zhp));
+	      if (mountp)
+		{
+		  if (strcmp (sds->mountpoint, mountp) == 0)
+		    {
+		      ZfsDataSet *zds = ts_new_zfs_dataset (sds);
+		      zds->type = zfs_get_type (zhp);
+		      zds->name = g_strdup (zfs_get_name(zhp));
+		      zds->mountpoint = mountp;
+		      zfs_iter_snapshots (zhp, snapshot_callback, zds);
+		      sds->datasets = g_list_append (sds->datasets, zds);
+		      sds->match_found = TRUE;
+		    }
+		  else
+		    g_free (mountp);
+		}
+	    }
+	}
+      if (!sds->match_found)
+	zfs_iter_filesystems (zhp, zfs_callback, sds); 
+    }
+  zfs_close (zhp);
+  return 0;
+}
+
+static SearchDataSet *
+ts_get_data_from_mountpoint (const char* searched_path, const char *mountpoint, GCancellable *cancel)
+{
+  static libzfs_handle_t *zfs_handle = NULL;
+  SearchDataSet *sds;
+
+  sds = ts_new_search_dataset (cancel);
+
+  sds->prop = ZFS_PROP_MOUNTPOINT;
+  sds->type = ZFS_TYPE_FILESYSTEM;
+  sds->searched_path = g_strdup (searched_path);
+  sds->mountpoint = g_strdup (mountpoint);
+
+  if (strcmp (searched_path, mountpoint) == 0)
+    sds->searched_path_match_mp = TRUE;
+
+  if (!zfs_handle)
+    {
+      if ((zfs_handle = libzfs_init()) == NULL) {
+	g_warning ("internal error: failed to initialize ZFS library\n");
+	ts_free_search_dataset (sds);
+	return NULL;
+      }
+    }
+  zfs_iter_root (zfs_handle, zfs_callback, sds);
+
+  return sds;
+}
+static gint
+snap_sort_by_age (gconstpointer a,
+		  gconstpointer b)
+{
+  const ZfsDataSet *snap1 = a;
+  const ZfsDataSet *snap2 = b;
+
+  if (snap1->mtime == snap2->mtime)
+    return 0;
+  if (snap1->mtime < snap2->mtime)
+    return -1;
+  if (snap1->mtime > snap2->mtime)
+    return 1;
+
+}
+
+char* 
+ts_get_zfs_filesystem (char *dir)
+{
+  char real_dir[PATH_MAX+1]; 
+  char filesystem[PATH_MAX+1];
+  gboolean  found_fs= FALSE;
+  struct stat64 dir_stat64;
+
+  if (!realpath(dir, real_dir))
+    {
+      return NULL;
+    }
+    if (stat64 (real_dir, &dir_stat64) == 0)
+    { /* check is fs is zfs */
+      if (strcmp (dir_stat64.st_fstype, "zfs") == 0)
+	{
+	  FILE		    *fp;
+	  struct extmnttab   mtab;
+	  int		     status;
+
+	  /* get mount point */
+
+	  fp = fopen (MNTTAB,"r");
+
+	  resetmnttab(fp);
+	  while ((status = getextmntent(fp, &mtab, sizeof (struct extmnttab))) == 0) 
+	    {
+	      dev_t dev = NODEV;
+	      dev = makedev(mtab.mnt_major, mtab.mnt_minor);
+	      if (dev == dir_stat64.st_dev)
+		{
+		  strcpy (filesystem, mtab.mnt_special);
+		  found_fs = TRUE;
+		  break;
+		}
+	    }
+	  (void) fclose(fp);
+	}
+    }
+    if (found_fs)
+      return g_strdup(filesystem);
+
+    return NULL;
+}
+
+static char * get_zfs_mountpoint (char *dir)
+{
+  char real_dir[PATH_MAX+1]; 
+  char mountpoint[PATH_MAX+1];
+  gboolean  found_mount_point = FALSE;
+  struct stat64 dir_stat64;
+
+  if (!realpath(dir, real_dir))
+    {
+      return NULL;
+    }
+    if (stat64 (real_dir, &dir_stat64) == 0)
+    { /* check is fs is zfs */
+      if (strcmp (dir_stat64.st_fstype, "zfs") == 0)
+	{
+	  FILE		    *fp;
+	  struct extmnttab   mtab;
+	  int		     status;
+
+	  /* get mount point */
+
+	  fp = fopen (MNTTAB,"r");
+
+	  resetmnttab(fp);
+	  while ((status = getextmntent(fp, &mtab, sizeof (struct extmnttab))) == 0) 
+	    {
+	      dev_t dev = NODEV;
+	      dev = makedev(mtab.mnt_major, mtab.mnt_minor);
+	      if (dev == dir_stat64.st_dev)
+		{
+		  strcpy (mountpoint, mtab.mnt_mountp);
+		  found_mount_point = TRUE;
+		  break;
+		}
+	    }
+	  (void) fclose(fp);
+	}
+    }
+    if (found_mount_point)
+      return g_strdup(mountpoint);
+
+    return NULL;
+}
+
+
+char *ts_get_snapshot_dir (char *dir)
+{
+  char *zfs_dir = get_zfs_mountpoint (dir);
+  if (zfs_dir)
+    {
+      char *snapshot_dir = g_strdup_printf ("%s/.zfs/snapshot", zfs_dir);
+      g_free (zfs_dir);
+      return snapshot_dir;
+    }
+  else
+    return NULL;
+}
+
+
+
+static void ts_get_snapshots_for_dir (GSimpleAsyncResult *res,
+				      GObject            *object,
+				      GCancellable       *cancellable)
+{
+  char *mountpoint = NULL; 
+  char real_dir[PATH_MAX+1]; 
+  SearchDataSet *sds;
+  GList* snap_result = NULL;
+  GFile *file = G_FILE (object);
+  char *dir = g_file_get_path (file);
+
+  mountpoint = get_zfs_mountpoint (dir);
+  
+
+  if (!mountpoint)
+    {
+      g_simple_async_result_set_op_res_gpointer (res, snap_result, (GDestroyNotify) NULL);
+      g_free (dir);
+      return;
+    }
+
+  realpath(dir, real_dir);
+
+  sds = ts_get_data_from_mountpoint (real_dir, mountpoint, cancellable);
+
+  g_free (mountpoint);
+
+  if (g_cancellable_is_cancelled (cancellable))
+    {
+      /* printf ("ts_get_snapshots_for_dir %s cancelled\n", dir); */
+      if (sds)
+	{
+	  ts_free_search_dataset (sds);
+	  sds = NULL;
+	}
+    }
+
+  if (sds)
+    {
+      GList *tmp;
+      for (tmp=sds->datasets;tmp;tmp=tmp->next)
+	{
+	  ZfsDataSet *zds = (ZfsDataSet*) tmp->data;
+	  if (zds->snapshots)
+	    {
+	      snap_result = g_list_concat (snap_result, zds->snapshots);
+	      zds->snapshots = NULL;
+	    }
+	}
+      ts_free_search_dataset (sds);
+    }
+
+  if (snap_result) 
+    {
+      snap_result = g_list_sort (snap_result, (GCompareFunc)snap_sort_by_age);
+      /* print_snap_list (dir, snap_result);  */
+    }
+
+  g_free (dir);
+  g_simple_async_result_set_op_res_gpointer (res, snap_result, (GDestroyNotify) NULL);
+}
+
+
+GList *ts_get_snapshots_for_dir_async (GFile *file, 
+				       GAsyncReadyCallback result_ready, 
+				       GCancellable *cancel,
+				       gpointer  user_data)
+{
+   GSimpleAsyncResult *res;
+
+   res = g_simple_async_result_new (G_OBJECT (file), result_ready, user_data, (gpointer) ts_get_snapshots_for_dir);
+   g_simple_async_result_run_in_thread (res, ts_get_snapshots_for_dir, G_PRIORITY_DEFAULT, cancel);
+   return NULL;
+}
+
+
+void ts_free_snapshots (GList *snaps)
+{
+  if (snaps)
+    {
+      GList *tmp;
+      for (tmp=snaps;tmp;tmp=tmp->next)
+	ts_free_zfs_dataset ((ZfsDataSet*) tmp->data);
+      g_list_free (snaps);
+    }
+}
+
+gboolean ts_is_in_snapshot (char * str)
+{
+  if (str != NULL)
+    {
+      if (g_strrstr (str, ZFS_SNAPSHOT_DIR))
+	return TRUE;
+    }
+  return FALSE;
+}
+
+char* ts_remove_snapshot_dir (char *str)
+{
+  if (ts_is_in_snapshot (str))
+    {
+      char *snap_root;
+      char *zfs, *iter, point;
+      int count = 0;
+
+      /*remove .zfs/snapshot/blah/ */
+      zfs = g_strrstr (str, ZFS_SNAPSHOT_DIR);
+      iter = zfs;
+
+      if (iter)
+	{
+	  iter += sizeof (ZFS_SNAPSHOT_DIR);
+	  while (*iter != '/' && *iter != '\0')
+	    iter++;
+
+	  if (*iter == '/')
+	    iter++;
+
+	  point = *zfs;
+	  *zfs = '\0';
+	  snap_root = g_strdup_printf ("%s%s", str, iter);
+
+	  *zfs = point;
+	  return snap_root;
+	}
+    }
+  return NULL;
+}
+
+
+static gboolean restore_col_enabled = FALSE;
+
+gboolean 
+ts_is_restore_column_enabled ()
+{
+  return restore_col_enabled;
+}
+
+void ts_is_restore_column_enabled_init ();
+
+static void
+visible_columns_changed (gpointer callback_data)
+{
+  ts_is_restore_column_enabled_init ();
+}
+
+
+void ts_is_restore_column_enabled_init ()
+{
+  char **visible_columns;
+  static gboolean init = FALSE;
+  int i = 0;
+
+  if (!init)
+    {
+      eel_preferences_add_callback (NAUTILUS_PREFERENCES_LIST_VIEW_DEFAULT_VISIBLE_COLUMNS,
+				    visible_columns_changed, NULL);
+      init = TRUE;
+    }
+  
+  restore_col_enabled = FALSE;
+
+  visible_columns = eel_preferences_get_string_array (NAUTILUS_PREFERENCES_LIST_VIEW_DEFAULT_VISIBLE_COLUMNS);
+
+  while (visible_columns[i])
+    {
+      if (strcmp (visible_columns [i], "restore_info") == 0)
+	{
+	  restore_col_enabled = TRUE;
+	  break;
+	}
+      i++;
+    }
+  g_strfreev (visible_columns);
+}
+
+
+static GList * get_dir_entries (char *dir_path)
+{
+  const char *entry_name;
+  GDir *dir;
+  GList *dir_entries = NULL;
+  dir = g_dir_open (dir_path, 0, NULL);
+
+  while ((entry_name = g_dir_read_name (dir)) != NULL)
+    dir_entries = g_list_prepend (dir_entries, g_strdup (entry_name));
+
+  g_dir_close (dir);
+
+  return dir_entries;
+}
+
+static void free_dir_entries (GList *entries)
+{
+  g_list_foreach (entries, (GFunc)g_free, NULL);
+  g_list_free (entries);
+}
+
+static gboolean are_entries_identical (GList *old, GList *new)
+{
+  if (g_list_length (old) != g_list_length (new))
+    return FALSE;
+
+  for (old; old; old = old->next)
+    {
+      gboolean found = FALSE;
+      for (new; new; new = new->next)
+	{
+	  if (strcmp (old->data, new->data) == 0)
+	    {
+	      found = TRUE;
+	      break;
+	    }
+	}
+      if (!found)
+	return FALSE;
+    }
+  return TRUE;
+}
+
+void monitor_zfs_snap_directory_cancel (ZfsSnapDirMonitor *monitor_data)
+{
+  if (monitor_data)
+    {
+      /* printf ("in monitor_zfs_snap_directory_cancel %s\n", monitor_data->path); */
+      g_source_remove (monitor_data->timeout_id);
+      free_dir_entries (monitor_data->entries);
+      g_free (monitor_data->path);
+      g_free (monitor_data);
+    }
+}
+
+static gboolean        
+monitor_snap_dir (ZfsSnapDirMonitor *monitor_data)
+{
+  GList *new_entries;
+
+  if (!g_file_test (monitor_data->path, G_FILE_TEST_IS_DIR))
+    {
+      monitor_zfs_snap_directory_cancel (monitor_data);
+      return TRUE;
+    }
+
+  new_entries = get_dir_entries (monitor_data->path);
+
+  if (are_entries_identical (monitor_data->entries, new_entries))
+    {
+      free_dir_entries (new_entries);
+    }
+  else
+    {
+      free_dir_entries (monitor_data->entries);
+      monitor_data->entries = new_entries;
+      monitor_data->change_callback (monitor_data, monitor_data->user_data);
+    }
+  return TRUE;
+}
+
+  
+ZfsSnapDirMonitor *monitor_zfs_snap_directory (char *path, 
+					       ZfsDirChangeCallback change_callback,
+					       gpointer data)
+{
+  ZfsSnapDirMonitor *monitor_data = g_new0 (ZfsSnapDirMonitor, 1);
+
+  /* printf ("start monitoring %s\n", path); */
+
+  monitor_data->path = g_strdup (path);
+  monitor_data->entries = get_dir_entries (path);
+  monitor_data->change_callback = change_callback;
+  monitor_data->user_data = data;
+
+  monitor_data->timeout_id = g_timeout_add_seconds (5, (GSourceFunc)monitor_snap_dir, monitor_data);
+  return monitor_data;
+}
+
+char *
+ts_get_not_zfs_snapshot_dir (GFile *file)
+{
+  char tmp_path[PATH_MAX + 1];
+  gboolean found = FALSE;
+  gboolean end_path = FALSE;
+  GFile *d = g_file_get_parent(file);
+  GFile *tmp;
+  char *full_path = g_file_get_path (file);
+  char *stripped_path = g_file_get_path (d);
+  struct stat64 dir_stat64;
+
+  if (!full_path)
+     return NULL;
+
+  if (stat64 (full_path, &dir_stat64) == 0)
+    { /* check is fs is zfs if so don't try to check for nfs mounted .zfs dir*/
+      if (strcmp (dir_stat64.st_fstype, "zfs") == 0)
+        end_path = TRUE;
+    }
+
+  while (!found && !end_path)
+    {
+      g_sprintf (tmp_path, "%s/.zfs/snapshot", stripped_path);
+      if (g_file_test (tmp_path, G_FILE_TEST_IS_DIR))
+        {
+          GList *entries = get_dir_entries (tmp_path);
+          if (entries != NULL)
+            {
+              char *after_snap_path = full_path + strlen (stripped_path) + 1;
+
+              for (entries; entries; entries = entries->next)
+                {
+                  char test_path[PATH_MAX +1];
+                  g_sprintf (test_path, "%s/%s/%s", tmp_path, 
+                             entries->data,
+                             after_snap_path);
+                  if (g_file_test (test_path, G_FILE_TEST_EXISTS))
+                    {
+                      found = TRUE;
+                      break;
+                    }
+                }
+              free_dir_entries (entries);
+            }
+        }
+      tmp = d;
+      d = g_file_get_parent (tmp);
+      g_object_unref (tmp);
+      g_free (stripped_path);
+      if (d == NULL)
+        {
+          end_path = TRUE;
+        }
+      else
+        {
+          stripped_path = g_file_get_path (d);
+        }
+    }
+
+  g_free (full_path);
+
+  if (stripped_path)
+    g_free (stripped_path);
+
+  if (found)
+    return g_strdup (tmp_path);
+  else
+    return NULL;
+
+}
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/libnautilus-private/nautilus-zfs.h nautilus-2.26.2/libnautilus-private/nautilus-zfs.h
--- ../nautilus-2.26.2/libnautilus-private/nautilus-zfs.h	1970-01-01 01:00:00.000000000 +0100
+++ nautilus-2.26.2/libnautilus-private/nautilus-zfs.h	2009-04-15 16:04:45.687820716 +0200
@@ -0,0 +1,69 @@
+/* #include <config.h> */
+#ifndef NAUTILUS_ZFS_H
+#define NAUTILUS_ZFS_H
+
+#include <glib.h>
+#include <libzfs.h>
+#include <gio/gio.h>
+
+typedef struct 
+{
+  zfs_type_t	type;
+  zfs_prop_t	prop;
+  char	       *searched_path;
+  char         *mountpoint;
+  GList        *datasets;
+  GCancellable *cancel;
+  gboolean	match_found;
+  gboolean	searched_path_match_mp;
+
+} SearchDataSet;
+
+typedef struct
+{
+  char		  *name;	
+  char		  *mountpoint;	
+  char		  *mtime_str;
+  time_t	   mtime;
+  float		   used_space;
+  char		  *used_space_str;
+  zfs_type_t	   type;
+  GList		  *snapshots;
+  SearchDataSet	  *search_dataset;
+} ZfsDataSet;
+
+
+GList *ts_get_snapshots_for_dir_async	(GFile *file, 
+					 GAsyncReadyCallback result_ready, 
+					 GCancellable *cancel,
+					 gpointer  user_data);
+void ts_free_snapshots			(GList *snaps);
+void ts_free_zfs_dataset		(ZfsDataSet* zds);
+
+gboolean ts_is_in_snapshot		(char * str);
+char* ts_remove_snapshot_dir		(char *str);
+char *ts_get_snapshot_dir		(char *dir);
+char *ts_get_zfs_filesystem		(char *dir);
+char * ts_get_not_zfs_snapshot_dir      (GFile *file);
+gboolean ts_is_restore_column_enabled	();
+void ts_is_restore_column_enabled_init	();
+void print_snap_list			(char *dir, GList *snap_list);
+
+typedef void (*ZfsDirChangeCallback)	(gpointer monitor_data, 
+					 gpointer user_data);
+
+typedef struct 
+{
+  char	*		path;
+  GList			*entries;
+  guint			timeout_id;
+  ZfsDirChangeCallback	change_callback;
+  gpointer		user_data;
+} ZfsSnapDirMonitor;
+
+void monitor_zfs_snap_directory_cancel (ZfsSnapDirMonitor *monitor_data);
+ZfsSnapDirMonitor *monitor_zfs_snap_directory (char		    *path, 
+					       ZfsDirChangeCallback change_callback,
+					       gpointer		    data);
+#endif /* NAUTILUS_ZFS_H */
+
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/Makefile.am nautilus-2.26.2/src/Makefile.am
--- ../nautilus-2.26.2/src/Makefile.am	2009-04-15 16:04:23.840201667 +0200
+++ nautilus-2.26.2/src/Makefile.am	2009-04-15 16:04:45.688305613 +0200
@@ -128,6 +128,10 @@ nautilus_SOURCES = \
 	nautilus-x-content-bar.h		\
 	nautilus-zoom-control.c			\
 	nautilus-zoom-control.h			\
+	nautilus-zfs-bar.c			\
+	nautilus-zfs-bar.h			\
+	timescale.h				\
+	timescale.c				\
 	$(NULL)
 
 nautilus_file_management_properties_SOURCES= \
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/file-manager/fm-actions.h nautilus-2.26.2/src/file-manager/fm-actions.h
--- ../nautilus-2.26.2/src/file-manager/fm-actions.h	2009-04-15 16:04:23.836030354 +0200
+++ nautilus-2.26.2/src/file-manager/fm-actions.h	2009-04-15 16:04:45.688773627 +0200
@@ -52,6 +52,9 @@
 #define FM_ACTION_LOCATION_PASTE_FILES_INTO "LocationPasteFilesInto"
 #define FM_ACTION_NEW_LAUNCHER "New Launcher"
 #define FM_ACTION_RENAME "Rename"
+#define FM_ACTION_RESTORE_TO "Restore to"
+#define FM_ACTION_HAS_SNAPSHOT "View Snap"
+#define FM_ACTION_SNAP_NOW "Snap Now"
 #define FM_ACTION_DUPLICATE "Duplicate"
 #define FM_ACTION_CREATE_LINK "Create Link"
 #define FM_ACTION_SELECT_ALL "Select All"
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/file-manager/fm-directory-view.c nautilus-2.26.2/src/file-manager/fm-directory-view.c
--- ../nautilus-2.26.2/src/file-manager/fm-directory-view.c	2009-04-15 16:04:23.835694984 +0200
+++ nautilus-2.26.2/src/file-manager/fm-directory-view.c	2009-04-15 16:04:45.693804075 +0200
@@ -966,6 +966,77 @@ real_trash (FMDirectoryView *view)
 }
 
 static void
+action_snap_now (GtkAction *action,
+		 gpointer callback_data)
+{
+  FMDirectoryView *view = FM_DIRECTORY_VIEW (callback_data);
+  GList *selection = fm_directory_view_get_selection_for_file_transfer (view);
+  GFile *file = nautilus_file_get_location (NAUTILUS_FILE (selection->data));
+  char *path = g_file_get_path (file);
+  char *fs = ts_get_zfs_filesystem (path);
+  char *cmd = g_strdup_printf ("/usr/lib/time-slider-snapshot '%s' '%s'", path, fs);
+  gdk_spawn_command_line_on_screen (gtk_widget_get_screen (GTK_WIDGET (callback_data)),
+				    cmd, NULL);
+  
+  g_free (cmd);
+  g_free (fs);
+  g_free (path);
+  g_object_unref (file);
+}
+
+static void
+action_restore_to_desktop_callback (GtkAction *action,
+				    gpointer callback_data)
+{
+  GList *locations = NULL;
+  GList *node;
+  FMDirectoryView *view = FM_DIRECTORY_VIEW (callback_data);
+  char *desktop_directory = nautilus_get_desktop_directory_uri();
+  GList *selection = fm_directory_view_get_selection_for_file_transfer (view);
+
+  if (selection == NULL)
+    return;
+
+  if (desktop_directory == NULL)
+    return;
+
+
+  for (node = selection; node != NULL; node = node->next) 
+    {		
+      locations = g_list_prepend (locations,
+				  nautilus_file_get_uri ((NautilusFile *) node->data));
+    }
+  
+  fm_directory_view_move_copy_items (locations, NULL, desktop_directory,
+				     GDK_ACTION_COPY, 0, 0, view);
+
+  nautilus_file_list_free (selection);
+}
+
+static void
+action_show_snapshot_versions_callback (GtkAction *action,
+                                        gpointer callback_data)
+{
+  FMDirectoryView *view = FM_DIRECTORY_VIEW (callback_data);
+  GList *selection = fm_directory_view_get_selection_for_file_transfer (view);
+  GFile *file = nautilus_file_get_location (NAUTILUS_FILE (selection->data));
+  char *dir = nautilus_file_get_snapshot_dir (NAUTILUS_FILE (selection->data));
+  char *file_path = g_file_get_path (file);
+  char real_file_path [PATH_MAX + 1];
+  if (realpath (file_path, real_file_path))
+    {
+      char *cmd = g_strdup_printf ("/usr/lib/time-slider-version '%s' '%s'", dir,
+                                   real_file_path);
+      gdk_spawn_command_line_on_screen (gtk_widget_get_screen (GTK_WIDGET (callback_data)),
+                                        cmd, NULL);
+      g_free (cmd);
+    }
+
+  g_free (file_path);
+  g_object_unref (file);
+}
+
+static void
 action_trash_callback (GtkAction *action,
 		       gpointer callback_data)
 {
@@ -6715,6 +6786,24 @@ static const GtkActionEntry directory_vi
   /* label, accelerator */       "RenameSelectAll", "<shift>F2",
   /* tooltip */                  NULL,
                                  G_CALLBACK (action_rename_select_all_callback) },
+  /* name, stock id */         { "Restore to", NULL,
+  /* SUN_BRANDING */
+  /* label, accelerator */       N_("Restore to Desktop"), NULL,
+  /* SUN_BRANDING */
+  /* tooltip */                  N_("Move each selected item to the Desktop"),
+                                 G_CALLBACK (action_restore_to_desktop_callback) },
+  /* name, stock id */         { "View Snap", NULL,
+  /* SUN_BRANDING */
+  /* label, accelerator */       N_("View versions"), NULL,
+  /* SUN_BRANDING */
+  /* tooltip */                  N_("View the versions of this file available in ZFS snapshots"),
+                                 G_CALLBACK (action_show_snapshot_versions_callback) },
+  /* name, stock id */         { "Snap Now", NULL,
+  /* SUN_BRANDING */
+  /* label, accelerator */       N_("Snapshot now"), NULL,
+  /* SUN_BRANDING */
+  /* tooltip */                  N_("Take a ZFS snapshot of this directory now"),
+                                 G_CALLBACK (action_snap_now) },
   /* name, stock id */         { "Trash", NULL,
   /* label, accelerator */       N_("Mo_ve to Trash"), NULL,
   /* tooltip */                  N_("Move each selected item to the Trash"),
@@ -7741,6 +7830,41 @@ can_delete_all (GList *files)
 	return TRUE;
 }
 
+typedef struct {
+  NautilusFile              *file;
+  GCancellable              *cancel;
+  GtkAction                 *action;
+} HasSnapshotData;
+
+static void
+has_snapshot_ready_callback (gpointer user_data)
+{
+  GValue name = {0,};
+  HasSnapshotData *data = (HasSnapshotData*) user_data;
+  HasSnapshotResult result = nautilus_file_has_snapshot_version (data->file);
+
+  switch (result)
+    {
+    case UNKNOWN_STATE:
+    case NO:
+      gtk_action_set_sensitive (data->action, FALSE);
+      g_value_init (&name, G_TYPE_STRING);
+      /* SUN_BRANDING */
+      g_value_set_static_string (&name, _("No versions"));
+      g_object_set_property (G_OBJECT (data->action), "label", &name);
+      break;
+    case YES:
+      gtk_action_set_sensitive (data->action, TRUE);
+      g_value_init (&name, G_TYPE_STRING);
+      /* SUN_BRANDING */
+      g_value_set_static_string (&name, _("Explore versions"));
+      g_object_set_property (G_OBJECT (data->action), "label", &name);
+      break;
+    }
+  g_free (data);
+ }
+
+
 static void
 real_update_menus (FMDirectoryView *view)
 {
@@ -8046,6 +8170,79 @@ real_update_menus (FMDirectoryView *view
 					      FM_ACTION_COPY);
 	gtk_action_set_sensitive (action, can_copy_files);
 
+	action = gtk_action_group_get_action (view->details->dir_action_group,
+					      FM_ACTION_RESTORE_TO);
+	gtk_action_set_visible (action, can_copy_files && 
+				  nautilus_directory_is_in_snapshot (view->details->model));
+	
+	action = gtk_action_group_get_action (view->details->dir_action_group,
+					      FM_ACTION_SNAP_NOW);
+
+	if (selection_count == 1 && nautilus_file_is_directory (NAUTILUS_FILE (selection->data)))
+	    {
+	      GFile *file = nautilus_file_get_location (NAUTILUS_FILE (selection->data));
+	      char *path = g_file_get_path (file);
+	      char *fs = ts_get_zfs_filesystem (path);
+	      if (fs)
+		{
+		  gtk_action_set_visible (action, TRUE);
+		  g_free (fs);
+		}
+	      g_free (path);
+	      g_object_unref (file);
+	    }
+	else
+	  gtk_action_set_visible (action, FALSE);
+
+	action = gtk_action_group_get_action (view->details->dir_action_group,
+					      FM_ACTION_HAS_SNAPSHOT);
+
+  if (selection_count == 1)
+    {
+      GValue name = { 0, };
+      int result = nautilus_file_has_snapshot_version (NAUTILUS_FILE (selection->data));
+
+      switch (result)
+        {
+        case NO:
+          gtk_action_set_visible (action, FALSE);
+          break;
+        case YES:
+          gtk_action_set_visible (action, TRUE);
+          gtk_action_set_sensitive (action, TRUE);
+          g_value_init (&name,G_TYPE_STRING);
+          /* SUN_BRANDING */
+          g_value_set_static_string (&name, _("Explore versions"));
+          g_object_set_property (G_OBJECT (action), "label", &name);
+          break;
+        case UNKNOWN_STATE:
+          gtk_action_set_visible (action, TRUE);
+          gtk_action_set_sensitive (action, FALSE);
+          g_value_init (&name,G_TYPE_STRING);
+          /* SUN_BRANDING */
+          g_value_set_static_string (&name, _("Scanning for versions"));
+          g_object_set_property (G_OBJECT (action), "label", &name);
+          break;
+        }
+
+
+      if (result == UNKNOWN_STATE)
+        {
+          HasSnapshotData *data = g_new0 (HasSnapshotData, 1);
+          data->action = action;
+          data->file = NAUTILUS_FILE (selection->data);
+          data->cancel = g_cancellable_new ();
+          nautilus_file_get_snapshot_version (NAUTILUS_FILE (selection->data),
+                                              has_snapshot_ready_callback,
+                                              data->cancel,
+                                              data);
+        }
+    }
+  else
+    gtk_action_set_visible (action, FALSE);
+
+
+
 	real_update_paste_menu (view, selection, selection_count);
 
 	action = gtk_action_group_get_action (view->details->dir_action_group,
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/file-manager/nautilus-directory-view-ui.xml nautilus-2.26.2/src/file-manager/nautilus-directory-view-ui.xml
--- ../nautilus-2.26.2/src/file-manager/nautilus-directory-view-ui.xml	2009-04-15 16:04:23.838258454 +0200
+++ nautilus-2.26.2/src/file-manager/nautilus-directory-view-ui.xml	2009-04-15 16:04:45.694703766 +0200
@@ -64,6 +64,9 @@
 			<menuitem name="Duplicate" action="Duplicate"/>
 			<menuitem name="Create Link" action="Create Link"/>
 			<menuitem name="Rename" action="Rename"/>
+			<menuitem name="Restore to" action="Restore to"/>
+			<menuitem name="Snapshot now" action="Snap Now"/>
+			<menuitem name="Scanning...." action="View Snap"/>
 		</placeholder>
 		<placeholder name="Dangerous File Items Placeholder">
 			<menuitem name="Trash" action="Trash"/>
@@ -147,6 +150,9 @@
 	<placeholder name="File Actions">
 		<menuitem name="Create Link" action="Create Link"/>
 		<menuitem name="Rename" action="Rename"/>
+		<menuitem name="Restore to" action="Restore to"/>
+		<menuitem name="Snapshot now" action="Snap Now"/>
+		<menuitem name="Scanning...." action="View Snap"/>
 	</placeholder>
 	<separator name="Dangerous separator"/>
 	<placeholder name="Dangerous File Actions">
@@ -184,6 +190,7 @@
 	</placeholder>
 	<separator name="Location After Clipboard Separator"/>
 	<placeholder name="Dangerous File Actions">
+		<menuitem name="Restore" action="Restore"/>
 		<menuitem name="Trash" action="LocationTrash"/>
 		<menuitem name="Delete" action="LocationDelete"/>
 		<menuitem name="Restore From Trash" action="LocationRestoreFromTrash"/>
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/nautilus-actions.h nautilus-2.26.2/src/nautilus-actions.h
--- ../nautilus-2.26.2/src/nautilus-actions.h	2009-04-15 16:04:23.844269650 +0200
+++ nautilus-2.26.2/src/nautilus-actions.h	2009-04-15 16:04:45.695154608 +0200
@@ -28,6 +28,7 @@
 
 #define NAUTILUS_ACTION_STOP "Stop"
 #define NAUTILUS_ACTION_RELOAD "Reload"
+#define NAUTILUS_ACTION_RESTORE "Restore"
 #define NAUTILUS_ACTION_BACK "Back"
 #define NAUTILUS_ACTION_UP "Up"
 #define NAUTILUS_ACTION_UP_ACCEL "UpAccel"
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/nautilus-file-management-properties.c nautilus-2.26.2/src/nautilus-file-management-properties.c
--- ../nautilus-2.26.2/src/nautilus-file-management-properties.c	2009-04-15 16:04:23.832674026 +0200
+++ nautilus-2.26.2/src/nautilus-file-management-properties.c	2009-04-15 16:04:45.696156319 +0200
@@ -70,6 +70,7 @@
 #define NAUTILUS_FILE_MANAGEMENT_PROPERTIES_TREE_VIEW_FOLDERS_WIDGET "treeview_folders_checkbutton"
 #define NAUTILUS_FILE_MANAGEMENT_PROPERTIES_MEDIA_AUTOMOUNT_OPEN "media_automount_open_checkbutton"
 #define NAUTILUS_FILE_MANAGEMENT_PROPERTIES_MEDIA_AUTORUN_NEVER "media_autorun_never_checkbutton"
+#define NAUTILUS_FILE_MANAGEMENT_PROPERTIES_ENABLE_TIME_SLIDER "time_slider_enabled_checkbutton"
 
 /* int enums */
 #define NAUTILUS_FILE_MANAGEMENT_PROPERTIES_THUMBNAIL_LIMIT_WIDGET "preview_image_size_combobox"
@@ -730,6 +731,9 @@ nautilus_file_management_properties_dial
 	eel_preferences_builder_connect_bool (builder,
 					      NAUTILUS_FILE_MANAGEMENT_PROPERTIES_TREE_VIEW_FOLDERS_WIDGET,
 					      NAUTILUS_PREFERENCES_TREE_SHOW_ONLY_DIRECTORIES);
+	eel_preferences_builder_connect_bool (builder,
+					      NAUTILUS_FILE_MANAGEMENT_PROPERTIES_ENABLE_TIME_SLIDER,
+					      NAUTILUS_PREFERENCES_ENABLE_TIME_SLIDER);
 	
 	eel_preferences_builder_connect_string_enum_combo_box (builder,
 							       NAUTILUS_FILE_MANAGEMENT_PROPERTIES_DEFAULT_VIEW_WIDGET,
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/nautilus-file-management-properties.ui nautilus-2.26.2/src/nautilus-file-management-properties.ui
--- ../nautilus-2.26.2/src/nautilus-file-management-properties.ui	2009-04-15 16:04:23.847143832 +0200
+++ nautilus-2.26.2/src/nautilus-file-management-properties.ui	2009-04-15 16:04:45.703903267 +0200
@@ -1,8 +1,10 @@
 <?xml version="1.0"?>
-<!--*- mode: xml -*-->
 <interface>
+  <requires lib="gtk+" version="2.16"/>
+  <!-- interface-naming-policy toplevel-contextual -->
   <object class="GtkListStore" id="model1">
     <columns>
+      <!-- column-name gchararray -->
       <column type="gchararray"/>
     </columns>
     <data>
@@ -19,6 +21,7 @@
   </object>
   <object class="GtkListStore" id="model2">
     <columns>
+      <!-- column-name gchararray -->
       <column type="gchararray"/>
     </columns>
     <data>
@@ -41,6 +44,7 @@
   </object>
   <object class="GtkListStore" id="model3">
     <columns>
+      <!-- column-name gchararray -->
       <column type="gchararray"/>
     </columns>
     <data>
@@ -69,6 +73,7 @@
   </object>
   <object class="GtkListStore" id="model4">
     <columns>
+      <!-- column-name gchararray -->
       <column type="gchararray"/>
     </columns>
     <data>
@@ -97,6 +102,7 @@
   </object>
   <object class="GtkListStore" id="model5">
     <columns>
+      <!-- column-name gchararray -->
       <column type="gchararray"/>
     </columns>
     <data>
@@ -125,6 +131,7 @@
   </object>
   <object class="GtkListStore" id="model6">
     <columns>
+      <!-- column-name gchararray -->
       <column type="gchararray"/>
     </columns>
     <data>
@@ -141,6 +148,7 @@
   </object>
   <object class="GtkListStore" id="model7">
     <columns>
+      <!-- column-name gchararray -->
       <column type="gchararray"/>
     </columns>
     <data>
@@ -157,6 +165,7 @@
   </object>
   <object class="GtkListStore" id="model8">
     <columns>
+      <!-- column-name gchararray -->
       <column type="gchararray"/>
     </columns>
     <data>
@@ -194,6 +203,7 @@
   </object>
   <object class="GtkListStore" id="model9">
     <columns>
+      <!-- column-name gchararray -->
       <column type="gchararray"/>
     </columns>
     <data>
@@ -210,6 +220,7 @@
   </object>
   <object class="GtkListStore" id="model10">
     <columns>
+      <!-- column-name gchararray -->
       <column type="gchararray"/>
     </columns>
     <data>
@@ -226,181 +237,94 @@
   </object>
   <object class="GtkListStore" id="model11">
     <columns>
+      <!-- column-name gchararray -->
       <column type="gchararray"/>
     </columns>
-    <data>
-    </data>
   </object>
   <object class="GtkListStore" id="model12">
     <columns>
+      <!-- column-name gchararray -->
       <column type="gchararray"/>
     </columns>
-    <data>
-    </data>
   </object>
   <object class="GtkListStore" id="model13">
     <columns>
+      <!-- column-name gchararray -->
       <column type="gchararray"/>
     </columns>
-    <data>
-    </data>
   </object>
   <object class="GtkListStore" id="model14">
     <columns>
+      <!-- column-name gchararray -->
       <column type="gchararray"/>
     </columns>
   </object>
   <object class="GtkDialog" id="file_management_dialog">
     <property name="border_width">5</property>
     <property name="title" translatable="yes">File Management Preferences</property>
-    <property name="type">GTK_WINDOW_TOPLEVEL</property>
-    <property name="window_position">GTK_WIN_POS_CENTER</property>
-    <property name="modal">False</property>
-    <property name="resizable">True</property>
-    <property name="destroy_with_parent">False</property>
-    <property name="decorated">True</property>
-    <property name="skip_taskbar_hint">False</property>
-    <property name="skip_pager_hint">False</property>
-    <property name="type_hint">GDK_WINDOW_TYPE_HINT_DIALOG</property>
-    <property name="gravity">GDK_GRAVITY_NORTH_WEST</property>
-    <property name="focus_on_map">True</property>
-    <property name="urgency_hint">False</property>
+    <property name="window_position">center</property>
+    <property name="type_hint">dialog</property>
     <property name="has_separator">False</property>
     <child internal-child="vbox">
       <object class="GtkVBox" id="dialog-vbox1">
         <property name="visible">True</property>
-        <property name="homogeneous">False</property>
         <property name="spacing">2</property>
-        <child internal-child="action_area">
-          <object class="GtkHButtonBox" id="dialog-action_area1">
-            <property name="visible">True</property>
-            <property name="layout_style">GTK_BUTTONBOX_END</property>
-            <child>
-              <object class="GtkButton" id="helpbutton1">
-                <property name="visible">True</property>
-                <property name="can_default">True</property>
-                <property name="can_focus">True</property>
-                <property name="label">gtk-help</property>
-                <property name="use_stock">True</property>
-                <property name="relief">GTK_RELIEF_NORMAL</property>
-                <property name="focus_on_click">True</property>
-              </object>
-            </child>
-            <child>
-              <object class="GtkButton" id="closebutton1">
-                <property name="visible">True</property>
-                <property name="can_default">True</property>
-                <property name="can_focus">True</property>
-                <property name="label">gtk-close</property>
-                <property name="use_stock">True</property>
-                <property name="relief">GTK_RELIEF_NORMAL</property>
-                <property name="focus_on_click">True</property>
-              </object>
-            </child>
-          </object>
-          <packing>
-            <property name="padding">0</property>
-            <property name="expand">False</property>
-            <property name="fill">True</property>
-            <property name="pack_type">GTK_PACK_END</property>
-          </packing>
-        </child>
         <child>
           <object class="GtkNotebook" id="notebook1">
-            <property name="border_width">5</property>
             <property name="visible">True</property>
             <property name="can_focus">True</property>
-            <property name="show_tabs">True</property>
-            <property name="show_border">True</property>
-            <property name="tab_pos">GTK_POS_TOP</property>
-            <property name="scrollable">False</property>
-            <property name="enable_popup">False</property>
+            <property name="border_width">5</property>
             <child>
               <object class="GtkVBox" id="vbox1">
-                <property name="border_width">12</property>
                 <property name="visible">True</property>
-                <property name="homogeneous">False</property>
+                <property name="border_width">12</property>
                 <property name="spacing">18</property>
                 <child>
                   <object class="GtkVBox" id="vbox2">
                     <property name="visible">True</property>
-                    <property name="homogeneous">False</property>
                     <property name="spacing">6</property>
                     <child>
                       <object class="GtkLabel" id="label4">
                         <property name="visible">True</property>
+                        <property name="xalign">0</property>
                         <property name="label" translatable="yes">&lt;b&gt;Default View&lt;/b&gt;</property>
-                        <property name="use_underline">False</property>
                         <property name="use_markup">True</property>
-                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                        <property name="wrap">False</property>
-                        <property name="selectable">False</property>
-                        <property name="xalign">0</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xpad">0</property>
-                        <property name="ypad">0</property>
-                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                        <property name="width_chars">-1</property>
-                        <property name="single_line_mode">False</property>
-                        <property name="angle">0</property>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
                         <property name="expand">False</property>
                         <property name="fill">False</property>
+                        <property name="position">0</property>
                       </packing>
                     </child>
                     <child>
                       <object class="GtkAlignment" id="alignment2">
                         <property name="visible">True</property>
-                        <property name="xalign">0.5</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xscale">1</property>
-                        <property name="yscale">1</property>
-                        <property name="top_padding">0</property>
-                        <property name="bottom_padding">0</property>
                         <property name="left_padding">12</property>
-                        <property name="right_padding">0</property>
                         <child>
                           <object class="GtkVBox" id="vbox14">
                             <property name="visible">True</property>
-                            <property name="homogeneous">False</property>
                             <property name="spacing">6</property>
                             <child>
                               <object class="GtkHBox" id="hbox34">
                                 <property name="visible">True</property>
-                                <property name="homogeneous">False</property>
                                 <property name="spacing">12</property>
                                 <child>
                                   <object class="GtkLabel" id="views_label_0">
                                     <property name="visible">True</property>
+                                    <property name="xalign">0</property>
                                     <property name="label" translatable="yes">View _new folders using:</property>
                                     <property name="use_underline">True</property>
-                                    <property name="use_markup">False</property>
-                                    <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                    <property name="wrap">False</property>
-                                    <property name="selectable">False</property>
-                                    <property name="xalign">0</property>
-                                    <property name="yalign">0.5</property>
-                                    <property name="xpad">0</property>
-                                    <property name="ypad">0</property>
                                     <property name="mnemonic_widget">default_view_combobox</property>
-                                    <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                    <property name="width_chars">-1</property>
-                                    <property name="single_line_mode">False</property>
-                                    <property name="angle">0</property>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
                                     <property name="expand">False</property>
                                     <property name="fill">False</property>
+                                    <property name="position">0</property>
                                   </packing>
                                 </child>
                                 <child>
                                   <object class="GtkComboBox" id="default_view_combobox">
                                     <property name="visible">True</property>
-                                    <property name="add_tearoffs">False</property>
-                                    <property name="focus_on_click">True</property>
                                     <property name="model">model1</property>
                                     <child>
                                       <object class="GtkCellRendererText" id="renderer1"/>
@@ -410,53 +334,35 @@
                                     </child>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
-                                    <property name="expand">True</property>
-                                    <property name="fill">True</property>
+                                    <property name="position">1</property>
                                   </packing>
                                 </child>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
-                                <property name="expand">True</property>
-                                <property name="fill">True</property>
+                                <property name="position">0</property>
                               </packing>
                             </child>
                             <child>
                               <object class="GtkHBox" id="hbox11">
                                 <property name="visible">True</property>
-                                <property name="homogeneous">False</property>
                                 <property name="spacing">12</property>
                                 <child>
                                   <object class="GtkLabel" id="views_label_1">
                                     <property name="visible">True</property>
+                                    <property name="xalign">0</property>
                                     <property name="label" translatable="yes">_Arrange items:</property>
                                     <property name="use_underline">True</property>
-                                    <property name="use_markup">False</property>
-                                    <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                    <property name="wrap">False</property>
-                                    <property name="selectable">False</property>
-                                    <property name="xalign">0</property>
-                                    <property name="yalign">0.5</property>
-                                    <property name="xpad">0</property>
-                                    <property name="ypad">0</property>
                                     <property name="mnemonic_widget">sort_order_combobox</property>
-                                    <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                    <property name="width_chars">-1</property>
-                                    <property name="single_line_mode">False</property>
-                                    <property name="angle">0</property>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
                                     <property name="expand">False</property>
                                     <property name="fill">False</property>
+                                    <property name="position">0</property>
                                   </packing>
                                 </child>
                                 <child>
                                   <object class="GtkComboBox" id="sort_order_combobox">
                                     <property name="visible">True</property>
-                                    <property name="add_tearoffs">False</property>
-                                    <property name="focus_on_click">True</property>
                                     <property name="model">model2</property>
                                     <child>
                                       <object class="GtkCellRendererText" id="renderer2"/>
@@ -466,150 +372,103 @@
                                     </child>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
-                                    <property name="expand">True</property>
-                                    <property name="fill">True</property>
+                                    <property name="position">1</property>
                                   </packing>
                                 </child>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
-                                <property name="expand">True</property>
-                                <property name="fill">True</property>
+                                <property name="position">1</property>
                               </packing>
                             </child>
                             <child>
                               <object class="GtkCheckButton" id="sort_folders_first_checkbutton">
+                                <property name="label" translatable="yes">Sort _folders before files</property>
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Sort _folders before files</property>
+                                <property name="receives_default">False</property>
                                 <property name="use_underline">True</property>
-                                <property name="relief">GTK_RELIEF_NORMAL</property>
-                                <property name="focus_on_click">True</property>
-                                <property name="active">False</property>
-                                <property name="inconsistent">False</property>
                                 <property name="draw_indicator">True</property>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
                                 <property name="expand">False</property>
                                 <property name="fill">False</property>
+                                <property name="position">2</property>
                               </packing>
                             </child>
                             <child>
                               <object class="GtkCheckButton" id="hidden_files_checkbutton">
+                                <property name="label" translatable="yes">Show hidden and _backup files</property>
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Show hidden and _backup files</property>
+                                <property name="receives_default">False</property>
                                 <property name="use_underline">True</property>
-                                <property name="relief">GTK_RELIEF_NORMAL</property>
-                                <property name="focus_on_click">True</property>
-                                <property name="active">False</property>
-                                <property name="inconsistent">False</property>
                                 <property name="draw_indicator">True</property>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
                                 <property name="expand">False</property>
                                 <property name="fill">False</property>
+                                <property name="position">3</property>
                               </packing>
                             </child>
                           </object>
                         </child>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
-                        <property name="expand">True</property>
-                        <property name="fill">True</property>
+                        <property name="position">1</property>
                       </packing>
                     </child>
                   </object>
                   <packing>
-                    <property name="padding">0</property>
                     <property name="expand">False</property>
-                    <property name="fill">True</property>
+                    <property name="position">0</property>
                   </packing>
                 </child>
                 <child>
                   <object class="GtkVBox" id="vbox3">
                     <property name="visible">True</property>
-                    <property name="homogeneous">False</property>
                     <property name="spacing">6</property>
                     <child>
                       <object class="GtkLabel" id="label5">
                         <property name="visible">True</property>
+                        <property name="xalign">0</property>
                         <property name="label" translatable="yes">&lt;b&gt;Icon View Defaults&lt;/b&gt;</property>
-                        <property name="use_underline">False</property>
                         <property name="use_markup">True</property>
-                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                        <property name="wrap">False</property>
-                        <property name="selectable">False</property>
-                        <property name="xalign">0</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xpad">0</property>
-                        <property name="ypad">0</property>
-                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                        <property name="width_chars">-1</property>
-                        <property name="single_line_mode">False</property>
-                        <property name="angle">0</property>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
                         <property name="expand">False</property>
                         <property name="fill">False</property>
+                        <property name="position">0</property>
                       </packing>
                     </child>
                     <child>
                       <object class="GtkAlignment" id="alignment1">
                         <property name="visible">True</property>
-                        <property name="xalign">0.5</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xscale">1</property>
-                        <property name="yscale">1</property>
-                        <property name="top_padding">0</property>
-                        <property name="bottom_padding">0</property>
                         <property name="left_padding">12</property>
-                        <property name="right_padding">0</property>
                         <child>
                           <object class="GtkVBox" id="vbox16">
                             <property name="visible">True</property>
-                            <property name="homogeneous">False</property>
                             <property name="spacing">6</property>
                             <child>
                               <object class="GtkHBox" id="hbox35">
                                 <property name="visible">True</property>
-                                <property name="homogeneous">False</property>
                                 <property name="spacing">12</property>
                                 <child>
                                   <object class="GtkLabel" id="views_label_2">
                                     <property name="visible">True</property>
+                                    <property name="xalign">0</property>
                                     <property name="label" translatable="yes">Default _zoom level:</property>
                                     <property name="use_underline">True</property>
-                                    <property name="use_markup">False</property>
-                                    <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                    <property name="wrap">False</property>
-                                    <property name="selectable">False</property>
-                                    <property name="xalign">0</property>
-                                    <property name="yalign">0.5</property>
-                                    <property name="xpad">0</property>
-                                    <property name="ypad">0</property>
                                     <property name="mnemonic_widget">icon_view_zoom_combobox</property>
-                                    <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                    <property name="width_chars">-1</property>
-                                    <property name="single_line_mode">False</property>
-                                    <property name="angle">0</property>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
                                     <property name="expand">False</property>
                                     <property name="fill">False</property>
+                                    <property name="position">0</property>
                                   </packing>
                                 </child>
                                 <child>
                                   <object class="GtkComboBox" id="icon_view_zoom_combobox">
                                     <property name="visible">True</property>
-                                    <property name="add_tearoffs">False</property>
-                                    <property name="focus_on_click">True</property>
                                     <property name="model">model3</property>
                                     <child>
                                       <object class="GtkCellRendererText" id="renderer3"/>
@@ -619,150 +478,103 @@
                                     </child>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
-                                    <property name="expand">True</property>
-                                    <property name="fill">True</property>
+                                    <property name="position">1</property>
                                   </packing>
                                 </child>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
-                                <property name="expand">True</property>
-                                <property name="fill">True</property>
+                                <property name="position">0</property>
                               </packing>
                             </child>
                             <child>
                               <object class="GtkCheckButton" id="compact_layout_checkbutton">
+                                <property name="label" translatable="yes">_Use compact layout</property>
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">_Use compact layout</property>
+                                <property name="receives_default">False</property>
                                 <property name="use_underline">True</property>
-                                <property name="relief">GTK_RELIEF_NORMAL</property>
-                                <property name="focus_on_click">True</property>
-                                <property name="active">False</property>
-                                <property name="inconsistent">False</property>
                                 <property name="draw_indicator">True</property>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
                                 <property name="expand">False</property>
                                 <property name="fill">False</property>
+                                <property name="position">1</property>
                               </packing>
                             </child>
                             <child>
                               <object class="GtkCheckButton" id="labels_beside_icons_checkbutton">
+                                <property name="label" translatable="yes">_Text beside icons</property>
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">_Text beside icons</property>
+                                <property name="receives_default">False</property>
                                 <property name="use_underline">True</property>
-                                <property name="relief">GTK_RELIEF_NORMAL</property>
-                                <property name="focus_on_click">True</property>
-                                <property name="active">False</property>
-                                <property name="inconsistent">False</property>
                                 <property name="draw_indicator">True</property>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
                                 <property name="expand">False</property>
                                 <property name="fill">False</property>
+                                <property name="position">2</property>
                               </packing>
                             </child>
                           </object>
                         </child>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
-                        <property name="expand">True</property>
-                        <property name="fill">True</property>
+                        <property name="position">1</property>
                       </packing>
                     </child>
                   </object>
                   <packing>
-                    <property name="padding">0</property>
                     <property name="expand">False</property>
-                    <property name="fill">True</property>
+                    <property name="position">1</property>
                   </packing>
                 </child>
                 <child>
                   <object class="GtkVBox" id="vbox">
                     <property name="visible">True</property>
-                    <property name="homogeneous">False</property>
                     <property name="spacing">6</property>
                     <child>
                       <object class="GtkLabel" id="label">
                         <property name="visible">True</property>
+                        <property name="xalign">0</property>
                         <property name="label" translatable="yes">&lt;b&gt;Compact View Defaults&lt;/b&gt;</property>
-                        <property name="use_underline">False</property>
                         <property name="use_markup">True</property>
-                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                        <property name="wrap">False</property>
-                        <property name="selectable">False</property>
-                        <property name="xalign">0</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xpad">0</property>
-                        <property name="ypad">0</property>
-                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                        <property name="width_chars">-1</property>
-                        <property name="single_line_mode">False</property>
-                        <property name="angle">0</property>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
                         <property name="expand">False</property>
                         <property name="fill">False</property>
+                        <property name="position">0</property>
                       </packing>
                     </child>
                     <child>
                       <object class="GtkAlignment" id="alignment">
                         <property name="visible">True</property>
-                        <property name="xalign">0.5</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xscale">1</property>
-                        <property name="yscale">1</property>
-                        <property name="top_padding">0</property>
-                        <property name="bottom_padding">0</property>
                         <property name="left_padding">12</property>
-                        <property name="right_padding">0</property>
                         <child>
                           <object class="GtkVBox" id="vbox42">
                             <property name="visible">True</property>
-                            <property name="homogeneous">False</property>
                             <property name="spacing">6</property>
                             <child>
                               <object class="GtkHBox" id="hbox">
                                 <property name="visible">True</property>
-                                <property name="homogeneous">False</property>
                                 <property name="spacing">12</property>
                                 <child>
                                   <object class="GtkLabel" id="views_label_4">
                                     <property name="visible">True</property>
+                                    <property name="xalign">0</property>
                                     <property name="label" translatable="yes">_Default zoom level:</property>
                                     <property name="use_underline">True</property>
-                                    <property name="use_markup">False</property>
-                                    <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                    <property name="wrap">False</property>
-                                    <property name="selectable">False</property>
-                                    <property name="xalign">0</property>
-                                    <property name="yalign">0.5</property>
-                                    <property name="xpad">0</property>
-                                    <property name="ypad">0</property>
                                     <property name="mnemonic_widget">compact_view_zoom_combobox</property>
-                                    <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                    <property name="width_chars">-1</property>
-                                    <property name="single_line_mode">False</property>
-                                    <property name="angle">0</property>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
                                     <property name="expand">False</property>
                                     <property name="fill">False</property>
+                                    <property name="position">0</property>
                                   </packing>
                                 </child>
                                 <child>
                                   <object class="GtkComboBox" id="compact_view_zoom_combobox">
                                     <property name="visible">True</property>
-                                    <property name="add_tearoffs">False</property>
-                                    <property name="focus_on_click">True</property>
                                     <property name="model">model4</property>
                                     <child>
                                       <object class="GtkCellRendererText" id="renderer4"/>
@@ -772,132 +584,88 @@
                                     </child>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
-                                    <property name="expand">True</property>
-                                    <property name="fill">True</property>
+                                    <property name="position">1</property>
                                   </packing>
                                 </child>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
-                                <property name="expand">True</property>
-                                <property name="fill">True</property>
+                                <property name="position">0</property>
                               </packing>
                             </child>
                             <child>
                               <object class="GtkCheckButton" id="all_columns_same_width_checkbutton">
+                                <property name="label" translatable="yes">A_ll columns have the same width</property>
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">A_ll columns have the same width</property>
+                                <property name="receives_default">False</property>
                                 <property name="use_underline">True</property>
-                                <property name="relief">GTK_RELIEF_NORMAL</property>
-                                <property name="focus_on_click">True</property>
-                                <property name="active">False</property>
-                                <property name="inconsistent">False</property>
                                 <property name="draw_indicator">True</property>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
                                 <property name="expand">False</property>
                                 <property name="fill">False</property>
+                                <property name="position">1</property>
                               </packing>
                             </child>
                           </object>
                         </child>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
-                        <property name="expand">True</property>
-                        <property name="fill">True</property>
+                        <property name="position">1</property>
                       </packing>
                     </child>
                   </object>
                   <packing>
-                    <property name="padding">0</property>
                     <property name="expand">False</property>
-                    <property name="fill">True</property>
+                    <property name="position">2</property>
                   </packing>
                 </child>
                 <child>
                   <object class="GtkVBox" id="vbox4">
                     <property name="visible">True</property>
-                    <property name="homogeneous">False</property>
                     <property name="spacing">6</property>
                     <child>
                       <object class="GtkLabel" id="label6">
                         <property name="visible">True</property>
+                        <property name="xalign">0</property>
                         <property name="label" translatable="yes">&lt;b&gt;List View Defaults&lt;/b&gt;</property>
-                        <property name="use_underline">False</property>
                         <property name="use_markup">True</property>
-                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                        <property name="wrap">False</property>
-                        <property name="selectable">False</property>
-                        <property name="xalign">0</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xpad">0</property>
-                        <property name="ypad">0</property>
-                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                        <property name="width_chars">-1</property>
-                        <property name="single_line_mode">False</property>
-                        <property name="angle">0</property>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
                         <property name="expand">False</property>
                         <property name="fill">False</property>
+                        <property name="position">0</property>
                       </packing>
                     </child>
                     <child>
                       <object class="GtkAlignment" id="alignment3">
                         <property name="visible">True</property>
-                        <property name="xalign">0.5</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xscale">1</property>
-                        <property name="yscale">1</property>
-                        <property name="top_padding">0</property>
-                        <property name="bottom_padding">0</property>
                         <property name="left_padding">12</property>
-                        <property name="right_padding">0</property>
                         <child>
                           <object class="GtkVBox" id="vbox15">
                             <property name="visible">True</property>
-                            <property name="homogeneous">False</property>
                             <property name="spacing">6</property>
                             <child>
                               <object class="GtkHBox" id="hbox36">
                                 <property name="visible">True</property>
-                                <property name="homogeneous">False</property>
                                 <property name="spacing">12</property>
                                 <child>
                                   <object class="GtkLabel" id="views_label_3">
                                     <property name="visible">True</property>
+                                    <property name="xalign">0</property>
                                     <property name="label" translatable="yes">D_efault zoom level:</property>
                                     <property name="use_underline">True</property>
-                                    <property name="use_markup">False</property>
-                                    <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                    <property name="wrap">False</property>
-                                    <property name="selectable">False</property>
-                                    <property name="xalign">0</property>
-                                    <property name="yalign">0.5</property>
-                                    <property name="xpad">0</property>
-                                    <property name="ypad">0</property>
                                     <property name="mnemonic_widget">list_view_zoom_combobox</property>
-                                    <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                    <property name="width_chars">-1</property>
-                                    <property name="single_line_mode">False</property>
-                                    <property name="angle">0</property>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
                                     <property name="expand">False</property>
                                     <property name="fill">False</property>
+                                    <property name="position">0</property>
                                   </packing>
                                 </child>
                                 <child>
                                   <object class="GtkComboBox" id="list_view_zoom_combobox">
                                     <property name="visible">True</property>
-                                    <property name="add_tearoffs">False</property>
-                                    <property name="focus_on_click">True</property>
                                     <property name="model">model5</property>
                                     <child>
                                       <object class="GtkCellRendererText" id="renderer5"/>
@@ -907,633 +675,416 @@
                                     </child>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
-                                    <property name="expand">True</property>
-                                    <property name="fill">True</property>
+                                    <property name="position">1</property>
                                   </packing>
                                 </child>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
-                                <property name="expand">True</property>
-                                <property name="fill">True</property>
+                                <property name="position">0</property>
                               </packing>
                             </child>
                           </object>
                         </child>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
-                        <property name="expand">True</property>
-                        <property name="fill">True</property>
+                        <property name="position">1</property>
                       </packing>
                     </child>
                   </object>
                   <packing>
-                    <property name="padding">0</property>
                     <property name="expand">False</property>
-                    <property name="fill">True</property>
+                    <property name="position">3</property>
                   </packing>
                 </child>
                 <child>
                   <object class="GtkVBox" id="vbox24">
                     <property name="visible">True</property>
-                    <property name="homogeneous">False</property>
                     <property name="spacing">6</property>
                     <child>
                       <object class="GtkLabel" id="label25">
                         <property name="visible">True</property>
+                        <property name="xalign">0</property>
                         <property name="label" translatable="yes">&lt;b&gt;Tree View Defaults&lt;/b&gt;</property>
-                        <property name="use_underline">False</property>
                         <property name="use_markup">True</property>
-                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                        <property name="wrap">False</property>
-                        <property name="selectable">False</property>
-                        <property name="xalign">0</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xpad">0</property>
-                        <property name="ypad">0</property>
-                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                        <property name="width_chars">-1</property>
-                        <property name="single_line_mode">False</property>
-                        <property name="angle">0</property>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
                         <property name="expand">False</property>
                         <property name="fill">False</property>
+                        <property name="position">0</property>
                       </packing>
                     </child>
                     <child>
                       <object class="GtkAlignment" id="alignment4">
                         <property name="visible">True</property>
-                        <property name="xalign">0.5</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xscale">1</property>
-                        <property name="yscale">1</property>
-                        <property name="top_padding">0</property>
-                        <property name="bottom_padding">0</property>
                         <property name="left_padding">12</property>
-                        <property name="right_padding">0</property>
                         <child>
                           <object class="GtkVBox" id="vbox25">
                             <property name="visible">True</property>
-                            <property name="homogeneous">False</property>
                             <property name="spacing">6</property>
                             <child>
                               <object class="GtkCheckButton" id="treeview_folders_checkbutton">
+                                <property name="label" translatable="yes">Show _only folders</property>
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Show _only folders</property>
+                                <property name="receives_default">False</property>
                                 <property name="use_underline">True</property>
-                                <property name="relief">GTK_RELIEF_NORMAL</property>
-                                <property name="focus_on_click">True</property>
-                                <property name="active">False</property>
-                                <property name="inconsistent">False</property>
                                 <property name="draw_indicator">True</property>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
                                 <property name="expand">False</property>
                                 <property name="fill">False</property>
+                                <property name="position">0</property>
                               </packing>
                             </child>
                           </object>
                         </child>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
-                        <property name="expand">True</property>
-                        <property name="fill">True</property>
+                        <property name="position">1</property>
                       </packing>
                     </child>
                   </object>
                   <packing>
-                    <property name="padding">0</property>
                     <property name="expand">False</property>
-                    <property name="fill">True</property>
+                    <property name="position">4</property>
                   </packing>
                 </child>
               </object>
-              <packing>
-                <property name="tab_expand">False</property>
-                <property name="tab_fill">True</property>
-              </packing>
             </child>
             <child type="tab">
               <object class="GtkLabel" id="label1">
                 <property name="visible">True</property>
                 <property name="label" translatable="yes">Views</property>
-                <property name="use_underline">False</property>
-                <property name="use_markup">False</property>
-                <property name="justify">GTK_JUSTIFY_LEFT</property>
-                <property name="wrap">False</property>
-                <property name="selectable">False</property>
-                <property name="xalign">0.5</property>
-                <property name="yalign">0.5</property>
-                <property name="xpad">0</property>
-                <property name="ypad">0</property>
-                <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                <property name="width_chars">-1</property>
-                <property name="single_line_mode">False</property>
-                <property name="angle">0</property>
               </object>
+              <packing>
+                <property name="tab_fill">False</property>
+              </packing>
             </child>
             <child>
               <object class="GtkVBox" id="vbox5">
-                <property name="border_width">12</property>
                 <property name="visible">True</property>
-                <property name="homogeneous">False</property>
+                <property name="border_width">12</property>
                 <property name="spacing">18</property>
                 <child>
                   <object class="GtkVBox" id="vbox6">
                     <property name="visible">True</property>
-                    <property name="homogeneous">False</property>
                     <property name="spacing">6</property>
                     <child>
                       <object class="GtkLabel" id="label10">
                         <property name="visible">True</property>
+                        <property name="xalign">0</property>
                         <property name="label" translatable="yes">&lt;b&gt;Behavior&lt;/b&gt;</property>
-                        <property name="use_underline">False</property>
                         <property name="use_markup">True</property>
-                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                        <property name="wrap">False</property>
-                        <property name="selectable">False</property>
-                        <property name="xalign">0</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xpad">0</property>
-                        <property name="ypad">0</property>
-                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                        <property name="width_chars">-1</property>
-                        <property name="single_line_mode">False</property>
-                        <property name="angle">0</property>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
                         <property name="expand">False</property>
                         <property name="fill">False</property>
+                        <property name="position">0</property>
                       </packing>
                     </child>
                     <child>
                       <object class="GtkAlignment" id="alignment5">
                         <property name="visible">True</property>
-                        <property name="xalign">0.5</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xscale">1</property>
-                        <property name="yscale">1</property>
-                        <property name="top_padding">0</property>
-                        <property name="bottom_padding">0</property>
                         <property name="left_padding">12</property>
-                        <property name="right_padding">0</property>
                         <child>
                           <object class="GtkVBox" id="vbox17">
                             <property name="visible">True</property>
-                            <property name="homogeneous">False</property>
-                            <property name="spacing">0</property>
                             <child>
                               <object class="GtkRadioButton" id="single_click_radiobutton">
+                                <property name="label" translatable="yes">_Single click to open items</property>
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">_Single click to open items</property>
+                                <property name="receives_default">False</property>
                                 <property name="use_underline">True</property>
-                                <property name="relief">GTK_RELIEF_NORMAL</property>
-                                <property name="focus_on_click">True</property>
-                                <property name="active">False</property>
-                                <property name="inconsistent">False</property>
                                 <property name="draw_indicator">True</property>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
                                 <property name="expand">False</property>
                                 <property name="fill">False</property>
+                                <property name="position">0</property>
                               </packing>
                             </child>
                             <child>
                               <object class="GtkRadioButton" id="double_click_radiobutton">
+                                <property name="label" translatable="yes">_Double click to open items</property>
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">_Double click to open items</property>
+                                <property name="receives_default">False</property>
                                 <property name="use_underline">True</property>
-                                <property name="relief">GTK_RELIEF_NORMAL</property>
-                                <property name="focus_on_click">True</property>
-                                <property name="active">False</property>
-                                <property name="inconsistent">False</property>
                                 <property name="draw_indicator">True</property>
                                 <property name="group">single_click_radiobutton</property>
                               </object>
                               <packing>
-                                <property name="padding">6</property>
                                 <property name="expand">False</property>
                                 <property name="fill">False</property>
+                                <property name="padding">6</property>
+                                <property name="position">1</property>
                               </packing>
                             </child>
                             <child>
-                              <object class="GtkLabel" id="label">
+                              <object class="GtkLabel" id="label2">
                                 <property name="height_request">6</property>
                                 <property name="visible">True</property>
-                                <property name="label" translatable="yes"/>
-                                <property name="use_underline">False</property>
-                                <property name="use_markup">False</property>
-                                <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                <property name="wrap">False</property>
-                                <property name="selectable">False</property>
-                                <property name="xalign">0.5</property>
-                                <property name="yalign">0.5</property>
-                                <property name="xpad">0</property>
-                                <property name="ypad">0</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                <property name="width_chars">-1</property>
-                                <property name="single_line_mode">False</property>
-                                <property name="angle">0</property>
-                              </object>
-                              <packing>
-                                <property name="padding">0</property>
-                                <property name="expand">True</property>
-                                <property name="fill">True</property>
+                              </object>
+                              <packing>
+                                <property name="position">2</property>
                               </packing>
                             </child>
                             <child>
                               <object class="GtkCheckButton" id="always_use_browser_checkbutton">
+                                <property name="label" translatable="yes">Always open in _browser windows</property>
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Always open in _browser windows</property>
+                                <property name="receives_default">False</property>
                                 <property name="use_underline">True</property>
-                                <property name="relief">GTK_RELIEF_NORMAL</property>
-                                <property name="focus_on_click">True</property>
-                                <property name="active">False</property>
-                                <property name="inconsistent">False</property>
                                 <property name="draw_indicator">True</property>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
                                 <property name="expand">False</property>
                                 <property name="fill">False</property>
+                                <property name="position">3</property>
                               </packing>
                             </child>
                           </object>
                         </child>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
-                        <property name="expand">True</property>
-                        <property name="fill">True</property>
+                        <property name="position">1</property>
                       </packing>
                     </child>
                   </object>
                   <packing>
-                    <property name="padding">0</property>
                     <property name="expand">False</property>
-                    <property name="fill">True</property>
+                    <property name="position">0</property>
                   </packing>
                 </child>
                 <child>
                   <object class="GtkVBox" id="vbox7">
                     <property name="visible">True</property>
-                    <property name="homogeneous">False</property>
                     <property name="spacing">6</property>
                     <child>
                       <object class="GtkLabel" id="label12">
                         <property name="visible">True</property>
+                        <property name="xalign">0</property>
                         <property name="label" translatable="yes">&lt;b&gt;Executable Text Files&lt;/b&gt;</property>
-                        <property name="use_underline">False</property>
                         <property name="use_markup">True</property>
-                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                        <property name="wrap">False</property>
-                        <property name="selectable">False</property>
-                        <property name="xalign">0</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xpad">0</property>
-                        <property name="ypad">0</property>
-                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                        <property name="width_chars">-1</property>
-                        <property name="single_line_mode">False</property>
-                        <property name="angle">0</property>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
                         <property name="expand">False</property>
                         <property name="fill">False</property>
+                        <property name="position">0</property>
                       </packing>
                     </child>
                     <child>
                       <object class="GtkAlignment" id="alignment6">
                         <property name="visible">True</property>
-                        <property name="xalign">0.5</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xscale">1</property>
-                        <property name="yscale">1</property>
-                        <property name="top_padding">0</property>
-                        <property name="bottom_padding">0</property>
                         <property name="left_padding">12</property>
-                        <property name="right_padding">0</property>
                         <child>
                           <object class="GtkVBox" id="vbox18">
                             <property name="visible">True</property>
-                            <property name="homogeneous">False</property>
                             <property name="spacing">6</property>
                             <child>
                               <object class="GtkRadioButton" id="scripts_execute_radiobutton">
+                                <property name="label" translatable="yes">_Run executable text files when they are opened</property>
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">_Run executable text files when they are opened</property>
+                                <property name="receives_default">False</property>
                                 <property name="use_underline">True</property>
-                                <property name="relief">GTK_RELIEF_NORMAL</property>
-                                <property name="focus_on_click">True</property>
-                                <property name="active">False</property>
-                                <property name="inconsistent">False</property>
                                 <property name="draw_indicator">True</property>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
                                 <property name="expand">False</property>
                                 <property name="fill">False</property>
+                                <property name="position">0</property>
                               </packing>
                             </child>
                             <child>
                               <object class="GtkRadioButton" id="scripts_view_radiobutton">
+                                <property name="label" translatable="yes">_View executable text files when they are opened</property>
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">_View executable text files when they are opened</property>
+                                <property name="receives_default">False</property>
                                 <property name="use_underline">True</property>
-                                <property name="relief">GTK_RELIEF_NORMAL</property>
-                                <property name="focus_on_click">True</property>
-                                <property name="active">False</property>
-                                <property name="inconsistent">False</property>
                                 <property name="draw_indicator">True</property>
                                 <property name="group">scripts_execute_radiobutton</property>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
                                 <property name="expand">False</property>
                                 <property name="fill">False</property>
+                                <property name="position">1</property>
                               </packing>
                             </child>
                             <child>
                               <object class="GtkRadioButton" id="scripts_confirm_radiobutton">
+                                <property name="label" translatable="yes">_Ask each time</property>
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">_Ask each time</property>
+                                <property name="receives_default">False</property>
                                 <property name="use_underline">True</property>
-                                <property name="relief">GTK_RELIEF_NORMAL</property>
-                                <property name="focus_on_click">True</property>
-                                <property name="active">False</property>
-                                <property name="inconsistent">False</property>
                                 <property name="draw_indicator">True</property>
                                 <property name="group">scripts_execute_radiobutton</property>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
                                 <property name="expand">False</property>
                                 <property name="fill">False</property>
+                                <property name="position">2</property>
                               </packing>
                             </child>
                           </object>
                         </child>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
-                        <property name="expand">True</property>
-                        <property name="fill">True</property>
+                        <property name="position">1</property>
                       </packing>
                     </child>
                   </object>
                   <packing>
-                    <property name="padding">0</property>
                     <property name="expand">False</property>
-                    <property name="fill">True</property>
+                    <property name="position">1</property>
                   </packing>
                 </child>
                 <child>
                   <object class="GtkVBox" id="vbox8">
                     <property name="visible">True</property>
-                    <property name="homogeneous">False</property>
                     <property name="spacing">6</property>
                     <child>
                       <object class="GtkLabel" id="label14">
                         <property name="visible">True</property>
+                        <property name="xalign">0</property>
                         <property name="label" translatable="yes">&lt;b&gt;Trash&lt;/b&gt;</property>
-                        <property name="use_underline">False</property>
                         <property name="use_markup">True</property>
-                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                        <property name="wrap">False</property>
-                        <property name="selectable">False</property>
-                        <property name="xalign">0</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xpad">0</property>
-                        <property name="ypad">0</property>
-                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                        <property name="width_chars">-1</property>
-                        <property name="single_line_mode">False</property>
-                        <property name="angle">0</property>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
                         <property name="expand">False</property>
                         <property name="fill">False</property>
+                        <property name="position">0</property>
                       </packing>
                     </child>
                     <child>
                       <object class="GtkAlignment" id="alignment7">
                         <property name="visible">True</property>
-                        <property name="xalign">0.5</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xscale">1</property>
-                        <property name="yscale">1</property>
-                        <property name="top_padding">0</property>
-                        <property name="bottom_padding">0</property>
                         <property name="left_padding">12</property>
-                        <property name="right_padding">0</property>
                         <child>
                           <object class="GtkVBox" id="vbox19">
                             <property name="visible">True</property>
-                            <property name="homogeneous">False</property>
                             <property name="spacing">6</property>
                             <child>
                               <object class="GtkCheckButton" id="trash_confirm_checkbutton">
+                                <property name="label" translatable="yes">Ask before _emptying the Trash or deleting files</property>
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Ask before _emptying the Trash or deleting files</property>
+                                <property name="receives_default">False</property>
                                 <property name="use_underline">True</property>
-                                <property name="relief">GTK_RELIEF_NORMAL</property>
-                                <property name="focus_on_click">True</property>
-                                <property name="active">False</property>
-                                <property name="inconsistent">False</property>
                                 <property name="draw_indicator">True</property>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
                                 <property name="expand">False</property>
                                 <property name="fill">False</property>
+                                <property name="position">0</property>
                               </packing>
                             </child>
                             <child>
                               <object class="GtkCheckButton" id="trash_delete_checkbutton">
+                                <property name="label" translatable="yes">I_nclude a Delete command that bypasses Trash</property>
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">I_nclude a Delete command that bypasses Trash</property>
+                                <property name="receives_default">False</property>
                                 <property name="use_underline">True</property>
-                                <property name="relief">GTK_RELIEF_NORMAL</property>
-                                <property name="focus_on_click">True</property>
-                                <property name="active">False</property>
-                                <property name="inconsistent">False</property>
                                 <property name="draw_indicator">True</property>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
                                 <property name="expand">False</property>
                                 <property name="fill">False</property>
+                                <property name="position">1</property>
                               </packing>
                             </child>
                           </object>
                         </child>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
-                        <property name="expand">True</property>
-                        <property name="fill">True</property>
+                        <property name="position">1</property>
                       </packing>
                     </child>
                   </object>
                   <packing>
-                    <property name="padding">0</property>
                     <property name="expand">False</property>
-                    <property name="fill">True</property>
+                    <property name="position">2</property>
                   </packing>
                 </child>
               </object>
               <packing>
-                <property name="tab_expand">False</property>
-                <property name="tab_fill">True</property>
+                <property name="position">1</property>
               </packing>
             </child>
             <child type="tab">
-              <object class="GtkLabel" id="label2">
+              <object class="GtkLabel" id="label3">
                 <property name="visible">True</property>
                 <property name="label" translatable="yes">Behavior</property>
-                <property name="use_underline">False</property>
-                <property name="use_markup">False</property>
-                <property name="justify">GTK_JUSTIFY_LEFT</property>
-                <property name="wrap">False</property>
-                <property name="selectable">False</property>
-                <property name="xalign">0.5</property>
-                <property name="yalign">0.5</property>
-                <property name="xpad">0</property>
-                <property name="ypad">0</property>
-                <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                <property name="width_chars">-1</property>
-                <property name="single_line_mode">False</property>
-                <property name="angle">0</property>
               </object>
+              <packing>
+                <property name="position">1</property>
+                <property name="tab_fill">False</property>
+              </packing>
             </child>
             <child>
               <object class="GtkVBox" id="vbox26">
-                <property name="border_width">12</property>
                 <property name="visible">True</property>
-                <property name="homogeneous">False</property>
+                <property name="border_width">12</property>
                 <property name="spacing">18</property>
                 <child>
                   <object class="GtkVBox" id="vbox27">
                     <property name="visible">True</property>
-                    <property name="homogeneous">False</property>
                     <property name="spacing">6</property>
                     <child>
                       <object class="GtkLabel" id="label28">
                         <property name="visible">True</property>
+                        <property name="xalign">0</property>
                         <property name="label" translatable="yes">&lt;b&gt;Icon Captions&lt;/b&gt;</property>
-                        <property name="use_underline">False</property>
                         <property name="use_markup">True</property>
-                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                        <property name="wrap">False</property>
-                        <property name="selectable">False</property>
-                        <property name="xalign">0</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xpad">0</property>
-                        <property name="ypad">0</property>
-                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                        <property name="width_chars">-1</property>
-                        <property name="single_line_mode">False</property>
-                        <property name="angle">0</property>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
                         <property name="expand">False</property>
                         <property name="fill">False</property>
+                        <property name="position">0</property>
                       </packing>
                     </child>
                     <child>
                       <object class="GtkAlignment" id="alignment8">
                         <property name="visible">True</property>
-                        <property name="xalign">0.5</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xscale">1</property>
-                        <property name="yscale">1</property>
-                        <property name="top_padding">0</property>
-                        <property name="bottom_padding">0</property>
                         <property name="left_padding">12</property>
-                        <property name="right_padding">0</property>
                         <child>
                           <object class="GtkVBox" id="vbox28">
                             <property name="visible">True</property>
-                            <property name="homogeneous">False</property>
                             <property name="spacing">6</property>
                             <child>
                               <object class="GtkLabel" id="label29">
                                 <property name="visible">True</property>
+                                <property name="xalign">0</property>
                                 <property name="label" translatable="yes">Choose the order of information to appear beneath icon names. More information will appear when zooming in closer.</property>
-                                <property name="use_underline">False</property>
-                                <property name="use_markup">False</property>
-                                <property name="justify">GTK_JUSTIFY_LEFT</property>
                                 <property name="wrap">True</property>
-                                <property name="selectable">False</property>
-                                <property name="xalign">0</property>
-                                <property name="yalign">0.5</property>
-                                <property name="xpad">0</property>
-                                <property name="ypad">0</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                <property name="width_chars">-1</property>
-                                <property name="single_line_mode">False</property>
-                                <property name="angle">0</property>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
                                 <property name="expand">False</property>
                                 <property name="fill">False</property>
+                                <property name="position">0</property>
                               </packing>
                             </child>
                             <child>
                               <object class="GtkHBox" id="hbox28">
                                 <property name="visible">True</property>
-                                <property name="homogeneous">False</property>
-                                <property name="spacing">0</property>
                                 <child>
                                   <object class="GtkLabel" id="captions_label_0">
                                     <property name="visible">True</property>
-                                    <property name="label"/>
-                                    <property name="use_underline">False</property>
-                                    <property name="use_markup">False</property>
-                                    <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                    <property name="wrap">False</property>
-                                    <property name="selectable">False</property>
-                                    <property name="xalign">0.5</property>
-                                    <property name="yalign">0.5</property>
-                                    <property name="xpad">0</property>
-                                    <property name="ypad">0</property>
-                                    <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                    <property name="width_chars">-1</property>
-                                    <property name="single_line_mode">False</property>
-                                    <property name="angle">0</property>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
                                     <property name="expand">False</property>
                                     <property name="fill">False</property>
+                                    <property name="position">0</property>
                                   </packing>
                                 </child>
                                 <child>
                                   <object class="GtkComboBox" id="captions_0_combobox">
                                     <property name="visible">True</property>
-                                    <property name="add_tearoffs">False</property>
-                                    <property name="focus_on_click">True</property>
                                     <property name="model">model11</property>
                                     <child>
                                       <object class="GtkCellRendererText" id="renderer"/>
@@ -1543,52 +1094,32 @@
                                     </child>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
                                     <property name="expand">False</property>
-                                    <property name="fill">True</property>
+                                    <property name="position">1</property>
                                   </packing>
                                 </child>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
-                                <property name="expand">True</property>
-                                <property name="fill">True</property>
+                                <property name="position">1</property>
                               </packing>
                             </child>
                             <child>
                               <object class="GtkHBox" id="hbox29">
                                 <property name="visible">True</property>
-                                <property name="homogeneous">False</property>
-                                <property name="spacing">0</property>
                                 <child>
                                   <object class="GtkLabel" id="captions_label_1">
                                     <property name="visible">True</property>
-                                    <property name="label"/>
                                     <property name="use_underline">True</property>
-                                    <property name="use_markup">False</property>
-                                    <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                    <property name="wrap">False</property>
-                                    <property name="selectable">False</property>
-                                    <property name="xalign">0.5</property>
-                                    <property name="yalign">0.5</property>
-                                    <property name="xpad">0</property>
-                                    <property name="ypad">0</property>
-                                    <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                    <property name="width_chars">-1</property>
-                                    <property name="single_line_mode">False</property>
-                                    <property name="angle">0</property>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
                                     <property name="expand">False</property>
                                     <property name="fill">False</property>
+                                    <property name="position">0</property>
                                   </packing>
                                 </child>
                                 <child>
                                   <object class="GtkComboBox" id="captions_1_combobox">
                                     <property name="visible">True</property>
-                                    <property name="add_tearoffs">False</property>
-                                    <property name="focus_on_click">True</property>
                                     <property name="model">model12</property>
                                     <child>
                                       <object class="GtkCellRendererText" id="renderer12"/>
@@ -1598,52 +1129,33 @@
                                     </child>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
                                     <property name="expand">False</property>
-                                    <property name="fill">True</property>
+                                    <property name="position">1</property>
                                   </packing>
                                 </child>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
                                 <property name="expand">False</property>
                                 <property name="fill">False</property>
+                                <property name="position">2</property>
                               </packing>
                             </child>
                             <child>
                               <object class="GtkHBox" id="hbox30">
                                 <property name="visible">True</property>
-                                <property name="homogeneous">False</property>
-                                <property name="spacing">0</property>
                                 <child>
                                   <object class="GtkLabel" id="captions_label_2">
                                     <property name="visible">True</property>
-                                    <property name="label"/>
-                                    <property name="use_underline">False</property>
-                                    <property name="use_markup">False</property>
-                                    <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                    <property name="wrap">False</property>
-                                    <property name="selectable">False</property>
-                                    <property name="xalign">0.5</property>
-                                    <property name="yalign">0.5</property>
-                                    <property name="xpad">0</property>
-                                    <property name="ypad">0</property>
-                                    <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                    <property name="width_chars">-1</property>
-                                    <property name="single_line_mode">False</property>
-                                    <property name="angle">0</property>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
                                     <property name="expand">False</property>
                                     <property name="fill">False</property>
+                                    <property name="position">0</property>
                                   </packing>
                                 </child>
                                 <child>
                                   <object class="GtkComboBox" id="captions_2_combobox">
                                     <property name="visible">True</property>
-                                    <property name="add_tearoffs">False</property>
-                                    <property name="focus_on_click">True</property>
                                     <property name="model">model13</property>
                                     <child>
                                       <object class="GtkCellRendererText" id="renderer13"/>
@@ -1653,109 +1165,69 @@
                                     </child>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
                                     <property name="expand">False</property>
-                                    <property name="fill">True</property>
+                                    <property name="position">1</property>
                                   </packing>
                                 </child>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
-                                <property name="expand">True</property>
-                                <property name="fill">True</property>
+                                <property name="position">3</property>
                               </packing>
                             </child>
                           </object>
                         </child>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
-                        <property name="expand">True</property>
-                        <property name="fill">True</property>
+                        <property name="position">1</property>
                       </packing>
                     </child>
                   </object>
                   <packing>
-                    <property name="padding">0</property>
                     <property name="expand">False</property>
-                    <property name="fill">True</property>
+                    <property name="position">0</property>
                   </packing>
                 </child>
                 <child>
                   <object class="GtkVBox" id="vbox31">
                     <property name="visible">True</property>
-                    <property name="homogeneous">False</property>
                     <property name="spacing">6</property>
                     <child>
                       <object class="GtkLabel" id="label34">
                         <property name="visible">True</property>
+                        <property name="xalign">0</property>
                         <property name="label" translatable="yes">&lt;b&gt;Date&lt;/b&gt;</property>
-                        <property name="use_underline">False</property>
                         <property name="use_markup">True</property>
-                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                        <property name="wrap">False</property>
-                        <property name="selectable">False</property>
-                        <property name="xalign">0</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xpad">0</property>
-                        <property name="ypad">0</property>
-                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                        <property name="width_chars">-1</property>
-                        <property name="single_line_mode">False</property>
-                        <property name="angle">0</property>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
                         <property name="expand">False</property>
                         <property name="fill">False</property>
+                        <property name="position">0</property>
                       </packing>
                     </child>
                     <child>
                       <object class="GtkAlignment" id="alignment9">
                         <property name="visible">True</property>
-                        <property name="xalign">0.5</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xscale">1</property>
-                        <property name="yscale">1</property>
-                        <property name="top_padding">0</property>
-                        <property name="bottom_padding">0</property>
                         <property name="left_padding">12</property>
-                        <property name="right_padding">0</property>
                         <child>
                           <object class="GtkHBox" id="hbox33">
                             <property name="visible">True</property>
-                            <property name="homogeneous">False</property>
                             <property name="spacing">12</property>
                             <child>
                               <object class="GtkLabel" id="label36">
                                 <property name="visible">True</property>
                                 <property name="label" translatable="yes">_Format:</property>
                                 <property name="use_underline">True</property>
-                                <property name="use_markup">False</property>
-                                <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                <property name="wrap">False</property>
-                                <property name="selectable">False</property>
-                                <property name="xalign">0.5</property>
-                                <property name="yalign">0.5</property>
-                                <property name="xpad">0</property>
-                                <property name="ypad">0</property>
                                 <property name="mnemonic_widget">date_format_combobox</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                <property name="width_chars">-1</property>
-                                <property name="single_line_mode">False</property>
-                                <property name="angle">0</property>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
                                 <property name="expand">False</property>
                                 <property name="fill">False</property>
+                                <property name="position">0</property>
                               </packing>
                             </child>
                             <child>
                               <object class="GtkComboBox" id="date_format_combobox">
                                 <property name="visible">True</property>
-                                <property name="add_tearoffs">False</property>
-                                <property name="focus_on_click">True</property>
                                 <property name="model">model14</property>
                                 <child>
                                   <object class="GtkCellRendererText" id="renderer14"/>
@@ -1765,125 +1237,80 @@
                                 </child>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
                                 <property name="expand">False</property>
                                 <property name="fill">False</property>
+                                <property name="position">1</property>
                               </packing>
                             </child>
                           </object>
                         </child>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
-                        <property name="expand">True</property>
-                        <property name="fill">True</property>
+                        <property name="position">1</property>
                       </packing>
                     </child>
                   </object>
                   <packing>
-                    <property name="padding">0</property>
                     <property name="expand">False</property>
-                    <property name="fill">True</property>
+                    <property name="position">1</property>
                   </packing>
                 </child>
               </object>
               <packing>
-                <property name="tab_expand">False</property>
-                <property name="tab_fill">True</property>
+                <property name="position">2</property>
               </packing>
             </child>
             <child type="tab">
               <object class="GtkLabel" id="label24">
                 <property name="visible">True</property>
                 <property name="label" translatable="yes">Display</property>
-                <property name="use_underline">False</property>
-                <property name="use_markup">False</property>
-                <property name="justify">GTK_JUSTIFY_LEFT</property>
-                <property name="wrap">False</property>
-                <property name="selectable">False</property>
-                <property name="xalign">0.5</property>
-                <property name="yalign">0.5</property>
-                <property name="xpad">0</property>
-                <property name="ypad">0</property>
-                <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                <property name="width_chars">-1</property>
-                <property name="single_line_mode">False</property>
-                <property name="angle">0</property>
               </object>
+              <packing>
+                <property name="position">2</property>
+                <property name="tab_fill">False</property>
+              </packing>
             </child>
             <child>
               <object class="GtkVBox" id="vbox29">
-                <property name="border_width">12</property>
                 <property name="visible">True</property>
-                <property name="homogeneous">False</property>
+                <property name="border_width">12</property>
                 <property name="spacing">18</property>
                 <child>
                   <object class="GtkVBox" id="vbox30">
                     <property name="visible">True</property>
-                    <property name="homogeneous">False</property>
                     <property name="spacing">6</property>
                     <child>
                       <object class="GtkLabel" id="label31">
                         <property name="visible">True</property>
+                        <property name="xalign">0</property>
                         <property name="label" translatable="yes">&lt;b&gt;List Columns&lt;/b&gt;</property>
-                        <property name="use_underline">False</property>
                         <property name="use_markup">True</property>
-                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                        <property name="wrap">False</property>
-                        <property name="selectable">False</property>
-                        <property name="xalign">0</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xpad">0</property>
-                        <property name="ypad">0</property>
-                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                        <property name="width_chars">-1</property>
-                        <property name="single_line_mode">False</property>
-                        <property name="angle">0</property>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
                         <property name="expand">False</property>
                         <property name="fill">False</property>
+                        <property name="position">0</property>
                       </packing>
                     </child>
                     <child>
                       <object class="GtkAlignment" id="alignment21">
                         <property name="visible">True</property>
-                        <property name="xalign">0.5</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xscale">1</property>
-                        <property name="yscale">1</property>
-                        <property name="top_padding">0</property>
-                        <property name="bottom_padding">0</property>
                         <property name="left_padding">12</property>
-                        <property name="right_padding">0</property>
                         <child>
                           <object class="GtkVBox" id="list_columns_vbox">
                             <property name="visible">True</property>
-                            <property name="homogeneous">False</property>
                             <property name="spacing">6</property>
                             <child>
                               <object class="GtkLabel" id="label33">
                                 <property name="visible">True</property>
+                                <property name="xalign">0</property>
                                 <property name="label" translatable="yes">Choose the order of information to appear in the list view.</property>
-                                <property name="use_underline">False</property>
-                                <property name="use_markup">False</property>
-                                <property name="justify">GTK_JUSTIFY_LEFT</property>
                                 <property name="wrap">True</property>
-                                <property name="selectable">False</property>
-                                <property name="xalign">0</property>
-                                <property name="yalign">0.5</property>
-                                <property name="xpad">0</property>
-                                <property name="ypad">0</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                <property name="width_chars">-1</property>
-                                <property name="single_line_mode">False</property>
-                                <property name="angle">0</property>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
                                 <property name="expand">False</property>
                                 <property name="fill">False</property>
+                                <property name="position">0</property>
                               </packing>
                             </child>
                             <child>
@@ -1893,129 +1320,80 @@
                         </child>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
-                        <property name="expand">True</property>
-                        <property name="fill">True</property>
+                        <property name="position">1</property>
                       </packing>
                     </child>
                   </object>
                   <packing>
-                    <property name="padding">0</property>
-                    <property name="expand">True</property>
-                    <property name="fill">True</property>
+                    <property name="position">0</property>
                   </packing>
                 </child>
               </object>
               <packing>
-                <property name="tab_expand">False</property>
-                <property name="tab_fill">True</property>
+                <property name="position">3</property>
               </packing>
             </child>
             <child type="tab">
               <object class="GtkLabel" id="label30">
                 <property name="visible">True</property>
                 <property name="label" translatable="yes">List Columns</property>
-                <property name="use_underline">False</property>
-                <property name="use_markup">False</property>
-                <property name="justify">GTK_JUSTIFY_LEFT</property>
-                <property name="wrap">False</property>
-                <property name="selectable">False</property>
-                <property name="xalign">0.5</property>
-                <property name="yalign">0.5</property>
-                <property name="xpad">0</property>
-                <property name="ypad">0</property>
-                <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                <property name="width_chars">-1</property>
-                <property name="single_line_mode">False</property>
-                <property name="angle">0</property>
               </object>
+              <packing>
+                <property name="position">3</property>
+                <property name="tab_fill">False</property>
+              </packing>
             </child>
             <child>
               <object class="GtkVBox" id="vbox9">
-                <property name="border_width">12</property>
                 <property name="visible">True</property>
-                <property name="homogeneous">False</property>
+                <property name="border_width">12</property>
                 <property name="spacing">18</property>
                 <child>
                   <object class="GtkVBox" id="vbox10">
                     <property name="visible">True</property>
-                    <property name="homogeneous">False</property>
                     <property name="spacing">6</property>
                     <child>
                       <object class="GtkLabel" id="label16">
                         <property name="visible">True</property>
+                        <property name="xalign">0</property>
                         <property name="label" translatable="yes">&lt;b&gt;Text Files&lt;/b&gt;</property>
-                        <property name="use_underline">False</property>
                         <property name="use_markup">True</property>
-                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                        <property name="wrap">False</property>
-                        <property name="selectable">False</property>
-                        <property name="xalign">0</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xpad">0</property>
-                        <property name="ypad">0</property>
-                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                        <property name="width_chars">-1</property>
-                        <property name="single_line_mode">False</property>
-                        <property name="angle">0</property>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
                         <property name="expand">False</property>
                         <property name="fill">False</property>
+                        <property name="position">0</property>
                       </packing>
                     </child>
                     <child>
                       <object class="GtkAlignment" id="alignment10">
                         <property name="visible">True</property>
-                        <property name="xalign">0.5</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xscale">1</property>
-                        <property name="yscale">1</property>
-                        <property name="top_padding">0</property>
-                        <property name="bottom_padding">0</property>
                         <property name="left_padding">12</property>
-                        <property name="right_padding">0</property>
                         <child>
                           <object class="GtkVBox" id="vbox20">
                             <property name="visible">True</property>
-                            <property name="homogeneous">False</property>
                             <property name="spacing">6</property>
                             <child>
                               <object class="GtkHBox" id="hbox24">
                                 <property name="visible">True</property>
-                                <property name="homogeneous">False</property>
                                 <property name="spacing">12</property>
                                 <child>
                                   <object class="GtkLabel" id="preview_label_0">
                                     <property name="visible">True</property>
+                                    <property name="xalign">0</property>
                                     <property name="label" translatable="yes">Show te_xt in icons:</property>
                                     <property name="use_underline">True</property>
-                                    <property name="use_markup">False</property>
-                                    <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                    <property name="wrap">False</property>
-                                    <property name="selectable">False</property>
-                                    <property name="xalign">0</property>
-                                    <property name="yalign">0.5</property>
-                                    <property name="xpad">0</property>
-                                    <property name="ypad">0</property>
                                     <property name="mnemonic_widget">preview_text_combobox</property>
-                                    <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                    <property name="width_chars">-1</property>
-                                    <property name="single_line_mode">False</property>
-                                    <property name="angle">0</property>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
                                     <property name="expand">False</property>
                                     <property name="fill">False</property>
+                                    <property name="position">0</property>
                                   </packing>
                                 </child>
                                 <child>
                                   <object class="GtkComboBox" id="preview_text_combobox">
                                     <property name="visible">True</property>
-                                    <property name="add_tearoffs">False</property>
-                                    <property name="focus_on_click">True</property>
                                     <property name="model">model6</property>
                                     <child>
                                       <object class="GtkCellRendererText" id="renderer6"/>
@@ -2025,114 +1403,73 @@
                                     </child>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
-                                    <property name="expand">True</property>
-                                    <property name="fill">True</property>
+                                    <property name="position">1</property>
                                   </packing>
                                 </child>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
-                                <property name="expand">True</property>
-                                <property name="fill">True</property>
+                                <property name="position">0</property>
                               </packing>
                             </child>
                           </object>
                         </child>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
-                        <property name="expand">True</property>
-                        <property name="fill">True</property>
+                        <property name="position">1</property>
                       </packing>
                     </child>
                   </object>
                   <packing>
-                    <property name="padding">0</property>
                     <property name="expand">False</property>
-                    <property name="fill">True</property>
+                    <property name="position">0</property>
                   </packing>
                 </child>
                 <child>
                   <object class="GtkVBox" id="vbox11">
                     <property name="visible">True</property>
-                    <property name="homogeneous">False</property>
                     <property name="spacing">6</property>
                     <child>
                       <object class="GtkLabel" id="label18">
                         <property name="visible">True</property>
+                        <property name="xalign">0</property>
                         <property name="label" translatable="yes">&lt;b&gt;Other Previewable Files&lt;/b&gt;</property>
-                        <property name="use_underline">False</property>
                         <property name="use_markup">True</property>
-                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                        <property name="wrap">False</property>
-                        <property name="selectable">False</property>
-                        <property name="xalign">0</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xpad">0</property>
-                        <property name="ypad">0</property>
-                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                        <property name="width_chars">-1</property>
-                        <property name="single_line_mode">False</property>
-                        <property name="angle">0</property>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
                         <property name="expand">False</property>
                         <property name="fill">False</property>
+                        <property name="position">0</property>
                       </packing>
                     </child>
                     <child>
                       <object class="GtkAlignment" id="alignment11">
                         <property name="visible">True</property>
-                        <property name="xalign">0.5</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xscale">1</property>
-                        <property name="yscale">1</property>
-                        <property name="top_padding">0</property>
-                        <property name="bottom_padding">0</property>
                         <property name="left_padding">12</property>
-                        <property name="right_padding">0</property>
                         <child>
                           <object class="GtkVBox" id="vbox21">
                             <property name="visible">True</property>
-                            <property name="homogeneous">False</property>
                             <property name="spacing">6</property>
                             <child>
                               <object class="GtkHBox" id="hbox20">
                                 <property name="visible">True</property>
-                                <property name="homogeneous">False</property>
                                 <property name="spacing">12</property>
                                 <child>
                                   <object class="GtkLabel" id="preview_label_1">
                                     <property name="visible">True</property>
+                                    <property name="xalign">0</property>
                                     <property name="label" translatable="yes">Show _thumbnails:</property>
                                     <property name="use_underline">True</property>
-                                    <property name="use_markup">False</property>
-                                    <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                    <property name="wrap">False</property>
-                                    <property name="selectable">False</property>
-                                    <property name="xalign">0</property>
-                                    <property name="yalign">0.5</property>
-                                    <property name="xpad">0</property>
-                                    <property name="ypad">0</property>
                                     <property name="mnemonic_widget">preview_image_combobox</property>
-                                    <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                    <property name="width_chars">-1</property>
-                                    <property name="single_line_mode">False</property>
-                                    <property name="angle">0</property>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
                                     <property name="expand">False</property>
                                     <property name="fill">False</property>
+                                    <property name="position">0</property>
                                   </packing>
                                 </child>
                                 <child>
                                   <object class="GtkComboBox" id="preview_image_combobox">
                                     <property name="visible">True</property>
-                                    <property name="add_tearoffs">False</property>
-                                    <property name="focus_on_click">True</property>
                                     <property name="model">model7</property>
                                     <child>
                                       <object class="GtkCellRendererText" id="renderer7"/>
@@ -2142,53 +1479,35 @@
                                     </child>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
-                                    <property name="expand">True</property>
-                                    <property name="fill">True</property>
+                                    <property name="position">1</property>
                                   </packing>
                                 </child>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
-                                <property name="expand">True</property>
-                                <property name="fill">True</property>
+                                <property name="position">0</property>
                               </packing>
                             </child>
                             <child>
                               <object class="GtkHBox" id="hbox21">
                                 <property name="visible">True</property>
-                                <property name="homogeneous">False</property>
                                 <property name="spacing">12</property>
                                 <child>
                                   <object class="GtkLabel" id="preview_label_2">
                                     <property name="visible">True</property>
+                                    <property name="xalign">0</property>
                                     <property name="label" translatable="yes">_Only for files smaller than:</property>
                                     <property name="use_underline">True</property>
-                                    <property name="use_markup">False</property>
-                                    <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                    <property name="wrap">False</property>
-                                    <property name="selectable">False</property>
-                                    <property name="xalign">0</property>
-                                    <property name="yalign">0.5</property>
-                                    <property name="xpad">0</property>
-                                    <property name="ypad">0</property>
                                     <property name="mnemonic_widget">preview_image_size_combobox</property>
-                                    <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                    <property name="width_chars">-1</property>
-                                    <property name="single_line_mode">False</property>
-                                    <property name="angle">0</property>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
                                     <property name="expand">False</property>
                                     <property name="fill">False</property>
+                                    <property name="position">0</property>
                                   </packing>
                                 </child>
                                 <child>
                                   <object class="GtkComboBox" id="preview_image_size_combobox">
                                     <property name="visible">True</property>
-                                    <property name="add_tearoffs">False</property>
-                                    <property name="focus_on_click">True</property>
                                     <property name="model">model8</property>
                                     <child>
                                       <object class="GtkCellRendererText" id="renderer8"/>
@@ -2198,114 +1517,73 @@
                                     </child>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
-                                    <property name="expand">True</property>
-                                    <property name="fill">True</property>
+                                    <property name="position">1</property>
                                   </packing>
                                 </child>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
-                                <property name="expand">True</property>
-                                <property name="fill">True</property>
+                                <property name="position">1</property>
                               </packing>
                             </child>
                           </object>
                         </child>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
-                        <property name="expand">True</property>
-                        <property name="fill">True</property>
+                        <property name="position">1</property>
                       </packing>
                     </child>
                   </object>
                   <packing>
-                    <property name="padding">0</property>
                     <property name="expand">False</property>
-                    <property name="fill">True</property>
+                    <property name="position">1</property>
                   </packing>
                 </child>
                 <child>
                   <object class="GtkVBox" id="vbox12">
                     <property name="visible">True</property>
-                    <property name="homogeneous">False</property>
                     <property name="spacing">6</property>
                     <child>
                       <object class="GtkLabel" id="label20">
                         <property name="visible">True</property>
+                        <property name="xalign">0</property>
                         <property name="label" translatable="yes">&lt;b&gt;Sound Files&lt;/b&gt;</property>
-                        <property name="use_underline">False</property>
                         <property name="use_markup">True</property>
-                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                        <property name="wrap">False</property>
-                        <property name="selectable">False</property>
-                        <property name="xalign">0</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xpad">0</property>
-                        <property name="ypad">0</property>
-                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                        <property name="width_chars">-1</property>
-                        <property name="single_line_mode">False</property>
-                        <property name="angle">0</property>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
                         <property name="expand">False</property>
                         <property name="fill">False</property>
+                        <property name="position">0</property>
                       </packing>
                     </child>
                     <child>
                       <object class="GtkAlignment" id="alignment12">
                         <property name="visible">True</property>
-                        <property name="xalign">0.5</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xscale">1</property>
-                        <property name="yscale">1</property>
-                        <property name="top_padding">0</property>
-                        <property name="bottom_padding">0</property>
                         <property name="left_padding">12</property>
-                        <property name="right_padding">0</property>
                         <child>
                           <object class="GtkVBox" id="vbox22">
                             <property name="visible">True</property>
-                            <property name="homogeneous">False</property>
                             <property name="spacing">6</property>
                             <child>
                               <object class="GtkHBox" id="hbox22">
                                 <property name="visible">True</property>
-                                <property name="homogeneous">False</property>
                                 <property name="spacing">12</property>
                                 <child>
                                   <object class="GtkLabel" id="preview_label_3">
                                     <property name="visible">True</property>
+                                    <property name="xalign">0</property>
                                     <property name="label" translatable="yes">Preview _sound files:</property>
                                     <property name="use_underline">True</property>
-                                    <property name="use_markup">False</property>
-                                    <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                    <property name="wrap">False</property>
-                                    <property name="selectable">False</property>
-                                    <property name="xalign">0</property>
-                                    <property name="yalign">0.5</property>
-                                    <property name="xpad">0</property>
-                                    <property name="ypad">0</property>
                                     <property name="mnemonic_widget">preview_sound_combobox</property>
-                                    <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                    <property name="width_chars">-1</property>
-                                    <property name="single_line_mode">False</property>
-                                    <property name="angle">0</property>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
                                     <property name="expand">False</property>
                                     <property name="fill">False</property>
+                                    <property name="position">0</property>
                                   </packing>
                                 </child>
                                 <child>
                                   <object class="GtkComboBox" id="preview_sound_combobox">
                                     <property name="visible">True</property>
-                                    <property name="add_tearoffs">False</property>
-                                    <property name="focus_on_click">True</property>
                                     <property name="model">model9</property>
                                     <child>
                                       <object class="GtkCellRendererText" id="renderer9"/>
@@ -2315,114 +1593,73 @@
                                     </child>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
-                                    <property name="expand">True</property>
-                                    <property name="fill">True</property>
+                                    <property name="position">1</property>
                                   </packing>
                                 </child>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
-                                <property name="expand">True</property>
-                                <property name="fill">True</property>
+                                <property name="position">0</property>
                               </packing>
                             </child>
                           </object>
                         </child>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
-                        <property name="expand">True</property>
-                        <property name="fill">True</property>
+                        <property name="position">1</property>
                       </packing>
                     </child>
                   </object>
                   <packing>
-                    <property name="padding">0</property>
                     <property name="expand">False</property>
-                    <property name="fill">True</property>
+                    <property name="position">2</property>
                   </packing>
                 </child>
                 <child>
                   <object class="GtkVBox" id="vbox13">
                     <property name="visible">True</property>
-                    <property name="homogeneous">False</property>
                     <property name="spacing">6</property>
                     <child>
                       <object class="GtkLabel" id="label22">
                         <property name="visible">True</property>
+                        <property name="xalign">0</property>
                         <property name="label" translatable="yes">&lt;b&gt;Folders&lt;/b&gt;</property>
-                        <property name="use_underline">False</property>
                         <property name="use_markup">True</property>
-                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                        <property name="wrap">False</property>
-                        <property name="selectable">False</property>
-                        <property name="xalign">0</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xpad">0</property>
-                        <property name="ypad">0</property>
-                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                        <property name="width_chars">-1</property>
-                        <property name="single_line_mode">False</property>
-                        <property name="angle">0</property>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
                         <property name="expand">False</property>
                         <property name="fill">False</property>
+                        <property name="position">0</property>
                       </packing>
                     </child>
                     <child>
                       <object class="GtkAlignment" id="alignment13">
                         <property name="visible">True</property>
-                        <property name="xalign">0.5</property>
-                        <property name="yalign">0.5</property>
-                        <property name="xscale">1</property>
-                        <property name="yscale">1</property>
-                        <property name="top_padding">0</property>
-                        <property name="bottom_padding">0</property>
                         <property name="left_padding">12</property>
-                        <property name="right_padding">0</property>
                         <child>
                           <object class="GtkVBox" id="vbox23">
                             <property name="visible">True</property>
-                            <property name="homogeneous">False</property>
                             <property name="spacing">6</property>
                             <child>
                               <object class="GtkHBox" id="hbox23">
                                 <property name="visible">True</property>
-                                <property name="homogeneous">False</property>
                                 <property name="spacing">12</property>
                                 <child>
                                   <object class="GtkLabel" id="preview_label_4">
                                     <property name="visible">True</property>
+                                    <property name="xalign">0</property>
                                     <property name="label" translatable="yes">Count _number of items:</property>
                                     <property name="use_underline">True</property>
-                                    <property name="use_markup">False</property>
-                                    <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                    <property name="wrap">False</property>
-                                    <property name="selectable">False</property>
-                                    <property name="xalign">0</property>
-                                    <property name="yalign">0.5</property>
-                                    <property name="xpad">0</property>
-                                    <property name="ypad">0</property>
                                     <property name="mnemonic_widget">preview_folder_combobox</property>
-                                    <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                    <property name="width_chars">-1</property>
-                                    <property name="single_line_mode">False</property>
-                                    <property name="angle">0</property>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
                                     <property name="expand">False</property>
                                     <property name="fill">False</property>
+                                    <property name="position">0</property>
                                   </packing>
                                 </child>
                                 <child>
                                   <object class="GtkComboBox" id="preview_folder_combobox">
                                     <property name="visible">True</property>
-                                    <property name="add_tearoffs">False</property>
-                                    <property name="focus_on_click">True</property>
                                     <property name="model">model10</property>
                                     <child>
                                       <object class="GtkCellRendererText" id="renderer10"/>
@@ -2432,137 +1669,100 @@
                                     </child>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
-                                    <property name="expand">True</property>
-                                    <property name="fill">True</property>
+                                    <property name="position">1</property>
                                   </packing>
                                 </child>
                               </object>
                               <packing>
-                                <property name="padding">0</property>
-                                <property name="expand">True</property>
-                                <property name="fill">True</property>
+                                <property name="position">0</property>
+                              </packing>
+                            </child>
+                            <child>
+                              <object class="GtkCheckButton" id="time_slider_enabled_checkbutton">
+                                <property name="label" translatable="yes" comments="SUN_BRANDING">Visualize ZFS snapshots timeline</property>
+                                <property name="visible">True</property>
+                                <property name="can_focus">True</property>
+                                <property name="receives_default">False</property>
+                                <property name="draw_indicator">True</property>
+                              </object>
+                              <packing>
+                                <property name="position">1</property>
                               </packing>
                             </child>
                           </object>
                         </child>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
-                        <property name="expand">True</property>
-                        <property name="fill">True</property>
+                        <property name="position">1</property>
                       </packing>
                     </child>
                   </object>
                   <packing>
-                    <property name="padding">0</property>
                     <property name="expand">False</property>
-                    <property name="fill">True</property>
+                    <property name="position">3</property>
                   </packing>
                 </child>
               </object>
               <packing>
-                <property name="tab_expand">False</property>
-                <property name="tab_fill">True</property>
+                <property name="position">4</property>
               </packing>
             </child>
             <child type="tab">
-              <object class="GtkLabel" id="label3">
+              <object class="GtkLabel" id="label7">
                 <property name="visible">True</property>
                 <property name="label" translatable="yes">Preview</property>
-                <property name="use_underline">False</property>
-                <property name="use_markup">False</property>
-                <property name="justify">GTK_JUSTIFY_LEFT</property>
-                <property name="wrap">False</property>
-                <property name="selectable">False</property>
-                <property name="xalign">0.5</property>
-                <property name="yalign">0.5</property>
-                <property name="xpad">0</property>
-                <property name="ypad">0</property>
-                <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                <property name="width_chars">-1</property>
-                <property name="single_line_mode">False</property>
-                <property name="angle">0</property>
               </object>
+              <packing>
+                <property name="position">4</property>
+                <property name="tab_fill">False</property>
+              </packing>
             </child>
             <child>
               <object class="GtkVBox" id="vbox34">
-                <property name="border_width">12</property>
                 <property name="visible">True</property>
-                <property name="homogeneous">False</property>
+                <property name="border_width">12</property>
                 <property name="spacing">6</property>
                 <child>
                   <object class="GtkVBox" id="media_handling_vbox">
                     <property name="visible">True</property>
-                    <property name="homogeneous">False</property>
                     <property name="spacing">6</property>
                     <child>
                       <object class="GtkVBox" id="vbox44">
                         <property name="visible">True</property>
-                        <property name="homogeneous">False</property>
                         <property name="spacing">6</property>
                         <child>
                           <object class="GtkLabel" id="label42">
                             <property name="visible">True</property>
+                            <property name="xalign">0</property>
                             <property name="label" translatable="yes">&lt;b&gt;Media Handling&lt;/b&gt;</property>
-                            <property name="use_underline">False</property>
                             <property name="use_markup">True</property>
-                            <property name="justify">GTK_JUSTIFY_LEFT</property>
-                            <property name="wrap">False</property>
-                            <property name="selectable">False</property>
-                            <property name="xalign">0</property>
-                            <property name="yalign">0.5</property>
-                            <property name="xpad">0</property>
-                            <property name="ypad">0</property>
-                            <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                            <property name="width_chars">-1</property>
-                            <property name="single_line_mode">False</property>
-                            <property name="angle">0</property>
                           </object>
                           <packing>
-                            <property name="padding">0</property>
                             <property name="expand">False</property>
                             <property name="fill">False</property>
+                            <property name="position">0</property>
                           </packing>
                         </child>
                         <child>
                           <object class="GtkAlignment" id="alignment18">
                             <property name="visible">True</property>
-                            <property name="xalign">0.5</property>
-                            <property name="yalign">0.5</property>
-                            <property name="xscale">1</property>
-                            <property name="yscale">1</property>
-                            <property name="top_padding">0</property>
-                            <property name="bottom_padding">0</property>
                             <property name="left_padding">12</property>
-                            <property name="right_padding">0</property>
                             <child>
                               <object class="GtkVBox" id="vbox52">
                                 <property name="visible">True</property>
-                                <property name="homogeneous">False</property>
                                 <property name="spacing">6</property>
                                 <child>
                                   <object class="GtkLabel" id="label60">
                                     <property name="visible">True</property>
+                                    <property name="xalign">0</property>
                                     <property name="label" translatable="yes">Choose what happens when inserting media or connecting devices to the system</property>
-                                    <property name="use_underline">False</property>
                                     <property name="use_markup">True</property>
-                                    <property name="justify">GTK_JUSTIFY_LEFT</property>
                                     <property name="wrap">True</property>
-                                    <property name="selectable">False</property>
-                                    <property name="xalign">0</property>
-                                    <property name="yalign">0.5</property>
-                                    <property name="xpad">0</property>
-                                    <property name="ypad">0</property>
-                                    <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                    <property name="width_chars">-1</property>
-                                    <property name="single_line_mode">False</property>
-                                    <property name="angle">0</property>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
                                     <property name="expand">False</property>
                                     <property name="fill">False</property>
+                                    <property name="position">0</property>
                                   </packing>
                                 </child>
                                 <child>
@@ -2570,313 +1770,197 @@
                                     <property name="visible">True</property>
                                     <property name="n_rows">5</property>
                                     <property name="n_columns">2</property>
-                                    <property name="homogeneous">False</property>
-                                    <property name="row_spacing">6</property>
                                     <property name="column_spacing">6</property>
+                                    <property name="row_spacing">6</property>
                                     <child>
                                       <object class="GtkLabel" id="label44">
                                         <property name="visible">True</property>
+                                        <property name="xalign">0</property>
                                         <property name="label" translatable="yes">CD _Audio:</property>
                                         <property name="use_underline">True</property>
-                                        <property name="use_markup">False</property>
-                                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                        <property name="wrap">False</property>
-                                        <property name="selectable">False</property>
-                                        <property name="xalign">0</property>
-                                        <property name="yalign">0.5</property>
-                                        <property name="xpad">0</property>
-                                        <property name="ypad">0</property>
                                         <property name="mnemonic_widget">media_audio_cdda_combobox</property>
-                                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                        <property name="width_chars">-1</property>
-                                        <property name="single_line_mode">False</property>
-                                        <property name="angle">0</property>
                                       </object>
                                       <packing>
-                                        <property name="left_attach">0</property>
-                                        <property name="right_attach">1</property>
-                                        <property name="top_attach">0</property>
-                                        <property name="bottom_attach">1</property>
-                                        <property name="x_options">fill</property>
-                                        <property name="y_options"/>
+                                        <property name="x_options">GTK_FILL</property>
+                                        <property name="y_options"></property>
                                       </packing>
                                     </child>
                                     <child>
                                       <object class="GtkLabel" id="label50">
                                         <property name="visible">True</property>
+                                        <property name="xalign">0</property>
                                         <property name="label" translatable="yes">_DVD Video:</property>
                                         <property name="use_underline">True</property>
-                                        <property name="use_markup">False</property>
-                                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                        <property name="wrap">False</property>
-                                        <property name="selectable">False</property>
-                                        <property name="xalign">0</property>
-                                        <property name="yalign">0.5</property>
-                                        <property name="xpad">0</property>
-                                        <property name="ypad">0</property>
                                         <property name="mnemonic_widget">media_video_dvd_combobox</property>
-                                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                        <property name="width_chars">-1</property>
-                                        <property name="single_line_mode">False</property>
-                                        <property name="angle">0</property>
                                       </object>
                                       <packing>
-                                        <property name="left_attach">0</property>
-                                        <property name="right_attach">1</property>
                                         <property name="top_attach">1</property>
                                         <property name="bottom_attach">2</property>
-                                        <property name="x_options">fill</property>
-                                        <property name="y_options"/>
+                                        <property name="x_options">GTK_FILL</property>
+                                        <property name="y_options"></property>
                                       </packing>
                                     </child>
                                     <child>
                                       <object class="GtkComboBox" id="media_audio_cdda_combobox">
                                         <property name="visible">True</property>
-                                        <property name="add_tearoffs">False</property>
-                                        <property name="focus_on_click">True</property>
                                       </object>
                                       <packing>
                                         <property name="left_attach">1</property>
                                         <property name="right_attach">2</property>
-                                        <property name="top_attach">0</property>
-                                        <property name="bottom_attach">1</property>
-                                        <property name="y_options">fill</property>
+                                        <property name="y_options">GTK_FILL</property>
                                       </packing>
                                     </child>
                                     <child>
                                       <object class="GtkComboBox" id="media_video_dvd_combobox">
                                         <property name="visible">True</property>
-                                        <property name="add_tearoffs">False</property>
-                                        <property name="focus_on_click">True</property>
                                       </object>
                                       <packing>
                                         <property name="left_attach">1</property>
                                         <property name="right_attach">2</property>
                                         <property name="top_attach">1</property>
                                         <property name="bottom_attach">2</property>
-                                        <property name="x_options">fill</property>
-                                        <property name="y_options">fill</property>
+                                        <property name="x_options">GTK_FILL</property>
+                                        <property name="y_options">GTK_FILL</property>
                                       </packing>
                                     </child>
                                     <child>
                                       <object class="GtkLabel" id="label54">
                                         <property name="visible">True</property>
+                                        <property name="xalign">0</property>
                                         <property name="label" translatable="yes">_Music Player:</property>
                                         <property name="use_underline">True</property>
-                                        <property name="use_markup">False</property>
-                                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                        <property name="wrap">False</property>
-                                        <property name="selectable">False</property>
-                                        <property name="xalign">0</property>
-                                        <property name="yalign">0.5</property>
-                                        <property name="xpad">0</property>
-                                        <property name="ypad">0</property>
                                         <property name="mnemonic_widget">media_music_player_combobox</property>
-                                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                        <property name="width_chars">-1</property>
-                                        <property name="single_line_mode">False</property>
-                                        <property name="angle">0</property>
                                       </object>
                                       <packing>
-                                        <property name="left_attach">0</property>
-                                        <property name="right_attach">1</property>
                                         <property name="top_attach">2</property>
                                         <property name="bottom_attach">3</property>
-                                        <property name="x_options">fill</property>
-                                        <property name="y_options"/>
+                                        <property name="x_options">GTK_FILL</property>
+                                        <property name="y_options"></property>
                                       </packing>
                                     </child>
                                     <child>
                                       <object class="GtkComboBox" id="media_music_player_combobox">
                                         <property name="visible">True</property>
-                                        <property name="add_tearoffs">False</property>
-                                        <property name="focus_on_click">True</property>
                                       </object>
                                       <packing>
                                         <property name="left_attach">1</property>
                                         <property name="right_attach">2</property>
                                         <property name="top_attach">2</property>
                                         <property name="bottom_attach">3</property>
-                                        <property name="x_options">fill</property>
-                                        <property name="y_options">fill</property>
+                                        <property name="x_options">GTK_FILL</property>
+                                        <property name="y_options">GTK_FILL</property>
                                       </packing>
                                     </child>
                                     <child>
                                       <object class="GtkLabel" id="label59">
                                         <property name="visible">True</property>
+                                        <property name="xalign">0</property>
                                         <property name="label" translatable="yes">_Photos:</property>
                                         <property name="use_underline">True</property>
-                                        <property name="use_markup">False</property>
-                                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                        <property name="wrap">False</property>
-                                        <property name="selectable">False</property>
-                                        <property name="xalign">0</property>
-                                        <property name="yalign">0.5</property>
-                                        <property name="xpad">0</property>
-                                        <property name="ypad">0</property>
                                         <property name="mnemonic_widget">media_dcf_combobox</property>
-                                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                        <property name="width_chars">-1</property>
-                                        <property name="single_line_mode">False</property>
-                                        <property name="angle">0</property>
                                       </object>
                                       <packing>
-                                        <property name="left_attach">0</property>
-                                        <property name="right_attach">1</property>
                                         <property name="top_attach">3</property>
                                         <property name="bottom_attach">4</property>
-                                        <property name="x_options">fill</property>
-                                        <property name="y_options"/>
+                                        <property name="x_options">GTK_FILL</property>
+                                        <property name="y_options"></property>
                                       </packing>
                                     </child>
                                     <child>
                                       <object class="GtkComboBox" id="media_dcf_combobox">
                                         <property name="visible">True</property>
-                                        <property name="add_tearoffs">False</property>
-                                        <property name="focus_on_click">True</property>
                                       </object>
                                       <packing>
                                         <property name="left_attach">1</property>
                                         <property name="right_attach">2</property>
                                         <property name="top_attach">3</property>
                                         <property name="bottom_attach">4</property>
-                                        <property name="x_options">fill</property>
-                                        <property name="y_options">fill</property>
+                                        <property name="x_options">GTK_FILL</property>
+                                        <property name="y_options">GTK_FILL</property>
                                       </packing>
                                     </child>
                                     <child>
                                       <object class="GtkLabel" id="label57">
                                         <property name="visible">True</property>
+                                        <property name="xalign">0</property>
                                         <property name="label" translatable="yes">_Software:</property>
                                         <property name="use_underline">True</property>
-                                        <property name="use_markup">False</property>
-                                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                        <property name="wrap">False</property>
-                                        <property name="selectable">False</property>
-                                        <property name="xalign">0</property>
-                                        <property name="yalign">0.5</property>
-                                        <property name="xpad">0</property>
-                                        <property name="ypad">0</property>
                                         <property name="mnemonic_widget">media_software_combobox</property>
-                                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                        <property name="width_chars">-1</property>
-                                        <property name="single_line_mode">False</property>
-                                        <property name="angle">0</property>
                                       </object>
                                       <packing>
-                                        <property name="left_attach">0</property>
-                                        <property name="right_attach">1</property>
                                         <property name="top_attach">4</property>
                                         <property name="bottom_attach">5</property>
-                                        <property name="x_options">fill</property>
-                                        <property name="y_options"/>
+                                        <property name="x_options">GTK_FILL</property>
+                                        <property name="y_options"></property>
                                       </packing>
                                     </child>
                                     <child>
                                       <object class="GtkComboBox" id="media_software_combobox">
                                         <property name="visible">True</property>
-                                        <property name="add_tearoffs">False</property>
-                                        <property name="focus_on_click">True</property>
                                       </object>
                                       <packing>
                                         <property name="left_attach">1</property>
                                         <property name="right_attach">2</property>
                                         <property name="top_attach">4</property>
                                         <property name="bottom_attach">5</property>
-                                        <property name="x_options">fill</property>
-                                        <property name="y_options">fill</property>
+                                        <property name="x_options">GTK_FILL</property>
+                                        <property name="y_options">GTK_FILL</property>
                                       </packing>
                                     </child>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
-                                    <property name="expand">True</property>
-                                    <property name="fill">True</property>
+                                    <property name="position">1</property>
                                   </packing>
                                 </child>
                               </object>
                             </child>
                           </object>
                           <packing>
-                            <property name="padding">0</property>
-                            <property name="expand">True</property>
-                            <property name="fill">True</property>
+                            <property name="position">1</property>
                           </packing>
                         </child>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
-                        <property name="expand">True</property>
-                        <property name="fill">True</property>
+                        <property name="position">0</property>
                       </packing>
                     </child>
                     <child>
                       <object class="GtkVBox" id="vbox50">
                         <property name="visible">True</property>
-                        <property name="homogeneous">False</property>
                         <property name="spacing">6</property>
                         <child>
                           <object class="GtkLabel" id="label61">
                             <property name="visible">True</property>
+                            <property name="xalign">0</property>
                             <property name="label" translatable="yes">&lt;b&gt;Other Media&lt;/b&gt;</property>
-                            <property name="use_underline">False</property>
                             <property name="use_markup">True</property>
-                            <property name="justify">GTK_JUSTIFY_LEFT</property>
-                            <property name="wrap">False</property>
-                            <property name="selectable">False</property>
-                            <property name="xalign">0</property>
-                            <property name="yalign">0.5</property>
-                            <property name="xpad">0</property>
-                            <property name="ypad">0</property>
-                            <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                            <property name="width_chars">-1</property>
-                            <property name="single_line_mode">False</property>
-                            <property name="angle">0</property>
                           </object>
                           <packing>
-                            <property name="padding">0</property>
                             <property name="expand">False</property>
                             <property name="fill">False</property>
+                            <property name="position">0</property>
                           </packing>
                         </child>
                         <child>
                           <object class="GtkAlignment" id="alignment20">
                             <property name="visible">True</property>
-                            <property name="xalign">0.5</property>
-                            <property name="yalign">0.5</property>
-                            <property name="xscale">1</property>
-                            <property name="yscale">1</property>
-                            <property name="top_padding">0</property>
-                            <property name="bottom_padding">0</property>
                             <property name="left_padding">12</property>
-                            <property name="right_padding">0</property>
                             <child>
                               <object class="GtkVBox" id="vbox51">
                                 <property name="visible">True</property>
-                                <property name="homogeneous">False</property>
                                 <property name="spacing">6</property>
                                 <child>
                                   <object class="GtkLabel" id="label65">
                                     <property name="visible">True</property>
+                                    <property name="xalign">0</property>
                                     <property name="label" translatable="yes">Less common media formats can be configured here</property>
-                                    <property name="use_underline">False</property>
                                     <property name="use_markup">True</property>
-                                    <property name="justify">GTK_JUSTIFY_LEFT</property>
                                     <property name="wrap">True</property>
-                                    <property name="selectable">False</property>
-                                    <property name="xalign">0</property>
-                                    <property name="yalign">0.5</property>
-                                    <property name="xpad">0</property>
-                                    <property name="ypad">0</property>
-                                    <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                    <property name="width_chars">-1</property>
-                                    <property name="single_line_mode">False</property>
-                                    <property name="angle">0</property>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
                                     <property name="expand">False</property>
                                     <property name="fill">False</property>
+                                    <property name="position">0</property>
                                   </packing>
                                 </child>
                                 <child>
@@ -2884,190 +1968,172 @@
                                     <property name="visible">True</property>
                                     <property name="n_rows">2</property>
                                     <property name="n_columns">2</property>
-                                    <property name="homogeneous">False</property>
-                                    <property name="row_spacing">6</property>
                                     <property name="column_spacing">6</property>
+                                    <property name="row_spacing">6</property>
                                     <child>
                                       <object class="GtkComboBox" id="media_other_type_combobox">
                                         <property name="visible">True</property>
-                                        <property name="add_tearoffs">False</property>
-                                        <property name="focus_on_click">True</property>
                                       </object>
                                       <packing>
                                         <property name="left_attach">1</property>
                                         <property name="right_attach">2</property>
-                                        <property name="top_attach">0</property>
-                                        <property name="bottom_attach">1</property>
-                                        <property name="y_options">fill</property>
+                                        <property name="y_options">GTK_FILL</property>
                                       </packing>
                                     </child>
                                     <child>
                                       <object class="GtkLabel" id="label64">
                                         <property name="visible">True</property>
+                                        <property name="xalign">0</property>
                                         <property name="label" translatable="yes">Acti_on:</property>
                                         <property name="use_underline">True</property>
-                                        <property name="use_markup">False</property>
-                                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                        <property name="wrap">False</property>
-                                        <property name="selectable">False</property>
-                                        <property name="xalign">0</property>
-                                        <property name="yalign">0.5</property>
-                                        <property name="xpad">0</property>
-                                        <property name="ypad">0</property>
                                         <property name="mnemonic_widget">media_other_action_combobox</property>
-                                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                        <property name="width_chars">-1</property>
-                                        <property name="single_line_mode">False</property>
-                                        <property name="angle">0</property>
                                       </object>
                                       <packing>
-                                        <property name="left_attach">0</property>
-                                        <property name="right_attach">1</property>
                                         <property name="top_attach">1</property>
                                         <property name="bottom_attach">2</property>
-                                        <property name="x_options">fill</property>
-                                        <property name="y_options"/>
+                                        <property name="x_options">GTK_FILL</property>
+                                        <property name="y_options"></property>
                                       </packing>
                                     </child>
                                     <child>
                                       <object class="GtkComboBox" id="media_other_action_combobox">
                                         <property name="visible">True</property>
-                                        <property name="add_tearoffs">False</property>
-                                        <property name="focus_on_click">True</property>
                                       </object>
                                       <packing>
                                         <property name="left_attach">1</property>
                                         <property name="right_attach">2</property>
                                         <property name="top_attach">1</property>
                                         <property name="bottom_attach">2</property>
-                                        <property name="x_options">fill</property>
-                                        <property name="y_options">fill</property>
+                                        <property name="x_options">GTK_FILL</property>
+                                        <property name="y_options">GTK_FILL</property>
                                       </packing>
                                     </child>
                                     <child>
                                       <object class="GtkLabel" id="label63">
                                         <property name="visible">True</property>
+                                        <property name="xalign">0</property>
                                         <property name="label" translatable="yes">_Type:</property>
                                         <property name="use_underline">True</property>
-                                        <property name="use_markup">False</property>
-                                        <property name="justify">GTK_JUSTIFY_LEFT</property>
-                                        <property name="wrap">False</property>
-                                        <property name="selectable">False</property>
-                                        <property name="xalign">0</property>
-                                        <property name="yalign">0.5</property>
-                                        <property name="xpad">0</property>
-                                        <property name="ypad">0</property>
                                         <property name="mnemonic_widget">media_other_type_combobox</property>
-                                        <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                                        <property name="width_chars">-1</property>
-                                        <property name="single_line_mode">False</property>
-                                        <property name="angle">0</property>
                                       </object>
                                       <packing>
-                                        <property name="left_attach">0</property>
-                                        <property name="right_attach">1</property>
-                                        <property name="top_attach">0</property>
-                                        <property name="bottom_attach">1</property>
-                                        <property name="x_options">fill</property>
-                                        <property name="y_options"/>
+                                        <property name="x_options">GTK_FILL</property>
+                                        <property name="y_options"></property>
                                       </packing>
                                     </child>
                                   </object>
                                   <packing>
-                                    <property name="padding">0</property>
-                                    <property name="expand">True</property>
-                                    <property name="fill">True</property>
+                                    <property name="position">1</property>
                                   </packing>
                                 </child>
                               </object>
                             </child>
                           </object>
                           <packing>
-                            <property name="padding">0</property>
-                            <property name="expand">True</property>
-                            <property name="fill">True</property>
+                            <property name="position">1</property>
                           </packing>
                         </child>
                       </object>
                       <packing>
-                        <property name="padding">0</property>
-                        <property name="expand">True</property>
-                        <property name="fill">True</property>
+                        <property name="position">1</property>
                       </packing>
                     </child>
                   </object>
                   <packing>
-                    <property name="padding">0</property>
                     <property name="expand">False</property>
                     <property name="fill">False</property>
+                    <property name="position">0</property>
                   </packing>
                 </child>
                 <child>
                   <object class="GtkCheckButton" id="media_autorun_never_checkbutton">
+                    <property name="label" translatable="yes">_Never prompt or start programs on media insertion</property>
                     <property name="visible">True</property>
                     <property name="can_focus">True</property>
-                    <property name="label" translatable="yes">_Never prompt or start programs on media insertion</property>
+                    <property name="receives_default">False</property>
                     <property name="use_underline">True</property>
-                    <property name="relief">GTK_RELIEF_NORMAL</property>
-                    <property name="focus_on_click">True</property>
-                    <property name="active">False</property>
-                    <property name="inconsistent">False</property>
                     <property name="draw_indicator">True</property>
                   </object>
                   <packing>
-                    <property name="padding">0</property>
                     <property name="expand">False</property>
                     <property name="fill">False</property>
+                    <property name="position">1</property>
                   </packing>
                 </child>
                 <child>
                   <object class="GtkCheckButton" id="media_automount_open_checkbutton">
+                    <property name="label" translatable="yes">B_rowse media when inserted</property>
                     <property name="visible">True</property>
                     <property name="can_focus">True</property>
-                    <property name="label" translatable="yes">B_rowse media when inserted</property>
+                    <property name="receives_default">False</property>
                     <property name="use_underline">True</property>
-                    <property name="relief">GTK_RELIEF_NORMAL</property>
-                    <property name="focus_on_click">True</property>
-                    <property name="active">False</property>
-                    <property name="inconsistent">False</property>
                     <property name="draw_indicator">True</property>
                   </object>
                   <packing>
-                    <property name="padding">0</property>
                     <property name="expand">False</property>
                     <property name="fill">False</property>
+                    <property name="position">2</property>
                   </packing>
                 </child>
               </object>
               <packing>
-                <property name="tab_expand">False</property>
-                <property name="tab_fill">True</property>
+                <property name="position">5</property>
               </packing>
             </child>
             <child type="tab">
               <object class="GtkLabel" id="label38">
                 <property name="visible">True</property>
                 <property name="label" translatable="yes">Media</property>
-                <property name="use_underline">False</property>
-                <property name="use_markup">False</property>
-                <property name="justify">GTK_JUSTIFY_LEFT</property>
-                <property name="wrap">False</property>
-                <property name="selectable">False</property>
-                <property name="xalign">0.5</property>
-                <property name="yalign">0.5</property>
-                <property name="xpad">0</property>
-                <property name="ypad">0</property>
-                <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
-                <property name="width_chars">-1</property>
-                <property name="single_line_mode">False</property>
-                <property name="angle">0</property>
               </object>
+              <packing>
+                <property name="position">5</property>
+                <property name="tab_fill">False</property>
+              </packing>
+            </child>
+          </object>
+          <packing>
+            <property name="position">1</property>
+          </packing>
+        </child>
+        <child internal-child="action_area">
+          <object class="GtkHButtonBox" id="dialog-action_area1">
+            <property name="visible">True</property>
+            <property name="layout_style">end</property>
+            <child>
+              <object class="GtkButton" id="helpbutton1">
+                <property name="label">gtk-help</property>
+                <property name="visible">True</property>
+                <property name="can_focus">True</property>
+                <property name="can_default">True</property>
+                <property name="receives_default">False</property>
+                <property name="use_stock">True</property>
+              </object>
+              <packing>
+                <property name="expand">False</property>
+                <property name="fill">False</property>
+                <property name="position">0</property>
+              </packing>
+            </child>
+            <child>
+              <object class="GtkButton" id="closebutton1">
+                <property name="label">gtk-close</property>
+                <property name="visible">True</property>
+                <property name="can_focus">True</property>
+                <property name="can_default">True</property>
+                <property name="receives_default">False</property>
+                <property name="use_stock">True</property>
+              </object>
+              <packing>
+                <property name="expand">False</property>
+                <property name="fill">False</property>
+                <property name="position">1</property>
+              </packing>
             </child>
           </object>
           <packing>
-            <property name="padding">0</property>
-            <property name="expand">True</property>
-            <property name="fill">True</property>
+            <property name="expand">False</property>
+            <property name="pack_type">end</property>
+            <property name="position">0</property>
           </packing>
         </child>
       </object>
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/nautilus-navigation-window-ui.xml nautilus-2.26.2/src/nautilus-navigation-window-ui.xml
--- ../nautilus-2.26.2/src/nautilus-navigation-window-ui.xml	2009-04-15 16:04:23.845568380 +0200
+++ nautilus-2.26.2/src/nautilus-navigation-window-ui.xml	2009-04-15 16:04:45.704363182 +0200
@@ -67,6 +67,7 @@
 	<toolitem name="Up" action="Up"/>
 	<toolitem name="Stop" action="Stop"/>
 	<toolitem name="Reload" action="Reload"/>
+	<toolitem name="Restore" action="Restore"/>
 	<separator/>
 	<toolitem name="Home" action="Home"/>
 	<toolitem name="Computer" action="Go to Computer"/>
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/nautilus-navigation-window.c nautilus-2.26.2/src/nautilus-navigation-window.c
--- ../nautilus-2.26.2/src/nautilus-navigation-window.c	2009-04-15 16:04:23.840695721 +0200
+++ nautilus-2.26.2/src/nautilus-navigation-window.c	2009-04-15 16:04:45.706127487 +0200
@@ -43,6 +43,7 @@
 #include "nautilus-notebook.h"
 #include "nautilus-window-manage-views.h"
 #include "nautilus-zoom-control.h"
+#include "nautilus-zfs-bar.h"
 #include <eel/eel-gtk-extensions.h>
 #include <eel/eel-gtk-macros.h>
 #include <eel/eel-string.h>
@@ -334,6 +335,66 @@ notebook_button_press_cb (GtkWidget *wid
 	return FALSE;
 }
 
+static void 
+restore_pref_changed (NautilusWindow *window)
+{
+  g_assert (NAUTILUS_IS_WINDOW (window));
+  nautilus_window_reload (window);
+}
+
+void nautilus_navigation_window_set_restore_icon (NautilusNavigationWindow* window,
+						  NautilusNavigationRestoreIconType type)
+{
+  static gboolean init = 0;
+  static GdkPixbuf *normal = NULL;
+  static GdkPixbuf *search = NULL;
+  static GdkPixbuf *no = NULL;
+  GdkPixbuf *pb = NULL;
+  GtkWidget *image = NULL;
+  GtkAction* action = gtk_ui_manager_get_action (nautilus_window_get_ui_manager (NAUTILUS_WINDOW (window)), "/Toolbar/Restore");
+
+  if (!init)
+    {
+      char *path = nautilus_pixmap_file ("restore.png");
+      normal = gdk_pixbuf_new_from_file (path, NULL);
+      g_free (path);
+      path = nautilus_pixmap_file ("restore-search.png");
+      search = gdk_pixbuf_new_from_file (path, NULL);
+      g_free (path);
+      path = nautilus_pixmap_file ("restore-no.png");
+      no = gdk_pixbuf_new_from_file (path, NULL);
+      g_free (path);
+      init = TRUE;
+    }
+
+  switch (type) {
+    case RESTORE_NORMAL :
+      pb = normal;
+      break;
+    case RESTORE_SEARCH:
+      pb = search;
+      break;
+    case RESTORE_NO:
+      pb = no;
+      break;
+  }
+  
+  image = gtk_image_new_from_pixbuf (pb); 
+  gtk_widget_ref (image);
+  gtk_widget_show (image);
+  GSList *tmp = gtk_action_get_proxies (action);
+  for (tmp; tmp ; tmp = tmp->next)
+    {
+      GtkWidget *proxy = (GtkWidget *)tmp->data;
+      if (GTK_IS_TOOL_BUTTON (proxy))
+	gtk_tool_button_set_icon_widget (GTK_TOOL_BUTTON (proxy), image);
+    }
+}
+
+
+
+
+
 static void
 nautilus_navigation_window_init (NautilusNavigationWindow *window)
 {
@@ -350,7 +411,7 @@ nautilus_navigation_window_init (Nautilu
 	gtk_table_attach (GTK_TABLE (NAUTILUS_WINDOW (window)->details->table),
 			  window->details->content_paned,
 			  /* X direction */                   /* Y direction */
-			  0, 1,                               3, 4,
+			  0, 1,                               4, 5,
 			  GTK_EXPAND | GTK_FILL | GTK_SHRINK, GTK_EXPAND | GTK_FILL | GTK_SHRINK,
 			  0,                                  0);
 	gtk_widget_show (window->details->content_paned);
@@ -383,6 +444,16 @@ nautilus_navigation_window_init (Nautilu
 	
 	ui_manager = nautilus_window_get_ui_manager (NAUTILUS_WINDOW (window));
 	toolbar = gtk_ui_manager_get_widget (ui_manager, "/Toolbar");
+
+	  { /* add custom icon */
+
+	    nautilus_navigation_window_set_restore_icon (window, RESTORE_SEARCH);
+	    /* add preference callback */
+	    eel_preferences_add_callback (NAUTILUS_PREFERENCES_ENABLE_TIME_SLIDER,
+					  (EelPreferencesCallback) restore_pref_changed,
+					  (gpointer) window);
+	  }
+
 	window->details->toolbar = toolbar;
 	gtk_table_attach (GTK_TABLE (NAUTILUS_WINDOW (window)->details->table),
 			  toolbar,
@@ -503,6 +574,15 @@ nautilus_navigation_window_init (Nautilu
 			  GTK_EXPAND | GTK_FILL | GTK_SHRINK,  0,
 			  0,                                   0);
 
+	window->zfs_bar = nautilus_zfs_bar_new ();
+	
+	gtk_table_attach (GTK_TABLE (NAUTILUS_WINDOW (window)->details->table),
+			  window->zfs_bar,
+			  /* X direction */                    /* Y direction */
+			  0, 1,                                3, 4,
+			  GTK_EXPAND | GTK_FILL | GTK_SHRINK,  0,
+			  0,                                   0);
+
 	eel_preferences_add_callback_while_alive (NAUTILUS_PREFERENCES_ALWAYS_USE_LOCATION_ENTRY,
 						  always_use_location_entry_changed,
 						  window, G_OBJECT (window));
@@ -1612,6 +1692,17 @@ nautilus_navigation_window_show_location
 	}
 }
 
+gboolean 
+nautilus_navigation_window_zfs_bar_showing (NautilusNavigationWindow *window)
+{
+  g_return_val_if_fail (NAUTILUS_IS_NAVIGATION_WINDOW (window), FALSE);
+
+  if (window->zfs_bar != NULL) 
+    return GTK_WIDGET_VISIBLE (window->zfs_bar);
+  return FALSE;
+}
+
+
 gboolean
 nautilus_navigation_window_location_bar_showing (NautilusNavigationWindow *window)
 {
@@ -1907,6 +1998,7 @@ nautilus_navigation_window_save_geometry
 static void
 real_window_close (NautilusWindow *window)
 {
+	nautilus_zfs_bar_cancel_tasks (window);
 	nautilus_navigation_window_save_geometry (NAUTILUS_NAVIGATION_WINDOW (window));
 }
 
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/nautilus-navigation-window.h nautilus-2.26.2/src/nautilus-navigation-window.h
--- ../nautilus-2.26.2/src/nautilus-navigation-window.h	2009-04-15 16:04:23.844652154 +0200
+++ nautilus-2.26.2/src/nautilus-navigation-window.h	2009-04-15 16:04:45.706749781 +0200
@@ -62,6 +62,7 @@ struct _NautilusNavigationWindow {
 	GtkWidget *path_bar;
         GtkWidget *search_bar;
 	GtkWidget *notebook;
+	GtkWidget *zfs_bar;
 
         /* Current views stuff */
         GList *sidebar_panels;
@@ -70,6 +71,11 @@ struct _NautilusNavigationWindow {
         GtkWidget *zoom_control;
 };
 
+typedef enum {
+  RESTORE_NORMAL,
+  RESTORE_SEARCH,
+  RESTORE_NO
+} NautilusNavigationRestoreIconType;
 
 struct _NautilusNavigationWindowClass {
         NautilusWindowClass parent_spot;
@@ -96,6 +102,9 @@ gboolean nautilus_navigation_window_path
 gboolean nautilus_navigation_window_search_bar_showing 	 (NautilusNavigationWindow *window);
 
 gboolean nautilus_navigation_window_location_bar_showing (NautilusNavigationWindow *window);
+gboolean nautilus_navigation_window_zfs_bar_showing	 (NautilusNavigationWindow *window);
+void	 nautilus_navigation_window_set_restore_icon	 (NautilusNavigationWindow* window,
+							  NautilusNavigationRestoreIconType type);
 void     nautilus_navigation_window_hide_toolbar         (NautilusNavigationWindow *window);
 void     nautilus_navigation_window_show_toolbar         (NautilusNavigationWindow *window);
 gboolean nautilus_navigation_window_toolbar_showing      (NautilusNavigationWindow *window);
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/nautilus-shell-ui.xml nautilus-2.26.2/src/nautilus-shell-ui.xml
--- ../nautilus-2.26.2/src/nautilus-shell-ui.xml	2009-04-15 16:04:23.847912085 +0200
+++ nautilus-2.26.2/src/nautilus-shell-ui.xml	2009-04-15 16:04:45.707138024 +0200
@@ -41,6 +41,7 @@
 	<menu action="View">
 		<menuitem name="Stop" action="Stop"/>
 		<menuitem name="Reload" action="Reload"/>
+		<menuitem name="Restore" action="Restore"/>
 		<separator/>
 		<placeholder name="Show Hide Placeholder"/>
 		<separator/>
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/nautilus-window-manage-views.c nautilus-2.26.2/src/nautilus-window-manage-views.c
--- ../nautilus-2.26.2/src/nautilus-window-manage-views.c	2009-04-15 16:04:23.839745940 +0200
+++ nautilus-2.26.2/src/nautilus-window-manage-views.c	2009-04-15 16:04:45.709060075 +0200
@@ -40,6 +40,7 @@
 #include "nautilus-trash-bar.h"
 #include "nautilus-x-content-bar.h"
 #include "nautilus-zoom-control.h"
+#include "nautilus-zfs-bar.h"
 #include <eel/eel-accessibility.h>
 #include <eel/eel-debug.h>
 #include <eel/eel-gdk-extensions.h>
@@ -51,6 +52,7 @@
 #include <gtk/gtk.h>
 #include <gdk/gdkx.h>
 #include <glib/gi18n.h>
+#include <stdlib.h>
 #include <libnautilus-extension/nautilus-location-widget-provider.h>
 #include <libnautilus-private/nautilus-debug-log.h>
 #include <libnautilus-private/nautilus-file-attributes.h>
@@ -617,9 +619,7 @@ nautilus_window_slot_open_location_full 
         if ((!do_load_location) ||
 	    (target_window == window && target_slot == slot &&
 	     old_location && g_file_equal (old_location, location))) {
-		if (old_location) {
-			g_object_unref (old_location);
-		}
+		g_object_unref (old_location);
                 return;
         }
 	
@@ -802,6 +802,7 @@ begin_location_change (NautilusWindowSlo
         NautilusFile *file;
 	gboolean force_reload;
         char *current_pos;
+	GFile *old_file = NULL;
 
 	g_assert (slot != NULL);
         g_assert (location != NULL);
@@ -815,11 +816,46 @@ begin_location_change (NautilusWindowSlo
 
 	end_location_change (slot);
 
+	old_file = nautilus_window_slot_get_location (slot);
+
+	if (old_file)
+	  {
+	    directory = nautilus_directory_get (old_file);
+	    if (directory)
+	      {
+		nautilus_directory_cancel_restore_info (directory);
+		g_object_unref (directory);
+		directory = NULL;
+	      }
+	    g_object_unref (old_file);
+	    old_file = NULL;
+	  }
+
 	nautilus_window_slot_set_allow_stop (slot, TRUE);
 	nautilus_window_slot_set_status (slot, " ");
 
 	g_assert (slot->pending_location == NULL);
 	g_assert (slot->pending_selection == NULL);
+        
+	directory = nautilus_directory_get (location);
+
+	/* if snap and (ts is enabled and displayed )
+	 *  check if the directory exist 
+	 *    if it doesn't move to the next available one */
+	if (nautilus_directory_is_in_snapshot (directory) && is_time_slider_enabled ())
+	  {
+	    if (GTK_WIDGET_VISIBLE (GTK_WIDGET (NAUTILUS_NAVIGATION_WINDOW (window)->zfs_bar)))
+	      {
+		char *path = g_file_get_path (location);
+		if (!g_file_test (path, G_FILE_TEST_IS_DIR))
+		  {
+		    nautilus_zfs_bar_remove_and_skip_snap (NAUTILUS_ZFS_BAR (NAUTILUS_NAVIGATION_WINDOW (window)->zfs_bar), path);
+		    g_free (path);
+		    return;
+		  }
+		g_free (path);
+	      }
+	  }
 	
 	slot->pending_location = g_object_ref (location);
         slot->location_change_type = type;
@@ -829,7 +865,6 @@ begin_location_change (NautilusWindowSlo
 
 	slot->pending_scroll_to = g_strdup (scroll_pos);
         
-        directory = nautilus_directory_get (location);
 
 	/* The code to force a reload is here because if we do it
 	 * after determining an initial view (in the components), then
@@ -1073,8 +1108,15 @@ got_file_info_for_view_selection_callbac
 		/* If fallback, don't use view from metadata */
 		if (slot->location_change_type != NAUTILUS_LOCATION_CHANGE_FALLBACK) {
 			/* Look in metadata for view */
-			view_id = nautilus_file_get_metadata 
-				(file, NAUTILUS_METADATA_KEY_DEFAULT_COMPONENT, NULL);
+		    if (nautilus_file_is_in_snapshot (file))
+		      {
+			NautilusDirectory* root_dir = nautilus_zfs_bar_get_dir (NAUTILUS_ZFS_BAR (NAUTILUS_NAVIGATION_WINDOW (window)->zfs_bar));
+			view_id = nautilus_file_get_metadata (nautilus_directory_get_corresponding_file (root_dir), NAUTILUS_METADATA_KEY_DEFAULT_COMPONENT, NULL);
+		      }
+		    if (view_id == NULL) 
+		      view_id = nautilus_file_get_metadata
+			  (file, NAUTILUS_METADATA_KEY_DEFAULT_COMPONENT, NULL);
+
 			if (view_id != NULL && 
 			    !nautilus_view_factory_view_supports_uri (view_id,
 								      location,
@@ -1635,6 +1677,28 @@ update_for_new_location (NautilusWindowS
 		/* Load menus from nautilus extensions for this location */
 		nautilus_window_load_extension_menus (window);
 	}
+		
+	/* time slider pref can be just enabled so we need 
+	 * to rescan for snapshots */
+	directory = nautilus_directory_get (slot->location);
+
+	if (NAUTILUS_IS_NAVIGATION_WINDOW (window))
+	  {
+	    if (slot->find_zfs_snapshots_cancellable != NULL)
+	      {
+		g_cancellable_cancel (slot->find_zfs_snapshots_cancellable);
+		slot->find_zfs_snapshots_cancellable = NULL;
+	      }
+	    slot->find_zfs_snapshots_cancellable = g_cancellable_new ();
+	    nautilus_zfs_bar_display (NAUTILUS_ZFS_BAR (NAUTILUS_NAVIGATION_WINDOW (window)->zfs_bar),
+				      window,
+				      directory,
+				      slot->find_zfs_snapshots_cancellable);
+
+	  }
+
+	nautilus_directory_unref (directory);
+
 
 	if (location_really_changed) {
 		nautilus_window_slot_remove_extra_location_widgets (slot);
@@ -1966,12 +2030,20 @@ void
 nautilus_window_slot_stop_loading (NautilusWindowSlot *slot)
 {
 	NautilusWindow *window;
+	NautilusDirectory *directory;
 
 	window = NAUTILUS_WINDOW (slot->window);
 	g_assert (NAUTILUS_IS_WINDOW (window));
 
 	nautilus_view_stop_loading (slot->content_view);
-	
+
+	if (slot->find_zfs_snapshots_cancellable)
+	  g_cancellable_cancel (slot->find_zfs_snapshots_cancellable);
+
+	directory = nautilus_directory_get (slot->location);
+	nautilus_directory_cancel_restore_info (directory);
+	nautilus_directory_unref (directory);
+
 	if (slot->new_content_view != NULL) {
 		window->details->temporarily_ignore_view_signals = TRUE;
 		nautilus_view_stop_loading (slot->new_content_view);
@@ -2033,6 +2105,8 @@ nautilus_window_manage_views_close_slot 
 		nautilus_window_slot_disconnect_content_view (slot, slot->content_view);
 	}
 
+	nautilus_window_slot_stop_loading (slot);
+
 	free_location_change (slot);
 	cancel_viewed_file_changed_callback (slot);
 }
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/nautilus-window-menus.c nautilus-2.26.2/src/nautilus-window-menus.c
--- ../nautilus-2.26.2/src/nautilus-window-menus.c	2009-04-15 16:04:23.849121935 +0200
+++ nautilus-2.26.2/src/nautilus-window-menus.c	2009-04-15 16:04:45.710203281 +0200
@@ -39,6 +39,8 @@
 #include "nautilus-window-private.h"
 #include "nautilus-desktop-window.h"
 #include "nautilus-search-bar.h"
+#include "nautilus-navigation-window.h"
+#include "nautilus-zfs-bar.h"
 #include <gtk/gtk.h>
 #include <gio/gio.h>
 #include <glib/gi18n.h>
@@ -358,6 +360,33 @@ action_reload_callback (GtkAction *actio
 }
 
 static void
+action_restore_callback (GtkToggleAction *action, 
+			gpointer user_data) 
+{
+  NautilusWindowSlot *slot;
+  GFile *directory;
+  NautilusDirectory *n_dir;
+  GtkWidget *bar = NAUTILUS_NAVIGATION_WINDOW (user_data)->zfs_bar;
+
+  slot = nautilus_window_get_active_slot (NAUTILUS_WINDOW (user_data));
+  directory = nautilus_window_slot_get_location (slot);
+  n_dir = nautilus_directory_get (directory);
+
+  if (gtk_toggle_action_get_active (action))
+    {
+      nautilus_zfs_bar_setup (NAUTILUS_ZFS_BAR (bar), n_dir, slot, action); 
+      gtk_widget_show (bar); 
+    }
+  else
+    {
+      nautilus_zfs_bar_hide (NAUTILUS_ZFS_BAR (bar));
+      nautilus_window_reload (NAUTILUS_WINDOW (user_data));
+    }
+  g_object_unref (n_dir);
+  g_object_unref (directory);
+}
+
+static void
 action_zoom_in_callback (GtkAction *action, 
 			 gpointer user_data) 
 {
@@ -860,6 +889,12 @@ static const GtkActionEntry main_entries
 };
 
 static const GtkToggleActionEntry main_toggle_entries[] = {
+  /* name, stock id */         { "Restore", "stock_help",
+  /* SUN_BRANDING */
+  /* label, accelerator */       N_("R_estore"), "<control>E",
+  /* SUN_BRANDING */
+  /* tooltip */                  N_("Browse the current location snapshot history"),
+                                 G_CALLBACK (action_restore_callback) },
   /* name, stock id */         { "Show Hidden Files", NULL,
   /* label, accelerator */       N_("Show _Hidden Files"), "<control>H",
   /* tooltip */                  N_("Toggle the display of hidden files in the current window"),
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/nautilus-window-slot.c nautilus-2.26.2/src/nautilus-window-slot.c
--- ../nautilus-2.26.2/src/nautilus-window-slot.c	2009-04-15 16:04:23.848689333 +0200
+++ nautilus-2.26.2/src/nautilus-window-slot.c	2009-04-15 16:04:45.710769614 +0200
@@ -618,6 +618,13 @@ nautilus_window_slot_dispose (GObject *o
 		slot->find_mount_cancellable = NULL;
 	}
 
+	if (slot->find_zfs_snapshots_cancellable)
+	  {
+	    g_cancellable_cancel (slot->find_zfs_snapshots_cancellable);
+	    g_object_unref (slot->find_zfs_snapshots_cancellable);
+	    slot->find_zfs_snapshots_cancellable = NULL;
+	  }
+
 	slot->window = NULL;
 
 	g_free (slot->title);
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/nautilus-window-slot.h nautilus-2.26.2/src/nautilus-window-slot.h
--- ../nautilus-2.26.2/src/nautilus-window-slot.h	2009-04-15 16:04:23.842472258 +0200
+++ nautilus-2.26.2/src/nautilus-window-slot.h	2009-04-15 16:04:45.711213685 +0200
@@ -108,6 +108,7 @@ struct NautilusWindowSlot {
 	gboolean tried_mount;
 
 	GCancellable *find_mount_cancellable;
+	GCancellable *find_zfs_snapshots_cancellable;
 };
 
 GType   nautilus_window_slot_get_type (void);
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/nautilus-window-toolbars.c nautilus-2.26.2/src/nautilus-window-toolbars.c
--- ../nautilus-2.26.2/src/nautilus-window-toolbars.c	2009-04-15 16:04:23.843472232 +0200
+++ nautilus-2.26.2/src/nautilus-window-toolbars.c	2009-04-15 16:04:45.711688495 +0200
@@ -59,17 +59,37 @@ void
 nautilus_navigation_window_set_throbber_active (NautilusNavigationWindow *window, 
 						gboolean allow)
 {
-	if (( window->details->throbber_active &&  allow) ||
-	    (!window->details->throbber_active && !allow)) {
+      static int counter = 0;
+	/*if (( window->details->throbber_active &&  allow) ||
+	    (!window->details->throbber_active && !allow) {
 		return;
-	}
+	}*/
 
 	window->details->throbber_active = allow;
+
+	/* printf ("\nnautilus_navigation_window_set_throbber_active state %s count before %d ",allow ? "TRUE" : "FALSE", counter);  */
+
 	if (allow) {
-		nautilus_throbber_start (NAUTILUS_THROBBER (window->details->throbber));
+		if (counter == 0)
+		  {
+		    nautilus_throbber_start (NAUTILUS_THROBBER (window->details->throbber));
+		    /* printf (" STARTED "); */
+		  }
+		counter++;
 	} else {
-		nautilus_throbber_stop (NAUTILUS_THROBBER (window->details->throbber));
+		if (counter == 1)
+		  {
+		    nautilus_throbber_stop (NAUTILUS_THROBBER (window->details->throbber));
+		    /* printf (" STOPPED "); */
+		  }
+		counter--;
 	}
+
+	if (counter < 0)
+	  counter = 0;
+	
+	/* printf (" after %d\n", counter);  */
+	/* printstack (fileno(stdout));  */
 }
 
 static void
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/nautilus-window.c nautilus-2.26.2/src/nautilus-window.c
--- ../nautilus-2.26.2/src/nautilus-window.c	2009-04-15 16:04:23.846125779 +0200
+++ nautilus-2.26.2/src/nautilus-window.c	2009-04-15 16:04:45.712928289 +0200
@@ -153,7 +153,7 @@ nautilus_window_init (NautilusWindow *wi
 	/* Set initial window title */
 	gtk_window_set_title (GTK_WINDOW (window), _("Nautilus"));
 
-	table = gtk_table_new (1, 6, FALSE);
+	table = gtk_table_new (1, 7, FALSE);
 	window->details->table = table;
 	gtk_widget_show (table);
 	gtk_container_add (GTK_CONTAINER (window), table);
@@ -175,6 +175,7 @@ nautilus_window_init (NautilusWindow *wi
 	menu = gtk_ui_manager_get_widget (window->details->ui_manager, "/MenuBar");
 	window->details->menubar = menu;
 	gtk_widget_show (menu);
+
 	gtk_table_attach (GTK_TABLE (table),
 			  menu, 
 			  /* X direction */                   /* Y direction */
@@ -314,6 +315,17 @@ nautilus_window_allow_up (NautilusWindow
 			 set_allow_up, (window, allow));
 }
 
+void nautilus_window_allow_restore (NautilusWindow *window, gboolean enable)
+{
+	GtkAction *action;
+	
+        g_assert (NAUTILUS_IS_WINDOW (window));
+
+	action = gtk_action_group_get_action (window->details->main_action_group,
+					      NAUTILUS_ACTION_RESTORE);
+	gtk_action_set_sensitive (action, enable);
+}
+
 static void
 update_cursor (NautilusWindow *window)
 {
@@ -322,7 +334,7 @@ update_cursor (NautilusWindow *window)
 
 	slot = window->details->active_slot;
 
-	if (slot->allow_stop) {
+	if (slot && slot->allow_stop) {
 		cursor = gdk_cursor_new (GDK_WATCH);
 		gdk_window_set_cursor (GTK_WIDGET (window)->window, cursor);
 		gdk_cursor_unref (cursor);
@@ -344,19 +356,29 @@ nautilus_window_sync_allow_stop (Nautilu
 					      NAUTILUS_ACTION_STOP);
 	allow_stop = gtk_action_get_sensitive (action);
 
-	if (slot != window->details->active_slot ||
-	    allow_stop != slot->allow_stop) {
-		if (slot == window->details->active_slot) {
-			gtk_action_set_sensitive (action, slot->allow_stop);
-		}
 
-		if (GTK_WIDGET_REALIZED (GTK_WIDGET (window))) {
-			update_cursor (window);
-		}
+	if (slot != window->details->active_slot ||
+	    allow_stop != slot->allow_stop) 
+	  {
+	    if (slot == window->details->active_slot) 
+	      {
+		if (!slot->allow_stop && slot->find_zfs_snapshots_cancellable != NULL)
+		  { /* if slot want to stop and snap find is finished/cancel then disable */
+		    if (g_cancellable_is_cancelled (slot->find_zfs_snapshots_cancellable))
+		      gtk_action_set_sensitive (action, slot->allow_stop);
+		  }
+		else
+		  gtk_action_set_sensitive (action, slot->allow_stop);
+	      }
+
+	    if (GTK_WIDGET_REALIZED (GTK_WIDGET (window))) {
+	      update_cursor (window);
+	    }
 
-		EEL_CALL_METHOD (NAUTILUS_WINDOW_CLASS, window,
-				 sync_allow_stop, (window, slot));
-	}
+	  }
+	/* moved outside if statement to enable throbber accummulation */
+	EEL_CALL_METHOD (NAUTILUS_WINDOW_CLASS, window,
+			 sync_allow_stop, (window, slot));
 }
 
 void
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/nautilus-window.h nautilus-2.26.2/src/nautilus-window.h
--- ../nautilus-2.26.2/src/nautilus-window.h	2009-04-15 16:04:23.832525592 +0200
+++ nautilus-2.26.2/src/nautilus-window.h	2009-04-15 16:04:45.713356601 +0200
@@ -145,7 +145,8 @@ void             nautilus_window_launch_
 void             nautilus_window_display_error        (NautilusWindow    *window,
                                                        const char        *error_msg);
 void		 nautilus_window_reload		      (NautilusWindow	 *window);
-
+void		 nautilus_window_allow_restore	      (NautilusWindow    *window, 
+						       gboolean           allow);
 void             nautilus_window_allow_reload         (NautilusWindow    *window,
                                                        gboolean           allow);
 void             nautilus_window_allow_up             (NautilusWindow    *window, 
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/nautilus-zfs-bar.c nautilus-2.26.2/src/nautilus-zfs-bar.c
--- ../nautilus-2.26.2/src/nautilus-zfs-bar.c	1970-01-01 01:00:00.000000000 +0100
+++ nautilus-2.26.2/src/nautilus-zfs-bar.c	2009-04-15 16:04:45.714410301 +0200
@@ -0,0 +1,1026 @@
+/* 
+ * Copyright (C) 2008 Sun Microsystems (Erwann Chenede)
+ *
+ */
+
+#include "config.h"
+#include <strings.h>
+#include <glib/gi18n-lib.h>
+#include <gtk/gtk.h>
+
+#include "nautilus-zfs-bar.h"
+#include "nautilus-window.h"
+#include "nautilus-window-private.h"
+#include "nautilus-file-utilities.h"
+#include "timescale.h"
+#include <libnautilus-private/nautilus-zfs.h>
+#include <libnautilus-private/nautilus-global-preferences.h>
+#include "nautilus-window-slot.h"
+#include "nautilus-navigation-window.h"
+#include <libgnomeui/gnome-uidefs.h>
+#include <libgnomeui/gnome-stock-icons.h>
+
+#define NAUTILUS_ZFS_BAR_GET_PRIVATE(o) (G_TYPE_INSTANCE_GET_PRIVATE ((o), NAUTILUS_TYPE_ZFS_BAR, NautilusZfsBarPrivate))
+
+struct NautilusZfsBarPrivate
+{
+       NautilusDirectory *dir;
+       GtkWidget	 *last_snap_name_label;
+       GtkWidget	 *num_rev_label;
+       GtkWidget	 *scale;
+       GtkWidget	 *delete_button;
+       GdkColor		  in_snapshot;
+       GtkToggleAction	 *action;
+       NautilusWindowSlot *slot;
+       int		  num_range_items;
+       gboolean		  is_setup;
+       gboolean		  set_only;
+       char		 *current_path;
+       ZfsSnapDirMonitor *zfs_dir_monitor_data;
+       gboolean		  in_snapshot_dir;
+       GtkWidget	 *camera_image;
+       GtkWidget	 *delete_image;
+       gboolean		  explicit_user_hide;
+};
+
+G_DEFINE_TYPE (NautilusZfsBar, nautilus_zfs_bar, GTK_TYPE_EVENT_BOX)
+
+static void
+close_clicked_callback (GtkWidget *widget,
+                        NautilusZfsBar *bar);
+static void 
+slider_moved_callback (GtkScale *scale,
+		       NautilusZfsBar *bar);
+/* From gimp */
+static void
+label_set_attributes (GtkLabel *label,
+                           ...)
+{
+  PangoAttribute *attr  = NULL;
+  PangoAttrList  *attrs;
+  va_list         args;
+
+  g_return_if_fail (GTK_IS_LABEL (label));
+
+  attrs = pango_attr_list_new ();
+
+  va_start (args, label);
+
+  do
+    {
+      PangoAttrType   attr_type = va_arg (args, PangoAttrType);
+
+      switch (attr_type)
+        {
+        case PANGO_ATTR_LANGUAGE:
+          attr = pango_attr_language_new (va_arg (args, PangoLanguage *));
+          break;
+
+        case PANGO_ATTR_FAMILY:
+          attr = pango_attr_family_new (va_arg (args, const gchar *));
+          break;
+
+        case PANGO_ATTR_STYLE:
+          attr = pango_attr_style_new (va_arg (args, PangoStyle));
+          break;
+
+        case PANGO_ATTR_WEIGHT:
+          attr = pango_attr_weight_new (va_arg (args, PangoWeight));
+          break;
+
+        case PANGO_ATTR_VARIANT:
+          attr = pango_attr_variant_new (va_arg (args, PangoVariant));
+          break;
+
+        case PANGO_ATTR_STRETCH:
+          attr = pango_attr_stretch_new (va_arg (args, PangoStretch));
+          break;
+
+        case PANGO_ATTR_SIZE:
+          attr = pango_attr_size_new (va_arg (args, gint));
+          break;
+
+        case PANGO_ATTR_FONT_DESC:
+          attr = pango_attr_font_desc_new (va_arg (args,
+                                                   const PangoFontDescription *));
+          break;
+
+        case PANGO_ATTR_FOREGROUND:
+          {
+            const PangoColor *color = va_arg (args, const PangoColor *);
+
+            attr = pango_attr_foreground_new (color->red,
+                                              color->green,
+                                              color->blue);
+          }
+          break;
+
+        case PANGO_ATTR_BACKGROUND:
+          {
+            const PangoColor *color = va_arg (args, const PangoColor *);
+
+            attr = pango_attr_background_new (color->red,
+                                              color->green,
+                                              color->blue);
+          }
+          break;
+
+        case PANGO_ATTR_UNDERLINE:
+          attr = pango_attr_underline_new (va_arg (args, PangoUnderline));
+          break;
+
+        case PANGO_ATTR_STRIKETHROUGH:
+          attr = pango_attr_strikethrough_new (va_arg (args, gboolean));
+          break;
+
+        case PANGO_ATTR_RISE:
+          attr = pango_attr_rise_new (va_arg (args, gint));
+          break;
+
+        case PANGO_ATTR_SCALE:
+          attr = pango_attr_scale_new (va_arg (args, gdouble));
+          break;
+
+        default:
+          g_warning ("%s: invalid PangoAttribute type %d",
+                     G_STRFUNC, attr_type);
+        case -1:
+        case PANGO_ATTR_INVALID:
+          attr = NULL;
+          break;
+        }
+
+      if (attr)
+        {
+          attr->start_index = 0;
+          attr->end_index   = -1;
+          pango_attr_list_insert (attrs, attr);
+        }
+    }
+  while (attr);
+
+  va_end (args);
+
+  gtk_label_set_attributes (label, attrs);
+  pango_attr_list_unref (attrs);
+}
+static void
+nautilus_zfs_bar_class_init (NautilusZfsBarClass *klass)
+{
+	GObjectClass *object_class;
+
+	object_class = G_OBJECT_CLASS (klass);
+
+	g_type_class_add_private (klass, sizeof (NautilusZfsBarPrivate));
+}
+
+static void 
+set_scale_range (NautilusZfsBar *bar, gboolean set_initial_position)
+{
+  int i;
+  GList *tmp;
+  char  *num_rev;
+
+  if (bar->priv->dir)
+    {
+      GList *tmp;
+      float total = 0;
+      /* SUN_BRANDING */
+      char  *unit = _("KB");
+
+      i = nautilus_directory_get_num_snapshots (bar->priv->dir);   
+
+      if (i==0)
+	return;
+
+      tmp = nautilus_directory_get_snapshots (bar->priv->dir);
+      for (tmp; tmp; tmp = tmp->next)
+	{
+	  total += ((ZfsDataSet *) tmp->data)->used_space;
+	}
+
+      if (total > 1024 * 1024) /* 1G */
+	{
+	  total = total / (1024 * 1024);
+	  /* SUN_BRANDING */
+	  unit = _("GB");
+	}
+      if (total > 1024) /* 1M */
+	{
+	  total = total / 1024;
+	  /* SUN_BRANDING */
+	  unit = _("MB");
+	}
+
+     
+      /* SUN_BRANDING */
+      num_rev = g_strdup_printf (_("%d %s: %.1f %s"), 
+				 i, 
+				 /* SUN_BRANDING */
+				 ngettext ("snapshot", "snapshots", i),
+				 total, 
+				 unit);
+
+      gtk_label_set_text (GTK_LABEL (bar->priv->num_rev_label), num_rev);
+
+      g_free (num_rev);
+
+      bar->priv->num_range_items = i;
+
+      gtk_range_set_range (GTK_RANGE (bar->priv->scale), 0, bar->priv->num_range_items);
+      if (set_initial_position)
+	gtk_range_set_value (GTK_RANGE (bar->priv->scale), bar->priv->num_range_items);
+
+      tmp = nautilus_directory_get_snapshots (bar->priv->dir);
+
+      gtk_label_set_text (GTK_LABEL (bar->priv->last_snap_name_label), ((ZfsDataSet*) tmp->data)->mtime_str); 
+    }
+
+}
+
+static gchar *
+format_value_callback (GtkScale *scale,
+		       gdouble   value,
+		       NautilusZfsBar *bar)
+{
+  GList *tmp;
+  ZfsDataSet *snap;
+
+  if (bar->priv->dir )
+    {  
+      if (value != bar->priv->num_range_items)
+	{
+	  char *txt;
+
+	  tmp = nautilus_directory_get_snapshots (bar->priv->dir);
+
+	  if (!tmp) /* SUN_BRANDING */
+	    return g_strdup (_("updating"));
+
+	  snap = g_list_nth_data (tmp, (int) value);
+
+	  /* SUN_BRANDING */
+	  txt = g_strdup_printf (_("Details : snapshot taken %s currently using %s"), 
+					       snap->mtime_str, 
+					       snap->used_space_str);
+
+	  g_free (txt);
+
+	  return g_strdup_printf ("%s\n%s", snap->mtime_str, snap->used_space_str); 
+	}
+      else
+	{
+	  /* SUN_BRANDING */
+	  return g_strdup (_("Now"));
+	}
+    }
+
+  /* SUN_BRANDING */
+  return g_strdup (_("No initialized"));
+}
+
+
+
+static void 
+update_range (NautilusZfsBar *bar)
+{
+  if (nautilus_directory_get_snapshots (bar->priv->dir))
+    {
+      set_scale_range (bar, FALSE);
+      slider_moved_callback (GTK_SCALE (bar->priv->scale), bar);
+    }
+  else
+    close_clicked_callback (NULL, bar);
+}
+
+static int match_func (ZfsDataSet *set, char *dir)
+{
+  return strcmp (set->mountpoint, dir);
+}
+
+void 
+nautilus_zfs_bar_remove_and_skip_snap (NautilusZfsBar *bar, char *path)
+{
+  GList* match = NULL;
+  GList* snap_list = NULL;
+  ZfsDataSet *snap;
+
+  snap_list = nautilus_directory_get_snapshots (bar->priv->dir);
+  match = g_list_find_custom (snap_list, path, (GCompareFunc)match_func);
+
+  if (match)
+    {
+      snap = (ZfsDataSet*) match->data;
+      nautilus_directory_remove_snapshot (bar->priv->dir, snap);
+      update_range (bar);
+    }
+}
+
+
+static void 
+slider_moved_callback (GtkScale *scale,
+		       NautilusZfsBar *bar)
+{
+  GList *tmp;
+  ZfsDataSet *snap;
+  GFile *snap_file;
+  GdkColor *color;
+  static gboolean initial_call = TRUE;
+  int pos = gtk_range_get_value (GTK_RANGE (scale));
+
+  if (pos < bar->priv->num_range_items)
+    {
+      tmp = nautilus_directory_get_snapshots (bar->priv->dir);
+
+      snap = g_list_nth_data (tmp, pos);
+
+      snap_file = g_file_new_for_path (snap->mountpoint);
+
+      color = &bar->priv->in_snapshot;
+
+    }
+  else
+    {
+      color =& (gtk_widget_get_style (gtk_widget_get_parent (GTK_WIDGET (bar)))->bg[GTK_STATE_NORMAL]);
+      snap_file = nautilus_directory_get_location (bar->priv->dir);
+      pos = bar->priv->num_range_items;
+    }
+
+  if (!initial_call)
+    {
+      gtk_widget_modify_bg (GTK_WIDGET (bar), GTK_STATE_NORMAL, color);
+
+      if (!bar->priv->set_only)
+	{
+	  gboolean in_snap = FALSE;
+	  char *path = g_file_get_path (snap_file);
+
+	  if (g_file_test (path, G_FILE_TEST_IS_DIR))
+	    {
+	      nautilus_window_slot_go_to (bar->priv->slot,
+					  snap_file,
+					  FALSE);
+	      if (bar->priv->current_path)
+		g_free (bar->priv->current_path);
+	      bar->priv->current_path = path;
+	    }
+	  else
+	    { /* the snapshot diappeared try the next one */
+	      g_free (path);
+	      g_object_unref (snap_file);
+	      /* remove snap from list */
+	      nautilus_directory_remove_snapshot (bar->priv->dir, snap);
+	      update_range (bar);
+	      return;
+	    }
+
+	  in_snap = ts_is_in_snapshot (path);
+
+	  if (in_snap)
+	    {
+	      if (!bar->priv->in_snapshot_dir)
+		{ /*in main dir to snap */
+		  bar->priv->in_snapshot_dir = TRUE;
+		  g_object_ref (bar->priv->camera_image);
+		  gtk_button_set_image (GTK_BUTTON (bar->priv->delete_button),
+					bar->priv->delete_image);
+		  gtk_widget_set_tooltip_text (bar->priv->delete_button,
+					       /* SUN_BRANDING */
+					       _("Delete this snapshot"));
+		}
+	    }
+	  else
+	    {
+	      if (bar->priv->in_snapshot_dir)
+		{ /* in snap to main dir */
+		  bar->priv->in_snapshot_dir = FALSE;
+		  g_object_ref (bar->priv->delete_image);
+		  gtk_button_set_image (GTK_BUTTON (bar->priv->delete_button),
+					bar->priv->camera_image);
+		  gtk_widget_set_tooltip_text (bar->priv->delete_button,
+					       /* SUN_BRANDING */
+					       _("Take a zfs snapshot of this directory now"));
+		}
+	    }
+	}
+    }
+  else
+    initial_call = FALSE;
+
+  g_object_unref (snap_file);
+
+}
+
+
+static void
+delete_clicked_callback (GtkWidget *widget,
+			 NautilusZfsBar *bar)
+{
+  GList *tmp;
+  ZfsDataSet *snap;
+  GFile *snap_file;
+  char *path;
+  char *full_command;
+  int pos = gtk_range_get_value (GTK_RANGE (bar->priv->scale));
+
+  if (bar->priv->in_snapshot_dir)
+    {
+      tmp = nautilus_directory_get_snapshots (bar->priv->dir);
+      snap = g_list_nth_data (tmp, pos);
+      snap_file = g_file_new_for_path (snap->mountpoint);
+      path = g_file_get_path (snap_file);
+
+      g_object_unref (snap_file);
+      /* printf ("path %s snapshot to delete %s\n", path, snap->name); */
+      full_command = g_strdup_printf ("/usr/lib/time-slider-delete '%s'", snap->name);
+      gdk_spawn_command_line_on_screen (gtk_widget_get_screen (widget),
+					full_command, NULL);
+      g_free (full_command);
+    }
+  else
+    {
+      path = g_file_get_path (nautilus_directory_get_location (bar->priv->dir));
+      char *fs = ts_get_zfs_filesystem (path);
+      /* printf ("take a snapshot of zfs fs %s for dir %s\n", fs, path); */
+      full_command = g_strdup_printf ("/usr/lib/time-slider-snapshot '%s' '%s'", path, fs);
+      gdk_spawn_command_line_on_screen (gtk_widget_get_screen (widget),
+					full_command, NULL);
+      g_free (fs);
+    }
+
+    g_free (full_command);
+    g_free (path);
+}
+
+static void
+close_clicked_callback (GtkWidget *widget,
+                        NautilusZfsBar *bar)
+{
+  GFile *snap_file = nautilus_directory_get_location (bar->priv->dir);
+
+  nautilus_window_slot_go_to (bar->priv->slot,
+			      snap_file,
+			      FALSE);
+  g_object_unref (snap_file);
+
+  bar->priv->is_setup = FALSE;
+
+  gtk_widget_hide (GTK_WIDGET (bar));
+  gtk_toggle_action_set_active (bar->priv->action, FALSE);
+
+}
+
+static void
+nautilus_zfs_bar_init (NautilusZfsBar *bar)
+{
+  GtkWidget *label;
+  GtkWidget *hbox, *vbox, *inner_frame, *slider_hbox, 
+	    *toolbar, *close, *delete, *image, *button_vbox;
+  GtkToolItem *item;
+  char *path;
+
+  bar->priv = NAUTILUS_ZFS_BAR_GET_PRIVATE (bar);
+
+  bar->priv->dir = NULL;
+  bar->priv->num_range_items = 0;
+  bar->priv->action = NULL;
+  bar->priv->slot = NULL;
+  bar->priv->is_setup = FALSE;
+  bar->priv->set_only = FALSE;
+  gdk_color_parse ("#a7c6e1", &bar->priv->in_snapshot);
+
+
+  /* GUI init */
+
+  toolbar = gtk_toolbar_new ();
+  gtk_widget_show (toolbar);
+
+  item = gtk_tool_item_new ();
+  gtk_container_set_border_width (GTK_CONTAINER (item), GNOME_PAD_SMALL);
+  gtk_widget_show (GTK_WIDGET (item));
+  gtk_tool_item_set_expand (item, TRUE);
+
+  hbox = gtk_hbox_new (FALSE, 2);
+  gtk_widget_show (GTK_WIDGET (hbox));
+
+  vbox = gtk_vbox_new (FALSE, 2);
+  gtk_widget_show (GTK_WIDGET (vbox));
+
+  gtk_container_add (GTK_CONTAINER (vbox),hbox);
+  gtk_container_add (GTK_CONTAINER (item),vbox);
+
+  gtk_toolbar_insert (GTK_TOOLBAR (toolbar), item, -1);
+  gtk_container_add (GTK_CONTAINER (bar),toolbar);
+  gtk_container_set_border_width (GTK_CONTAINER (bar), 0);
+
+  inner_frame = gtk_vbox_new (FALSE, 0);
+  gtk_box_pack_start (GTK_BOX (hbox),
+		      inner_frame, TRUE, TRUE, 2);
+  gtk_widget_show (inner_frame);
+
+  slider_hbox = gtk_hbox_new (FALSE, 6);
+  gtk_box_pack_start (GTK_BOX (inner_frame), slider_hbox, FALSE, FALSE, 0);
+  gtk_widget_show (slider_hbox);
+
+  /* SUN_BRANDING */
+  bar->priv->last_snap_name_label = gtk_label_new (_("Oldest"));
+  gtk_widget_set_state ( bar->priv->last_snap_name_label, GTK_STATE_INSENSITIVE);
+  label_set_attributes (GTK_LABEL (bar->priv->last_snap_name_label),
+			PANGO_ATTR_STYLE, PANGO_STYLE_ITALIC,
+			-1);
+  gtk_box_pack_start (GTK_BOX (slider_hbox), bar->priv->last_snap_name_label, FALSE, FALSE, 0);
+  gtk_widget_show (bar->priv->last_snap_name_label);
+
+  bar->priv->num_rev_label = gtk_label_new ("Num Rev");
+  gtk_widget_set_state ( bar->priv->num_rev_label, GTK_STATE_INSENSITIVE);
+  label_set_attributes (GTK_LABEL (bar->priv->num_rev_label),
+			PANGO_ATTR_STYLE, PANGO_STYLE_ITALIC,
+			-1);
+  gtk_label_set_ellipsize (GTK_LABEL (bar->priv->num_rev_label), PANGO_ELLIPSIZE_END);
+  gtk_box_pack_start (GTK_BOX (slider_hbox), bar->priv->num_rev_label, TRUE, TRUE, 0);
+  gtk_widget_show (bar->priv->num_rev_label);
+
+  /* SUN_BRANDING */
+  label = gtk_label_new (_("Now"));
+  gtk_widget_set_state ( label, GTK_STATE_INSENSITIVE);
+  label_set_attributes (GTK_LABEL (label),
+			PANGO_ATTR_STYLE, PANGO_STYLE_ITALIC,
+			-1);
+  gtk_box_pack_start (GTK_BOX (slider_hbox), label, FALSE, FALSE, 0);
+  gtk_widget_show (label);
+
+  /* buttons */
+
+  button_vbox = gtk_vbox_new (FALSE, 0);
+  gtk_widget_show (button_vbox);
+
+  close = gtk_button_new ();
+  gtk_button_set_relief (GTK_BUTTON (close), GTK_RELIEF_NONE);
+  gtk_widget_set_tooltip_text (close,
+			       /* SUN_BRANDING */
+			       _("Close Time Slider and return to original directory"));
+  gtk_widget_show (close);
+
+  g_signal_connect (close,
+		    "clicked",
+		    G_CALLBACK (close_clicked_callback),
+		    bar);
+
+  image = gtk_image_new_from_stock (GTK_STOCK_CLOSE,
+				    GTK_ICON_SIZE_MENU);
+  gtk_widget_show (image);
+  
+  gtk_container_add (GTK_CONTAINER (close), image);
+  
+  gtk_box_pack_start (GTK_BOX (button_vbox), close, FALSE, FALSE, 0);
+
+  delete = gtk_button_new ();
+  gtk_button_set_relief (GTK_BUTTON (delete), GTK_RELIEF_NONE);
+  gtk_widget_set_tooltip_text (delete,
+			       /* SUN_BRANDING */
+			       _("Take a zfs snapshot of this directory now"));
+  gtk_widget_show (delete);
+
+  g_signal_connect (delete,
+		    "clicked",
+		    G_CALLBACK (delete_clicked_callback),
+		    bar);
+
+  bar->priv->delete_image = gtk_image_new_from_stock (GTK_STOCK_DELETE,
+						      GTK_ICON_SIZE_MENU);
+
+  path = nautilus_pixmap_file ("camera.png");
+  bar->priv->camera_image = gtk_image_new_from_file (path);
+  g_free (path);
+
+  gtk_widget_show (bar->priv->delete_image);
+  gtk_widget_show (bar->priv->camera_image);
+  
+  gtk_container_add (GTK_CONTAINER (delete), bar->priv->camera_image);
+  
+  gtk_box_pack_end (GTK_BOX (button_vbox), delete, FALSE, FALSE, 0);
+  gtk_box_pack_end (GTK_BOX (hbox), button_vbox, FALSE, FALSE, 0);
+
+  bar->priv->delete_button = delete;
+  
+  bar->priv->scale = gtk_timescale_new_with_range (0,1,1);
+  gtk_range_set_value (GTK_RANGE (bar->priv->scale), 1);
+  gtk_range_set_update_policy (GTK_RANGE (bar->priv->scale), GTK_UPDATE_DISCONTINUOUS);
+  gtk_scale_set_value_pos (GTK_SCALE (bar->priv->scale), GTK_POS_BOTTOM);
+
+  g_signal_connect (bar->priv->scale,
+		    "format-value",
+		    G_CALLBACK (format_value_callback),
+		    bar);
+
+
+  g_signal_connect (bar->priv->scale,
+		    "value-changed",
+		    G_CALLBACK (slider_moved_callback),
+		    bar);
+
+  gtk_widget_show (bar->priv->scale);
+
+  gtk_box_pack_start (GTK_BOX (inner_frame), bar->priv->scale, TRUE, TRUE, 0);
+  
+}
+
+NautilusDirectory * 
+nautilus_zfs_bar_get_dir (NautilusZfsBar* bar)
+{
+  g_return_val_if_fail (NAUTILUS_IS_ZFS_BAR (bar), NULL);
+  return bar->priv->dir;
+}
+
+static void snapshot_data_ready (NautilusDirectory *dir, 
+				 GCancellable      *cancellable,
+				 gpointer callback_data)
+{
+  NautilusWindowSlot *slot;
+  GFile *location;
+  GFile *dir_location;
+  NautilusWindow *window = (NautilusWindow*)callback_data;
+
+  g_return_if_fail (NAUTILUS_IS_WINDOW (window));
+
+  slot = nautilus_window_get_active_slot (window);
+  location = nautilus_window_slot_get_location (slot);
+  dir_location = nautilus_directory_get_location (dir);
+
+  if (g_cancellable_is_cancelled (cancellable) && g_file_equal (location, dir_location))
+    {
+      nautilus_navigation_window_set_throbber_active (NAUTILUS_NAVIGATION_WINDOW (window), FALSE);
+      nautilus_navigation_window_set_restore_icon ( NAUTILUS_NAVIGATION_WINDOW (window), RESTORE_NO);
+    }
+  else if (g_file_equal (location, dir_location))
+    {
+      char *path = g_file_get_path (dir_location);
+      g_cancellable_cancel (cancellable);
+      nautilus_window_slot_set_allow_stop (slot, FALSE);
+      nautilus_navigation_window_set_restore_icon ( NAUTILUS_NAVIGATION_WINDOW (window), 
+						    nautilus_directory_has_snapshots (dir) ? RESTORE_NORMAL : RESTORE_NO);
+      if (nautilus_directory_has_snapshots (dir))
+	nautilus_window_allow_restore (window, TRUE);
+      else
+	nautilus_window_allow_restore (window, FALSE);
+      g_free (path);
+    }
+  g_object_unref (location);
+  g_object_unref (dir_location);
+}
+
+
+void nautilus_zfs_bar_cancel_tasks (NautilusWindow *window)
+{
+  if (NAUTILUS_IS_WINDOW (window))
+    {
+      if (NAUTILUS_IS_WINDOW_SLOT (window->details->active_slot))
+	{
+	  NautilusDirectory *directory = NULL;
+	  g_cancellable_cancel (window->details->active_slot->find_zfs_snapshots_cancellable);
+	  g_object_unref (window->details->active_slot->find_zfs_snapshots_cancellable);
+	  window->details->active_slot->find_zfs_snapshots_cancellable = NULL;
+	  directory = nautilus_directory_get (window->details->active_slot->location);
+	  if (directory)
+	    {
+	      nautilus_directory_cancel_restore_info (directory);
+	      nautilus_directory_unref (directory);
+	    }
+	}
+      if (NAUTILUS_IS_NAVIGATION_WINDOW (window))
+	{
+	  NautilusZfsBar *bar = NAUTILUS_ZFS_BAR (NAUTILUS_NAVIGATION_WINDOW (window)->zfs_bar);
+	  monitor_zfs_snap_directory_cancel (bar->priv->zfs_dir_monitor_data);
+	  bar->priv->zfs_dir_monitor_data = NULL;
+	}
+    }
+}
+
+void nautilus_zfs_bar_hide (NautilusZfsBar *bar)
+{
+  bar->priv->explicit_user_hide = TRUE;
+  close_clicked_callback (NULL, bar);
+}
+
+
+/* Display AND Scan */
+
+void		 
+nautilus_zfs_bar_display (NautilusZfsBar *bar,
+			  NautilusWindow *window,
+			  NautilusDirectory *new_dir,
+			  GCancellable *cancellable)
+{
+  gboolean show = FALSE;
+  gboolean time_slider_enabled = eel_preferences_get_boolean (NAUTILUS_PREFERENCES_ENABLE_TIME_SLIDER);
+  gboolean visible = GTK_WIDGET_VISIBLE (GTK_WIDGET (bar));
+  gboolean enable_button = FALSE;
+  gboolean do_scan = FALSE;
+  gboolean do_cancel = FALSE;
+
+
+  /* if bar visible
+   *	if feature disabled
+   *	  close bar
+   *	  disable button
+   *	if in root dir
+   *	  enable button
+   * else
+   *	if bar was previously displayed and in same tab
+   *	   if in snapshot
+   *	     redisplay 
+   *	     re-align
+   *	     disable button
+   *	   if root dir 
+   *	     redisplay 
+   *	     re-align
+   *	     enable button
+   *	   else
+   *	      scan
+   *	else
+   *	  if feature enabled 
+   *	    scan
+   *	    disable button
+   *
+   *
+   *  NOTE : action_restore_callback display bar when enabled
+   */
+
+  if (visible)
+    {
+      if (!time_slider_enabled)
+	{
+	  close_clicked_callback (NULL, bar);
+	  return;
+	}
+      if (new_dir == bar->priv->dir)
+	enable_button = TRUE;
+      if (nautilus_directory_is_a_snapshot_dir_of (new_dir, bar->priv->dir) || new_dir == bar->priv->dir)
+	{
+	  show = TRUE;
+	  do_cancel = TRUE;
+	  enable_button = TRUE;
+	}
+      else
+	do_scan = TRUE;
+    }
+  else
+    { /* bar is not visible */
+      NautilusWindowSlot *slot = nautilus_window_get_active_slot (window);
+
+      if (bar->priv->is_setup && slot == bar->priv->slot && time_slider_enabled) /* check if we can redisplay the bar */
+	{
+	  if (nautilus_directory_is_a_snapshot_dir_of (new_dir, bar->priv->dir) && !bar->priv->explicit_user_hide)
+	    show = TRUE;
+
+	  if (bar->priv->explicit_user_hide)
+	    enable_button = FALSE;
+
+	  if (new_dir == bar->priv->dir)
+	    {
+	      show = TRUE;
+	      enable_button = TRUE;
+	    }
+	  else
+	    do_scan = TRUE;
+	}
+      else
+	{ /* icon and throbber set is snapshot_data_ready */
+	  if (time_slider_enabled)
+	    do_scan = TRUE;
+	}
+
+    }
+
+  if (enable_button) /* if button enabled set the icon to normal */
+    nautilus_navigation_window_set_restore_icon (NAUTILUS_NAVIGATION_WINDOW (window), RESTORE_NORMAL);
+
+  nautilus_window_allow_restore (window, enable_button); 
+
+
+  if (show)
+    {
+      gtk_widget_show (GTK_WIDGET (bar));
+      nautilus_zfs_set_snap (bar, new_dir);
+    }
+  else
+    {
+      gtk_widget_hide (GTK_WIDGET (bar));
+      if (bar->priv->action)
+	gtk_toggle_action_set_active (bar->priv->action, FALSE);
+    }
+
+  if (do_cancel)
+    g_cancellable_cancel (cancellable);
+
+  if (do_scan)
+    {
+      g_cancellable_reset (cancellable);
+      nautilus_navigation_window_set_restore_icon (NAUTILUS_NAVIGATION_WINDOW (window), RESTORE_SEARCH);
+      nautilus_window_slot_set_allow_stop (nautilus_window_get_active_slot (window), TRUE);
+      nautilus_directory_get_snapshots_async (new_dir,
+					      snapshot_data_ready, 
+					      cancellable, 
+					      window);
+    }
+
+   /* {
+      GFile *file = nautilus_directory_get_location (new_dir);
+      char *path = g_file_get_path (file);
+
+      printf ("nautilus_zfs_bar_display %s\nenable_button : %s, show : %s, do_cancel : %s, do_scan : %s\n\n",
+	      path,
+	      enable_button ? "true" : "false",
+	      show ? "true" : "false",
+	      do_cancel ? "true" : "false",
+	      do_scan ? "true" : "false");
+      g_free (path);
+    }*/
+
+}
+
+
+void nautilus_zfs_set_snap (NautilusZfsBar *bar,
+			    NautilusDirectory *dir)
+{
+  GList* match = NULL;
+  GList* snap_list = NULL;
+  char real_path [PATH_MAX+1];
+  GFile *file;
+  char* path;
+  int pos;
+  int set_pos = -2;
+
+  if (!bar->priv->is_setup)
+    return;
+
+  file = nautilus_directory_get_location (dir);
+  path = g_file_get_path (file);
+  realpath (path, real_path);
+
+  if (ts_is_in_snapshot (real_path))
+    {
+      snap_list = nautilus_directory_get_snapshots (bar->priv->dir);
+      match = g_list_find_custom (snap_list, real_path, (GCompareFunc)match_func);
+    }
+  g_free (path);
+  g_object_unref (file);
+
+  if (!match)  
+    pos = bar->priv->num_range_items; /* "now" special case */
+  else
+    pos = g_list_position (snap_list, match);
+  
+  set_pos = gtk_range_get_value (GTK_RANGE (bar->priv->scale));
+
+  /* if (pos != set_pos) */
+  if (bar->priv->current_path && (strcmp (bar->priv->current_path, real_path) != 0))
+    {
+      bar->priv->set_only = TRUE;
+      gtk_range_set_value (GTK_RANGE (bar->priv->scale), pos);
+      bar->priv->set_only = FALSE;
+
+    }
+}
+
+static void snapshot_data_ready_from_change (NautilusDirectory *dir, 
+					     GCancellable      *cancellable,
+					     gpointer callback_data)
+{
+  NautilusZfsBar *bar = NAUTILUS_ZFS_BAR (callback_data);
+
+  snapshot_data_ready (dir, cancellable, bar->priv->slot->window);
+  update_range (bar);
+  gtk_widget_set_sensitive (bar->priv->scale, TRUE);
+}
+
+
+static void zfs_dir_change_callback (ZfsSnapDirMonitor *monitor_data,
+				     NautilusZfsBar *bar)
+{
+  gtk_widget_set_sensitive (bar->priv->scale, FALSE);
+
+  g_cancellable_reset (bar->priv->slot->find_zfs_snapshots_cancellable);
+  nautilus_navigation_window_set_restore_icon (NAUTILUS_NAVIGATION_WINDOW (bar->priv->slot->window), RESTORE_SEARCH);
+  nautilus_window_slot_set_allow_stop (bar->priv->slot, TRUE);
+  nautilus_directory_get_snapshots_async (bar->priv->dir,
+					  snapshot_data_ready_from_change, 
+					  bar->priv->slot->find_zfs_snapshots_cancellable,
+					  bar);
+}
+
+void		
+nautilus_zfs_bar_setup (NautilusZfsBar* bar,
+			NautilusDirectory *dir,	
+			NautilusWindowSlot *active_slot,
+			GtkToggleAction* action)
+{
+  GFile *file;
+  char *path, *zfs_dir;
+  bar->priv->dir = dir;
+  g_object_ref (dir);
+  bar->priv->slot = active_slot;
+  g_object_ref (active_slot);
+
+  bar->priv->action = action;
+  set_scale_range (bar, TRUE);  
+  bar->priv->is_setup = TRUE;
+  bar->priv->explicit_user_hide = FALSE;
+
+  file = nautilus_directory_get_location (dir);
+  path = g_file_get_path (file);
+  zfs_dir = ts_get_snapshot_dir (path);
+  bar->priv->zfs_dir_monitor_data = monitor_zfs_snap_directory (zfs_dir, (ZfsDirChangeCallback) zfs_dir_change_callback, bar);
+  g_free (path);
+  g_free (zfs_dir);
+  g_object_unref (file);
+}
+
+static void 
+zfs_bar_show_column (GtkWidget *widget, gpointer user_data)
+{
+  char **visible_columns;
+  gboolean restore_col_visible = FALSE;
+  int i = 0;
+  GPtrArray *ret = NULL;
+
+  visible_columns = eel_preferences_get_string_array (NAUTILUS_PREFERENCES_LIST_VIEW_DEFAULT_VISIBLE_COLUMNS);
+
+  ret = g_ptr_array_new ();
+
+  /* convert visible_columns in ptr array without "restore_info" */
+  while (visible_columns[i])
+    {
+      if (strcmp (visible_columns [i], "restore_info") == 0)
+	{
+	  restore_col_visible = TRUE;
+	  break;
+	}
+      else
+	g_ptr_array_add (ret, g_strdup (visible_columns [i]));
+      i++;
+    }
+
+  g_strfreev (visible_columns);
+
+  if (restore_col_visible)
+    {
+      if (!GTK_WIDGET_VISIBLE (widget)) /* hide bar remove pref */
+	{
+	  char **col_array;
+	  g_ptr_array_add (ret, NULL);
+	  col_array = (char **)g_ptr_array_free (ret, FALSE);
+	  eel_preferences_set_string_array (NAUTILUS_PREFERENCES_LIST_VIEW_DEFAULT_VISIBLE_COLUMNS, col_array);
+	  g_strfreev (col_array);
+	  ret = NULL;
+	}
+    }
+  else
+    {
+      if (GTK_WIDGET_VISIBLE (widget))
+	{
+	  char **col_array;
+	  g_ptr_array_add (ret,strdup ("restore_info"));
+	  g_ptr_array_add (ret,NULL);
+	  col_array = (char **)g_ptr_array_free (ret, FALSE);
+	  eel_preferences_set_string_array (NAUTILUS_PREFERENCES_LIST_VIEW_DEFAULT_VISIBLE_COLUMNS, col_array);
+	  g_strfreev (col_array);
+	  ret = NULL;
+	}
+      
+    }
+
+  if (ret)
+    g_ptr_array_free (ret, TRUE);
+
+}
+
+static void 
+zfs_bar_hidden (GtkWidget *widget, gpointer user_data)
+{
+  NautilusZfsBar *bar = NAUTILUS_ZFS_BAR (user_data);
+  monitor_zfs_snap_directory_cancel (bar->priv->zfs_dir_monitor_data);
+  bar->priv->zfs_dir_monitor_data = NULL;
+  nautilus_directory_cancel_restore_info (bar->priv->dir);
+}
+
+GtkWidget *
+nautilus_zfs_bar_new ()
+{
+	GObject *bar;
+	NautilusZfsBar *zfs_bar;
+
+	bar = g_object_new (NAUTILUS_TYPE_ZFS_BAR, NULL);
+
+	g_signal_connect_object (bar, "show", G_CALLBACK (zfs_bar_show_column), bar, NULL);
+	g_signal_connect_object (bar, "hide", G_CALLBACK (zfs_bar_show_column), bar, NULL);
+	g_signal_connect_object (bar, "hide", G_CALLBACK (zfs_bar_hidden), bar, NULL);
+
+	zfs_bar_show_column (GTK_WIDGET (bar), NULL); 
+
+	ts_is_restore_column_enabled_init ();
+
+	zfs_bar = NAUTILUS_ZFS_BAR (bar);
+
+	return GTK_WIDGET (bar);
+}
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/nautilus-zfs-bar.h nautilus-2.26.2/src/nautilus-zfs-bar.h
--- ../nautilus-2.26.2/src/nautilus-zfs-bar.h	1970-01-01 01:00:00.000000000 +0100
+++ nautilus-2.26.2/src/nautilus-zfs-bar.h	2009-04-15 16:04:45.714747996 +0200
@@ -0,0 +1,57 @@
+#ifndef __NAUTILUS_ZFS_BAR_H
+#define __NAUTILUS_ZFS_BAR_H
+
+#include <gtk/gtk.h>
+#include <libnautilus-private/nautilus-directory.h>
+#include "nautilus-window-slot.h"
+
+G_BEGIN_DECLS
+
+#define NAUTILUS_TYPE_ZFS_BAR         (nautilus_zfs_bar_get_type ())
+#define NAUTILUS_ZFS_BAR(o)           (G_TYPE_CHECK_INSTANCE_CAST ((o), NAUTILUS_TYPE_ZFS_BAR, NautilusZfsBar))
+#define NAUTILUS_ZFS_BAR_CLASS(k)     (G_TYPE_CHECK_CLASS_CAST((k), NAUTILUS_TYPE_ZFS_BAR, NautilusZfsBarClass))
+#define NAUTILUS_IS_ZFS_BAR(o)        (G_TYPE_CHECK_INSTANCE_TYPE ((o), NAUTILUS_TYPE_ZFS_BAR))
+#define NAUTILUS_IS_ZFS_BAR_CLASS(k)  (G_TYPE_CHECK_CLASS_TYPE ((k), NAUTILUS_TYPE_ZFS_BAR))
+#define NAUTILUS_ZFS_BAR_GET_CLASS(o) (G_TYPE_INSTANCE_GET_CLASS ((o), NAUTILUS_TYPE_ZFS_BAR, NautilusZfsBarClass))
+
+typedef struct NautilusZfsBarPrivate NautilusZfsBarPrivate;
+
+typedef struct
+{
+  GtkEventBox eventbox;
+  NautilusZfsBarPrivate *priv;
+} NautilusZfsBar;
+
+typedef struct
+{
+  GtkEventBoxClass parent_class;
+} NautilusZfsBarClass;
+
+GType		 nautilus_zfs_bar_get_type	(void) G_GNUC_CONST;
+
+GtkWidget	*nautilus_zfs_bar_new		();
+
+void		 nautilus_zfs_bar_setup (NautilusZfsBar* bar,
+					 NautilusDirectory *dir,
+					 NautilusWindowSlot *active_slot,
+					 GtkToggleAction* action);
+
+void		 nautilus_zfs_bar_display (NautilusZfsBar *bar,
+					   NautilusWindow *window,
+					   NautilusDirectory *new_dir,
+					   GCancellable* cancellable);
+
+void		 nautilus_zfs_set_snap	  (NautilusZfsBar *bar,
+					   NautilusDirectory *dir);
+void		 nautilus_zfs_bar_remove_and_skip_snap 
+					  (NautilusZfsBar *bar, char *path);
+
+void		nautilus_zfs_bar_hide (NautilusZfsBar *bar);					  
+
+void		 nautilus_zfs_bar_cancel_tasks (NautilusWindow *window);
+NautilusDirectory * nautilus_zfs_bar_get_dir (NautilusZfsBar* bar);
+G_END_DECLS
+
+
+
+#endif /* __NAUTILUS_ZFS_BAR_H */
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/timescale.c nautilus-2.26.2/src/timescale.c
--- ../nautilus-2.26.2/src/timescale.c	1970-01-01 01:00:00.000000000 +0100
+++ nautilus-2.26.2/src/timescale.c	2009-04-15 16:04:45.715162711 +0200
@@ -0,0 +1,224 @@
+/* 
+ * Copyright (C) 2008 Sun Microsystems (Erwann Chenede)
+ *
+ */
+
+#include "timescale.h"
+#include <math.h>
+#include <stdlib.h>
+
+G_DEFINE_TYPE (GtkTimeScale, gtk_timescale, GTK_TYPE_HSCALE)
+
+static void
+gtk_timescale_init (GtkTimeScale *timescale)
+{
+}
+
+GtkWidget*
+gtk_timescale_new (GtkAdjustment *adjustment)
+{
+  return g_object_new (GTK_TYPE_TIMESCALE, "adjustment", adjustment, NULL);
+}
+
+GtkWidget*
+gtk_timescale_new_with_range (gdouble min,
+                           gdouble max,
+                           gdouble step)
+{
+  GtkObject *adj;
+  GtkScale *scale;
+  gint digits;
+
+  g_return_val_if_fail (min < max, NULL);
+  g_return_val_if_fail (step != 0.0, NULL);
+
+  adj = gtk_adjustment_new (min, min, max, step, 10 * step, 0);
+
+  if (fabs (step) >= 1.0 || step == 0.0)
+    digits = 0;
+  else {
+    digits = abs ((gint) floor (log10 (fabs (step))));
+    if (digits > 5)
+      digits = 5;
+  }
+  
+  scale = g_object_new (GTK_TYPE_TIMESCALE,
+                        "adjustment", adj,
+                        "digits", digits,
+                        NULL);
+
+  return GTK_WIDGET (scale);
+}
+
+typedef enum {
+  MOUSE_OUTSIDE,
+  MOUSE_STEPPER_A,
+  MOUSE_STEPPER_B,
+  MOUSE_STEPPER_C,
+  MOUSE_STEPPER_D,
+  MOUSE_TROUGH,
+  MOUSE_SLIDER,
+  MOUSE_WIDGET /* inside widget but not in any of the above GUI elements */
+} MouseLocation;
+
+struct _GtkRangeLayout
+{
+  /* These are in widget->window coordinates */
+  GdkRectangle stepper_a;
+  GdkRectangle stepper_b;
+  GdkRectangle stepper_c;
+  GdkRectangle stepper_d;
+  /* The trough rectangle is the area the thumb can slide in, not the
+   * entire range_rect
+   */
+  GdkRectangle trough;
+  GdkRectangle slider;
+
+  /* Layout-related state */
+  
+  MouseLocation mouse_location;
+  /* last mouse coords we got, or -1 if mouse is outside the range */
+  gint mouse_x;
+  gint mouse_y;
+
+  /* "grabbed" mouse location, OUTSIDE for no grab */
+  MouseLocation grab_location;
+  guint grab_button : 8; /* 0 if none */
+
+  /* Stepper sensitivity */
+  guint lower_sensitive : 1;
+  guint upper_sensitive : 1;
+
+  /* Fill level */
+  guint show_fill_level : 1;
+  guint restrict_to_fill_level : 1;
+
+  GtkSensitivityType lower_sensitivity;
+  GtkSensitivityType upper_sensitivity;
+  guint repaint_id;
+
+  gdouble fill_level;
+};
+
+int get_tick_for_pos (GtkRange *range, int pos)
+{
+  struct _GtkRangeLayout *toto;
+  /* Compute slider position/length */
+  gint x, left, right, width;
+
+  toto = (struct _GtkRangeLayout*) range->layout;
+
+  left = toto->trough.x;
+  right = toto->trough.x + toto->trough.width;  
+
+  /* slider width is the fraction (page_size /
+   * total_adjustment_range) times the trough width in pixels
+   */
+
+  if (range->adjustment->upper - range->adjustment->lower != 0)
+    width = ((right - left) * (range->adjustment->page_size /
+			       (range->adjustment->upper - range->adjustment->lower)));
+  else
+    width = range->min_slider_size;
+
+  if (width < range->min_slider_size ||
+      range->slider_size_fixed)
+    width = range->min_slider_size;
+
+  width = MIN (width, range->range_rect.width);
+
+  x = left;
+
+  if (range->adjustment->upper - range->adjustment->lower - range->adjustment->page_size != 0)
+    x += (right - left - width) * ((pos - range->adjustment->lower) /
+				   (range->adjustment->upper - range->adjustment->lower - range->adjustment->page_size));
+
+  x = CLAMP (x, left, right);
+
+  return x - 1 + width / 2;
+}
+
+static gboolean
+gtk_timescale_expose (GtkWidget      *widget,
+		      GdkEventExpose *event)
+{
+  GtkScale *scale;
+  GtkStyle *style;
+  GtkRange *range;
+  gint layout_offset_x, layout_offset_y;
+  gint x1, y1, y2;
+  gint gap_between_tick = 0;
+  gint num_tick = 0;
+  PangoLayout *layout;
+  PangoRectangle logical_rect;
+  gint value_spacing;
+
+  scale = GTK_SCALE (widget);
+  range = GTK_RANGE (widget);
+
+  gtk_widget_style_get (widget, "value-spacing", &value_spacing, NULL);
+  layout = gtk_scale_get_layout (scale);
+      
+  pango_layout_set_alignment (layout, PANGO_ALIGN_CENTER);
+  
+  pango_layout_get_pixel_extents (layout, NULL, &logical_rect);
+
+  /* We need to chain up _first_ so the various geometry members of
+   * GtkRange struct are updated.
+   */
+  if (GTK_WIDGET_CLASS (gtk_timescale_parent_class)->expose_event)
+    GTK_WIDGET_CLASS (gtk_timescale_parent_class)->expose_event (widget, event);
+
+
+  style = gtk_widget_get_style (widget);
+
+  gtk_scale_get_layout_offsets (scale, &layout_offset_x, &layout_offset_y);
+
+  num_tick = range->adjustment->upper - range->adjustment->lower;
+
+  num_tick++;
+
+  gap_between_tick = range->range_rect.width  / num_tick;
+
+  if (gap_between_tick > 2)
+    {
+      int i;
+      x1 = get_tick_for_pos (range, 0) + widget->allocation.x;
+      switch (scale->value_pos)
+	{
+	  case GTK_POS_TOP:
+	    y1 = layout_offset_y + logical_rect.height - 3;
+	    y2 = layout_offset_y + logical_rect.height + value_spacing - 1;
+	    break;
+	  case GTK_POS_BOTTOM:
+	    y1 = layout_offset_y - 3;
+	    y2 = layout_offset_y - value_spacing + 3;
+	    break;
+	}
+
+      for (i = 0; i < num_tick + 1; i++)
+	{
+	  gdk_draw_line (widget->window, widget->style->dark_gc[GTK_STATE_NORMAL], x1, y1, x1, y2);
+	  /* gtk_paint_vline (style, widget->window, GTK_STATE_SELECTED, NULL, widget, NULL, y1, y2, x1); */
+	  x1 = get_tick_for_pos (range, i) + widget->allocation.x;
+	}
+    }
+  return FALSE;
+}
+
+static void
+gtk_timescale_class_init (GtkTimeScaleClass *class)
+{
+  GtkWidgetClass *widget_class;
+  GtkRangeClass *range_class;
+  GtkScaleClass *scale_class;
+  
+  widget_class = GTK_WIDGET_CLASS (class);
+  range_class = GTK_RANGE_CLASS (class);
+  scale_class = GTK_SCALE_CLASS (class);
+
+  range_class->slider_detail = "hscale";
+
+  widget_class->expose_event = gtk_timescale_expose;
+}
+
diff -Nrup -x '*.orig' -x '*.rej' -x '*.*~' ../nautilus-2.26.2/src/timescale.h nautilus-2.26.2/src/timescale.h
--- ../nautilus-2.26.2/src/timescale.h	1970-01-01 01:00:00.000000000 +0100
+++ nautilus-2.26.2/src/timescale.h	2009-04-15 16:04:45.715470959 +0200
@@ -0,0 +1,43 @@
+#ifndef __GTK_TIMESCALE_H__
+#define __GTK_TIMESCALE_H__
+
+
+#include <gdk/gdk.h>
+#include <gtk/gtkhscale.h>
+#include <gtk/gtk.h>
+
+
+G_BEGIN_DECLS
+
+#define GTK_TYPE_TIMESCALE            (gtk_timescale_get_type ())
+#define GTK_TIMESCALE(obj)            (G_TYPE_CHECK_INSTANCE_CAST ((obj), GTK_TYPE_TIMESCALE, GtkTimeScale))
+#define GTK_TIMESCALE_CLASS(klass)    (G_TYPE_CHECK_CLASS_CAST ((klass), GTK_TYPE_TIMESCALE, GtkTimeScaleClass))
+#define GTK_IS_TIMESCALE(obj)         (G_TYPE_CHECK_INSTANCE_TYPE ((obj), GTK_TYPE_TIMESCALE))
+#define GTK_IS_TIMESCALE_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), GTK_TYPE_TIMESCALE))
+#define GTK_TIMESCALE_GET_CLASS(obj)  (G_TYPE_INSTANCE_GET_CLASS ((obj), GTK_TYPE_TIMESCALE, GtkTimeScaleClass))
+
+
+typedef struct _GtkTimeScale       GtkTimeScale;
+typedef struct _GtkTimeScaleClass  GtkTimeScaleClass;
+
+struct _GtkTimeScale
+{
+  GtkHScale scale;
+};
+
+struct _GtkTimeScaleClass
+{
+  GtkHScaleClass parent_class;
+};
+
+
+GType      gtk_timescale_get_type       (void) G_GNUC_CONST;
+GtkWidget* gtk_timescale_new            (GtkAdjustment *adjustment);
+GtkWidget* gtk_timescale_new_with_range (gdouble        min,
+                                      gdouble        max,
+                                      gdouble        step);
+
+
+G_END_DECLS
+
+#endif /* __GTK_TIMESCALE_H__ */
